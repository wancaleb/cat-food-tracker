<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªé£²é£Ÿè¿½è¹¤å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .food-selector {
            margin-bottom: 15px;
        }
        
        select, input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .remove-btn {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .remove-btn:hover {
            background: #c0392b;
        }
        
        .selected-food {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .food-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-calories {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .date-calories {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .meal-detail {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .food-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ± è²“å’ªé£²é£Ÿè¿½è¹¤å™¨</h1>
        
        <div id="syncStatus" class="sync-status" style="display: none;"></div>
        
        <div class="card">
            <h2>æ–°å¢é¤é»è¨˜éŒ„</h2>
            <div id="foodSelectors">
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">é¸æ“‡é£Ÿç‰©...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                </div>
            </div>
            <button onclick="addFoodSelector()">+ æ–°å¢é£Ÿç‰©</button>
            <div id="feedingSummary" style="display: none;">
                <div class="total-calories">
                    ç¸½é¤µé£Ÿ: <span id="totalFeedGrams">0</span>g | ç¸½å¡è·¯é‡Œ: <span id="totalCalories">0</span> kcal
                </div>
                <input type="number" id="actualEatenGrams" placeholder="å¯¦éš›åƒäº†å¤šå°‘å…‹" step="0.1" min="0">
                <div id="actualCalories" class="total-calories" style="display: none; background: #e74c3c;">
                    å¯¦éš›æ”å–: <span id="actualCaloriesValue">0</span> kcal
                </div>
            </div>
            <button onclick="saveMeal()" id="saveMealBtn" style="display: none;">å„²å­˜é€™é¤</button>
        </div>
        
        <div class="card">
            <h2>å¡è·¯é‡Œè¶¨å‹¢åœ–</h2>
            <div class="chart-container">
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>é£²é£Ÿè¨˜éŒ„</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // è²“ç³§è³‡æ–™åº«
        const foodDatabase = [
            {name: "catdives è²“çˆ¾åœ°å¤« å…¨é½¡è²“ç‡Ÿé¤Šå‡ç´š é­©ä»”é­š+æ¿è…±ç‰›+é›èƒ¸è‚‰", calories: 100.2},
            {name: "catdives è²“çˆ¾åœ°å¤« å…¨é½¡è²“ç‡Ÿé¤Šå‡ç´š é­©ä»”é­š+é®ªé­š+é›èƒ¸è‚‰", calories: 97.9},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ åš´é¸ç¾Šé›èƒ¸è‚‰", calories: 102.8},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ æ¿è…±ç‰›é›èƒ¸è‚‰", calories: 107.9},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ é›èƒ¸è‚‰", calories: 100.3},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ é®ªé­šé›èƒ¸è‚‰", calories: 97.3},
            {name: "catdives è²“çˆ¾åœ°å¤« é ‚ç´šäº«å— åš´é¸é¹¿", calories: 84.7},
            {name: "catdives è²“çˆ¾åœ°å¤« é ‚ç´šäº«å— è²åŠ›ç‰›", calories: 95.3},
            {name: "Dog Cat Star æ±ªå–µæ˜Ÿçƒ å†·å‡ä¹¾ç‡¥ç”Ÿé£Ÿ-æ«»æ¡ƒé´¨", calories: 480},
            {name: "Dr. Wish é›è‚‰+é®ªé­š+ç‰›ç£ºé…¸", calories: 39},
            {name: "Dr. Wish é®ªé­š+æœå¯¡ç³–", calories: 34},
            {name: "Dr. Wish é®ªé­š+ç¶­ä»–å‘½A", calories: 34},
            {name: "Dr. Wish é®ªé­š+é›è‚‰+ç¶­ä»–å‘½Bç¾¤", calories: 32},
            {name: "K9 Natural ç„¡ç©€ç‰›", calories: 112.3},
            {name: "K9 Natural ç„¡ç©€ç‰›+é±ˆé­š", calories: 94.5},
            {name: "K9 Natural ç„¡ç©€ç¾Š", calories: 121.1},
            {name: "K9 Natural ç„¡ç©€ç¾Š+é®­é­š", calories: 106},
            {name: "K9 Natural ç„¡ç©€é›", calories: 101.3},
            {name: "K9 Natural ç„¡ç©€é›+é¹¿", calories: 86.2},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶ç‡‰é›", calories: 127.5},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶è™±ç›®é­š", calories: 127.5},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶é±¸é­š", calories: 126.5},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-åŸé‡ç‰›è…¿", calories: 124.2},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-ç™½è¦å¹²è²", calories: 103.7},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-è‚¥ç¾é¯–é­š", calories: 114.4},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é‡å‘³ç«é›", calories: 118.1},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é¦™å«©é´¨èƒ¸", calories: 117.3},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é®®é¦™é°¹é­š", calories: 120.6},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ å››ç¨®é­šï½œç™½è‚‰", calories: 123.2},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ å››ç¨®é­šï½œç´…è‚‰", calories: 117.8},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆæµ·é™¸", calories: 117.8},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆè¦è²", calories: 116.3},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆé‡å‘³", calories: 117.8},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ é›è‚‰è“æœ", calories: 115.1},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ æ…¢ç‡‰é®®é­š", calories: 112.1},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ æ¿ƒæ¹¯ç‰›è…¿", calories: 112.1},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ ç™½é†¬å«©é›", calories: 100.1},
            {name: "LitoMON æ€ªç¸éƒ¨è½ 98%é®®è‚‰-é›è‚‰", calories: 415},
            {name: "MAC's é¦¬å…‹ å¹¼è²“-ç«é›è‚‰+å…”è‚‰", calories: 98},
            {name: "MAC's é¦¬å…‹ ç«é›è‚‰+ç«é›å¿ƒ", calories: 89},
            {name: "MAC's é¦¬å…‹ ç¾Šè‚‰", calories: 90},
            {name: "MAC's é¦¬å…‹ ç¾Šè‚‰+ç«é›è‚‰", calories: 98},
            {name: "MAC's é¦¬å…‹ é›è‚‰+é›å¿ƒ", calories: 111},
            {name: "MAC's é¦¬å…‹ é®­é­š+é›è‚‰", calories: 98},
            {name: "MAC's é¦¬å…‹ é´¨è‚‰+ç«é›è‚‰+é›è‚‰", calories: 101},
            {name: "Meow Servant å–µçš‡å¥´ ç´”é›è‚‰", calories: 114},
            {name: "Meow Servant å–µçš‡å¥´ é›è‚‰+ç‰›è‚‰", calories: 120},
            {name: "Meow Servant å–µçš‡å¥´ é®­é­š+é›è‚‰", calories: 121},
            {name: "Meow Servant å–µçš‡å¥´ éµªé¶‰+é›è‚‰", calories: 115},
            {name: "Orijen æ­ç¿å¥ å¹¼è²“é®®é›", calories: 412},
            {name: "ROYAL CANIN çš‡å®¶ K36 å¹¼è²“å°ˆç”¨", calories: 370},
            {name: "ROYAL CANIN çš‡å®¶ LP34 æ³Œå°¿é“é…æ–¹ä¹¾ç³§", calories: 387.2},
            {name: "ROYAL CANIN çš‡å®¶ S33W è…¸èƒƒä¿å¥", calories: 78.8},
            {name: "ROYAL CANIN çš‡å®¶ å¹¼è²“", calories: 80.6},
            {name: "ZIWIPeak å·”å³° é›è‚‰", calories: 550}
        ];

        let foodSelectorCount = 1;
        let currentMeal = [];
        let mealHistory = [];
        let chart = null;

        // åˆå§‹åŒ–
        function init() {
            populateFoodSelect('foodSelect0');
            loadHistoryFromStorage();
            updateChart();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('grams0').addEventListener('input', calculateCalories);
        }

        // å¡«å……é£Ÿç‰©é¸é …
        function populateFoodSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">é¸æ“‡é£Ÿç‰©...</option>';
            
            foodDatabase.forEach((food, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = food.name;
                select.appendChild(option);
            });
            
            select.addEventListener('change', calculateCalories);
        }

        // æ–°å¢é£Ÿç‰©é¸æ“‡å™¨
        function addFoodSelector() {
            const container = document.getElementById('foodSelectors');
            const newSelector = document.createElement('div');
            newSelector.className = 'food-selector';
            newSelector.innerHTML = `
                <select id="foodSelect${foodSelectorCount}">
                    <option value="">é¸æ“‡é£Ÿç‰©...</option>
                </select>
                <input type="number" id="grams${foodSelectorCount}" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                <button type="button" class="remove-btn" onclick="removeFoodSelector(this)">ç§»é™¤</button>
            `;
            
            container.appendChild(newSelector);
            populateFoodSelect(`foodSelect${foodSelectorCount}`);
            
            document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
            
            foodSelectorCount++;
        }

        // ç§»é™¤é£Ÿç‰©é¸æ“‡å™¨
        function removeFoodSelector(button) {
            button.parentElement.remove();
            calculateCalories();
        }

        // è¨ˆç®—å¡è·¯é‡Œ
        function calculateCalories() {
            const selectors = document.querySelectorAll('.food-selector');
            let totalFeedCalories = 0;
            let totalFeedGrams = 0;
            currentMeal = [];

            selectors.forEach((selector, index) => {
                const foodSelect = selector.querySelector('select');
                const gramsInput = selector.querySelector('input[type="number"]');
                
                const foodIndex = foodSelect.value;
                const grams = parseFloat(gramsInput.value) || 0;
                
                if (foodIndex !== '' && grams > 0) {
                    const food = foodDatabase[foodIndex];
                    const calories = (food.calories * grams / 100);  // æ¯100gçš„å¡è·¯é‡Œ
                    totalFeedCalories += calories;
                    totalFeedGrams += grams;
                    
                    currentMeal.push({
                        name: food.name,
                        feedGrams: grams,
                        caloriesPerGram: food.calories / 100
                    });
                }
            });

            const summaryElement = document.getElementById('feedingSummary');
            const saveBtn = document.getElementById('saveMealBtn');
            
            if (totalFeedGrams > 0) {
                document.getElementById('totalFeedGrams').textContent = totalFeedGrams.toFixed(1);
                document.getElementById('totalCalories').textContent = totalFeedCalories.toFixed(1);
                summaryElement.style.display = 'block';
                
                // ç¶å®šå¯¦éš›åƒäº†å¤šå°‘çš„è¨ˆç®—
                const actualEatenInput = document.getElementById('actualEatenGrams');
                actualEatenInput.oninput = function() {
                    calculateActualCalories(totalFeedCalories, totalFeedGrams);
                };
                
                saveBtn.style.display = 'block';
            } else {
                summaryElement.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }

        // è¨ˆç®—å¯¦éš›æ”å–å¡è·¯é‡Œ
        function calculateActualCalories(totalFeedCalories, totalFeedGrams) {
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value) || 0;
            
            if (actualEatenGrams > 0) {
                // æŒ‰æ¯”ä¾‹è¨ˆç®—å¯¦éš›æ”å–çš„å¡è·¯é‡Œ
                const ratio = actualEatenGrams / totalFeedGrams;
                const actualCalories = totalFeedCalories * ratio;
                
                document.getElementById('actualCaloriesValue').textContent = actualCalories.toFixed(1);
                document.getElementById('actualCalories').style.display = 'block';
                
                // æ›´æ–° currentMeal è³‡æ–™
                currentMeal.forEach(food => {
                    food.actualGrams = food.feedGrams * ratio;
                    food.actualCalories = food.caloriesPerGram * food.actualGrams;
                });
                
                return actualCalories;
            } else {
                document.getElementById('actualCalories').style.display = 'none';
                return 0;
            }
        }

        // å„²å­˜é¤é»
        function saveMeal() {
            if (currentMeal.length === 0) return;
            
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value);
            if (!actualEatenGrams || actualEatenGrams <= 0) {
                alert('è«‹è¼¸å…¥å¯¦éš›åƒäº†å¤šå°‘å…‹');
                return;
            }
            
            const totalFeedGrams = currentMeal.reduce((sum, food) => sum + food.feedGrams, 0);
            const totalFeedCalories = currentMeal.reduce((sum, food) => sum + (food.caloriesPerGram * food.feedGrams), 0);
            const actualCalories = calculateActualCalories(totalFeedCalories, totalFeedGrams);
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].slice(0, 5);
            
            const meal = {
                date: dateStr,
                time: timeStr,
                foods: currentMeal.map(food => ({
                    name: food.name,
                    feedGrams: food.feedGrams,
                    actualGrams: food.actualGrams,
                    actualCalories: food.actualCalories
                })),
                totalFeedGrams: totalFeedGrams,
                actualEatenGrams: actualEatenGrams,
                totalFeedCalories: totalFeedCalories,
                actualCalories: actualCalories
            };
            
            mealHistory.unshift(meal);
            saveHistoryToStorage();
            syncToCloud();
            
            // æ¸…ç©ºè¡¨å–®
            resetForm();
            
            // æ›´æ–°é¡¯ç¤º
            displayHistory();
            updateChart();
            
            showSyncStatus('é¤é»å·²è¨˜éŒ„ï¼', 'success');
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            const container = document.getElementById('foodSelectors');
            container.innerHTML = `
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">é¸æ“‡é£Ÿç‰©...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                </div>
            `;
            
            foodSelectorCount = 1;
            populateFoodSelect('foodSelect0');
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            document.getElementById('totalCalories').style.display = 'none';
            document.getElementById('feedingSummary').style.display = 'none';
            document.getElementById('saveMealBtn').style.display = 'none';
            
            currentMeal = [];
        }

        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (mealHistory.length === 0) {
                historyList.innerHTML = '<p>å°šç„¡é£²é£Ÿè¨˜éŒ„</p>';
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedHistory = {};
            mealHistory.forEach(meal => {
                if (!groupedHistory[meal.date]) {
                    groupedHistory[meal.date] = [];
                }
                groupedHistory[meal.date].push(meal);
            });
            
            historyList.innerHTML = '';
            
            Object.keys(groupedHistory).sort().reverse().forEach(date => {
                const dayMeals = groupedHistory[date];
                const dayTotal = dayMeals.reduce((sum, meal) => sum + (meal.actualCalories || meal.totalCalories || 0), 0);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'history-item';
                
                let mealsHtml = '';
                dayMeals.forEach(meal => {
                    const foodsText = meal.foods.map(f => `${f.name} ${f.feedGrams}g`).join(', ');
                    mealsHtml += `
                        <div class="meal-detail">
                            ${meal.time} - å¯¦éš›æ”å–: ${meal.actualCalories.toFixed(1)} kcal (é¤µ${meal.totalFeedGrams.toFixed(1)}gï¼Œåƒ${meal.actualEatenGrams.toFixed(1)}g)<br>
                            <small>${foodsText}</small>
                        </div>
                    `;
                });
                
                dayElement.innerHTML = `
                    <div class="date-calories">${date} - ç¸½è¨ˆ: ${dayTotal.toFixed(1)} kcal</div>
                    ${mealsHtml}
                `;
                
                historyList.appendChild(dayElement);
            });
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            
            // æº–å‚™åœ–è¡¨è³‡æ–™
            const dailyCalories = {};
            mealHistory.forEach(meal => {
                if (!dailyCalories[meal.date]) {
                    dailyCalories[meal.date] = 0;
                }
                dailyCalories[meal.date] += (meal.actualCalories || meal.totalCalories || 0);
            });
            
            const dates = Object.keys(dailyCalories).sort();
            const calories = dates.map(date => dailyCalories[date].toFixed(1));
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'æ¯æ—¥å¡è·¯é‡Œ',
                        data: calories,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å¡è·¯é‡Œ (kcal)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // æœ¬åœ°å„²å­˜
        function saveHistoryToStorage() {
            localStorage.setItem('catFoodHistory', JSON.stringify(mealHistory));
        }

        function loadHistoryFromStorage() {
            const stored = localStorage.getItem('catFoodHistory');
            if (stored) {
                mealHistory = JSON.parse(stored);
                displayHistory();
            }
        }

        // é›²ç«¯åŒæ­¥åŠŸèƒ½ (ç°¡åŒ–ç‰ˆæœ¬ï¼Œå¯¦éš›éœ€è¦å¾Œç«¯æ”¯æŒ)
        function syncToCloud() {
            // é€™è£¡å¯ä»¥æ•´åˆ Firebase æˆ–å…¶ä»–é›²ç«¯æœå‹™
            // æš«æ™‚åªæ˜¯æ¨¡æ“¬
            console.log('åŒæ­¥åˆ°é›²ç«¯:', mealHistory);
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>