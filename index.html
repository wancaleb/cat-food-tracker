<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貓咪飲食追蹤器 v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #f093fb;
            --accent-color: #4ecdc4;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --bg-white: #ffffff;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --border-radius: 12px;
            --border-radius-sm: 8px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 美化的標題區域 */
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        /* 雲端同步封面 */
        .cloud-sync-cover {
            position: relative;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .cloud-sync-cover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .cover-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .cover-content {
            padding: 20px;
            text-align: center;
        }
        
        .cover-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .cover-subtitle {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        /* 美化的卡片 */
        .card {
            background: var(--bg-white);
            border-radius: var(--border-radius);
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
        }
        
        .card h2 {
            color: var(--text-dark);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 美化的表單元素 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        select, input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            transition: all 0.2s ease;
            background: white;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* 美化的按鈕 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            font-family: inherit;
            min-height: 48px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 2px solid #e2e8f0;
        }
        
        .btn-secondary:hover {
            background: #edf2f7;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #dd6b20 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e53e3e 100%);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn-full {
            width: 100%;
        }
        
        /* 美化的食物選擇器 */
        .food-selector {
            background: #f8fafc;
            border: 2px dashed #cbd5e0;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .food-selector:hover {
            border-color: var(--primary-color);
            background: #edf2f7;
        }
        
        .selected-food {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #7dd3fc;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .food-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .food-name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.1rem;
        }
        
        .food-calories {
            background: var(--accent-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .total-calories {
            background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 25px 0;
            box-shadow: var(--shadow-md);
        }
        
        /* 美化的狀態指示器 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                width: 100%;
            }
        }
        
        /* 隱藏雲端選項的樣式 */
        #cloudOptions {
            display: none;
        }
        
        /* 動畫效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card, .cloud-sync-cover {
            animation: fadeIn 0.5s ease-out;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .date-calories {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .meal-detail {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow-sm);
        }
        
        .edit-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #5a67d8 0%, #4c51bf 100%);
        }
        
        .delete-btn {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e53e3e 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow-sm);
        }
        
        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }
        
        .edit-form {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .edit-form h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .food-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* 移動端餐點記錄按鈕調整 */
            .meal-detail .edit-btn,
            .meal-detail .delete-btn {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 60px;
            }
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        
        .retry-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background: #2980b9;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .meat-tag:hover {
            opacity: 0.8;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- 美化的標題區域 -->
        <div class="header">
            <h1>🐱 貓咪飲食追蹤器</h1>
            <div class="subtitle">智慧記錄，健康成長</div>
        </div>
        
        <div id="syncStatus" class="sync-status" style="display: none;"></div>
        
        <!-- 雲端同步封面 -->
        <div class="cloud-sync-cover" ondblclick="showCloudSyncSettings()">
            <img src="cover.jpg?v=2024062213" alt="雲端數據同步" class="cover-image" id="coverImage">
            <div class="cover-content">
                <div class="cover-title">雲端數據同步</div>
                <div class="cover-subtitle">輕觸兩下進行設定 • 跨裝置同步您的資料</div>
            </div>
        </div>
        
        <!-- 隱藏的雲端設定選項 -->
        <div id="cloudOptions" class="card" style="display: none;">
            <h2>☁️ 雲端數據同步設定</h2>
            <div id="cloudOptionsContent">
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>☁️ 選擇您的雲端存儲方案</h4>
                    <p>為了實現跨平台同步，請選擇一個適合的存儲方案：</p>
                    
                    <div style="margin: 15px 0;">
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>🗂️ GitHub Gist（推薦）</h6>
                            <p>免費、穩定、跨平台，適合技術用戶</p>
                            <button onclick="setupGitHubSync()" class="btn btn-primary">設置 GitHub 同步</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>📋 手動同步（即時分享）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>裝置A生成連結 → 裝置B掃描/點擊 → 立即合併資料</p>
                            <button onclick="showManualSync()" class="btn btn-secondary">手動同步</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>💾 文件存儲（安全備份）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>匯出JSON檔 → 雲端硬碟 → 其他裝置匯入 → 選擇合併或覆蓋</p>
                            <button onclick="showFileSync()" class="btn btn-success">文件同步</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>🔗 在線剪貼板（臨時分享）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>上傳到Pastebin → 取得連結 → 其他裝置載入 → 合併資料</p>
                            <button onclick="showPastebinSync()" class="btn btn-warning">剪貼板同步</button>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                        <small><strong>💡 提示：</strong>所有方案都會保持您的數據私密性，建議先試用 GitHub Gist 方案。</small>
                    </div>
                    
                    <div class="btn-group">
                        <button onclick="hideCloudSyncSettings()" class="btn btn-secondary">← 返回</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>新增餐點記錄</h2>
            
            <!-- 智能搜索區 -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px;">🔍 快速查找貓食</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">品牌篩選</label>
                        <select id="brandFilter" onchange="filterFoods()" style="margin-bottom: 5px;">
                            <option value="">所有品牌</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">分類篩選</label>
                        <select id="categoryFilter" onchange="filterFoods()" style="margin-bottom: 5px;">
                            <option value="">所有分類</option>
                            <option value="主食罐">主食罐</option>
                            <option value="副食罐">副食罐</option>
                            <option value="乾糧">乾糧</option>
                            <option value="主食餐包">主食餐包</option>
                            <option value="奶粉">奶粉</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666;">肉類篩選</label>
                    <div id="meatFilters" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        <!-- 動態生成肉類標籤 -->
                    </div>
                </div>
                
                <div>
                    <label style="font-size: 12px; color: #666;">關鍵字搜索</label>
                    <input type="text" id="searchInput" placeholder="輸入品名、品牌或肉類..." 
                           onkeyup="filterFoods()" style="margin-bottom: 5px;">
                </div>
                
                <div id="searchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; background: white;">
                    <!-- 搜索結果會顯示在這裡 -->
                </div>
            </div>

            <div id="foodSelectors">
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="重量 (克)" step="0.1" min="0">
                </div>
            </div>
            <button onclick="addFoodSelector()" class="btn btn-secondary btn-full">+ 新增食物</button>
            
            <div id="feedingSummary" style="display: none;">
                <div class="total-calories">
                    總餵食: <span id="totalFeedGrams">0</span>g | 總卡路里: <span id="totalCalories">0</span> kcal
                </div>
                
                <div class="form-group">
                    <label class="form-label">實際攝取量</label>
                    <input type="number" id="actualEatenGrams" placeholder="實際吃了多少克（可留空）" step="0.1" min="0" max="999">
                </div>
                
                <div id="actualCalories" class="total-calories" style="display: none; background: linear-gradient(135deg, var(--danger-color) 0%, #e53e3e 100%);">
                    實際攝取: <span id="actualCaloriesValue">0</span> kcal
                </div>
            </div>
            
            <div class="btn-group">
                <button onclick="saveMeal()" id="saveMealBtn" class="btn btn-success btn-full" style="display: none;">
                    💾 儲存這餐
                </button>
                <button onclick="cancelEdit()" id="cancelEditBtn" class="btn btn-secondary" style="display: none;">
                    ❌ 取消編輯
                </button>
            </div>
        </div>
        
        <div class="card">
            <h2>卡路里趨勢圖</h2>
            <div class="chart-container">
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>飲食記錄 <span id="dataSource" style="font-size: 14px; color: #666;"></span></h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // 確保封面圖片正確載入
        function refreshCoverImage() {
            const coverImg = document.getElementById('coverImage');
            if (coverImg) {
                const timestamp = new Date().getTime();
                coverImg.src = `cover.jpg?v=${timestamp}`;
            }
        }
        
        // 頁面載入時自動刷新封面圖片
        window.addEventListener('load', refreshCoverImage);

        // 雲端同步相關變數
        let cloudSyncEnabled = false;
        let dataSource = 'local'; // 'github' or 'local'

        // 顯示雲端同步設定
        function showCloudSyncSettings() {
            document.querySelector('.cloud-sync-cover').style.display = 'none';
            document.getElementById('cloudOptions').style.display = 'block';
        }

        // 隱藏雲端同步設定
        function hideCloudSyncSettings() {
            document.querySelector('.cloud-sync-cover').style.display = 'block';
            document.getElementById('cloudOptions').style.display = 'none';
        }

        // 貓糧資料庫
        const foodDatabase = [
            {name: "catdives 貓爾地夫 全齡貓營養升級 魩仔魚+板腱牛+雞胸肉", calories: 100.2, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["牛肉","貝類","雞肉","魩仔魚"], texture: "乾糧", origin: "台灣"},
            {name: "catdives 貓爾地夫 全齡貓營養升級 魩仔魚+鮪魚+雞胸肉", calories: 97.9, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["貝類","雞肉","魩仔魚","鮪魚"], texture: "乾糧", origin: "台灣"},
            {name: "catdives 貓爾地夫 經典回味 嚴選羊雞胸肉", calories: 102.8, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["羊肉","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "catdives 貓爾地夫 經典回味 板腱牛雞胸肉", calories: 107.9, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["牛肉","貝類","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "catdives 貓爾地夫 經典回味 雞胸肉", calories: 100.3, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "catdives 貓爾地夫 經典回味 鮪魚雞胸肉", calories: 97.3, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["雞肉","鮪魚"], texture: "肉泥", origin: "台灣"},
            {name: "catdives 貓爾地夫 頂級享受 嚴選鹿", calories: 84.7, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["鹿"], texture: "肉泥", origin: "台灣"},
            {name: "catdives 貓爾地夫 頂級享受 菲力牛", calories: 95.3, category: "主食罐", brand: "catdives 貓爾地夫", meat: ["牛肉"], texture: "肉泥", origin: "台灣"},
            {name: "Dog Cat Star 汪喵星球 冷凍乾燥生食-櫻桃鴨", calories: 480, category: "乾糧", brand: "Dog Cat Star 汪喵星球", meat: ["雞肉","鴨肉"], texture: "乾糧", origin: "台灣"},
            {name: "Dr. Wish 雞肉+鮪魚+牛磺酸", calories: 39, category: "副食罐", brand: "Dr. Wish", meat: ["雞肉","鮪魚"], texture: "肉泥", origin: "台灣"},
            {name: "Dr. Wish 鮪魚+果寡糖", calories: 34, category: "副食罐", brand: "Dr. Wish", meat: ["鮪魚"], texture: "肉泥", origin: "台灣"},
            {name: "Dr. Wish 鮪魚+維他命A", calories: 34, category: "副食罐", brand: "Dr. Wish", meat: ["鮪魚"], texture: "肉泥", origin: "台灣"},
            {name: "Dr. Wish 鮪魚+雞肉+維他命B群", calories: 32, category: "副食罐", brand: "Dr. Wish", meat: ["雞肉","鮪魚"], texture: "肉泥", origin: "台灣"},
            {name: "K9 Natural 無穀牛", calories: 112.3, category: "主食罐", brand: "K9 Natural", meat: ["牛肉"], texture: "肉泥", origin: "紐西蘭"},
            {name: "K9 Natural 無穀牛+鱈魚", calories: 94.5, category: "主食罐", brand: "K9 Natural", meat: ["牛肉","鱈魚"], texture: "肉泥", origin: "紐西蘭"},
            {name: "K9 Natural 無穀羊", calories: 121.1, category: "主食罐", brand: "K9 Natural", meat: ["羊肉"], texture: "肉泥", origin: "紐西蘭"},
            {name: "K9 Natural 無穀羊+鮭魚", calories: 106, category: "主食罐", brand: "K9 Natural", meat: ["羊肉","鮭魚"], texture: "肉泥", origin: "紐西蘭"},
            {name: "K9 Natural 無穀雞", calories: 101.3, category: "主食罐", brand: "K9 Natural", meat: ["雞肉"], texture: "肉泥", origin: "紐西蘭"},
            {name: "K9 Natural 無穀雞+鹿", calories: 86.2, category: "主食罐", brand: "K9 Natural", meat: ["雞肉","鹿"], texture: "肉泥", origin: "紐西蘭"},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶燉雞", calories: 127.5, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶虱目魚", calories: 127.5, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["虱目魚","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶鱸魚", calories: 126.5, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉","鱸魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-原野牛腿", calories: 124.2, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["牛肉","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-白蝦干貝", calories: 103.7, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["貝類","雞肉","鮮蝦","鰹魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-肥美鯖魚", calories: 114.4, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉","鯖魚","鰹魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-野味火雞", calories: 118.1, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["火雞肉","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-香嫩鴨胸", calories: 117.3, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉","鴨肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-鮮香鰹魚", calories: 120.6, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉","鰹魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 四種魚｜白肉", calories: 123.2, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["虱目魚","雞肉","鯛魚","鰹魚","鱸魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 四種魚｜紅肉", calories: 117.8, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["旗魚","雞肉","鮭魚","鯖魚","鰹魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合海陸", calories: 117.8, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["牛肉","雞肉","鯛魚","鰹魚"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合蝦貝", calories: 116.3, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["貝類","雞肉","鮮蝦"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合野味", calories: 117.8, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["牛肉","羊肉","雞肉","鴨肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1益生菌 雞肉莓果", calories: 115.1, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 慢燉鮮魚", calories: 112.1, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉","鮭魚","鯛魚"], texture: "肉湯", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 濃湯牛腿", calories: 112.1, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["牛肉","雞肉"], texture: "肉湯", origin: "台灣"},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 白醬嫩雞", calories: 100.1, category: "主食罐", brand: "Lady Flavor 好味小姐", meat: ["雞肉"], texture: "肉湯", origin: "台灣"},
            {name: "LitoMON 怪獸部落 98%鮮肉-雞肉", calories: 415, category: "乾糧", brand: "LitoMON 怪獸部落", meat: ["雞肉"], texture: "乾糧", origin: "台灣"},
            {name: "MAC's 馬克 幼貓-火雞肉+兔肉", calories: 98, category: "主食罐", brand: "MAC's 馬克", meat: ["兔肉","火雞肉"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 火雞肉+火雞心", calories: 89, category: "主食罐", brand: "MAC's 馬克", meat: ["火雞肉"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 羊肉", calories: 90, category: "主食罐", brand: "MAC's 馬克", meat: ["羊肉"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 羊肉+火雞肉", calories: 98, category: "主食罐", brand: "MAC's 馬克", meat: ["火雞肉","羊肉"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 雞肉+雞心", calories: 111, category: "主食罐", brand: "MAC's 馬克", meat: ["雞肉"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 鮭魚+雞肉", calories: 98, category: "主食罐", brand: "MAC's 馬克", meat: ["雞肉","鮭魚"], texture: "碎肉", origin: "德國"},
            {name: "MAC's 馬克 鴨肉+火雞肉+雞肉", calories: 101, category: "主食罐", brand: "MAC's 馬克", meat: ["火雞肉","雞肉","鴨肉"], texture: "碎肉", origin: "德國"},
            {name: "Meow Servant 喵皇奴 純雞肉", calories: 114, category: "主食罐", brand: "Meow Servant 喵皇奴", meat: ["雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Meow Servant 喵皇奴 雞肉+牛肉", calories: 120, category: "主食罐", brand: "Meow Servant 喵皇奴", meat: ["牛肉","雞肉"], texture: "肉泥", origin: "台灣"},
            {name: "Meow Servant 喵皇奴 鮭魚+雞肉", calories: 121, category: "主食罐", brand: "Meow Servant 喵皇奴", meat: ["雞肉","鮭魚"], texture: "肉泥", origin: "台灣"},
            {name: "Meow Servant 喵皇奴 鵪鶉+雞肉", calories: 115, category: "主食罐", brand: "Meow Servant 喵皇奴", meat: ["雞肉","鵪鶉"], texture: "肉泥", origin: "台灣"},
            {name: "Orijen 歐睿健 幼貓鮮雞", calories: 412, category: "乾糧", brand: "Orijen 歐睿健/極致", meat: ["混合"], texture: "乾糧", origin: "加拿大"},
            {name: "ROYAL CANIN 皇家 K36 幼貓專用", calories: 370, category: "乾糧", brand: "ROYAL CANIN 皇家", meat: ["混合"], texture: "乾糧", origin: "法國"},
            {name: "ROYAL CANIN 皇家 LP34 泌尿道配方乾糧", calories: 387.2, category: "乾糧", brand: "ROYAL CANIN 皇家", meat: ["混合"], texture: "乾糧", origin: "法國"},
            {name: "ROYAL CANIN 皇家 S33W 腸胃保健", calories: 78.8, category: "主食餐包", brand: "ROYAL CANIN 皇家", meat: ["混合"], texture: "肉塊", origin: "法國"},
            {name: "ROYAL CANIN 皇家 幼貓", calories: 80.6, category: "主食餐包", brand: "ROYAL CANIN 皇家", meat: ["混合"], texture: "肉塊", origin: "法國"},
            {name: "ZIWIPeak 巔峰 雞肉", calories: 550, category: "乾糧", brand: "ZIWIPeak 巔峰", meat: ["雞肉"], texture: "乾糧", origin: "紐西蘭"},
            {name: "森乳 高熱量奶粉", calories: 651, category: "奶粉", brand: "森乳", meat: ["動物奶"], texture: "奶粉", origin: "日本"}
        ];

        let foodSelectorCount = 1;
        let currentMeal = [];
        let mealHistory = [];
        let chart = null;
        let editingMealIndex = -1;

        // 初始化
        async function init() {
            populateFoodSelect('foodSelect0');
            initSmartFoodSearch();
            
            // 綁定事件
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            // 立即顯示雲端同步選項，不載入 Google API
            document.getElementById('cloudOptions').style.display = 'block';
            
            // 檢查分享數據
            checkForSharedData();
            
            // 檢查已保存的 GitHub 設定並嘗試自動載入
            await initializeWithGitHub();
            
            // 如果 GitHub 沒有數據，則載入本地數據作為後備
            if (mealHistory.length === 0) {
                loadHistoryFromStorage();
                dataSource = 'local';
            }
            
            updateChart();
            updateDataSourceDisplay();
        }

        // 填充食物選項
        function populateFoodSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">選擇食物...</option>';
            
            foodDatabase.forEach((food, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = food.name;
                select.appendChild(option);
            });
            
            select.addEventListener('change', calculateCalories);
        }

        // 新增食物選擇器
        function addFoodSelector() {
            const container = document.getElementById('foodSelectors');
            const newSelector = document.createElement('div');
            newSelector.className = 'food-selector';
            newSelector.innerHTML = `
                <select id="foodSelect${foodSelectorCount}">
                    <option value="">選擇食物...</option>
                </select>
                <input type="number" id="grams${foodSelectorCount}" placeholder="重量 (克)" step="0.1" min="0">
                <button type="button" class="remove-btn" onclick="removeFoodSelector(this)">移除</button>
            `;
            
            container.appendChild(newSelector);
            populateFoodSelect(`foodSelect${foodSelectorCount}`);
            
            document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
            
            foodSelectorCount++;
        }

        // 移除食物選擇器
        function removeFoodSelector(button) {
            button.parentElement.remove();
            calculateCalories();
        }

        // 計算卡路里
        function calculateCalories() {
            const selectors = document.querySelectorAll('.food-selector');
            let totalFeedCalories = 0;
            let totalFeedGrams = 0;
            currentMeal = [];

            selectors.forEach((selector, index) => {
                const foodSelect = selector.querySelector('select');
                const gramsInput = selector.querySelector('input[type="number"]');
                
                const foodIndex = foodSelect.value;
                const grams = parseFloat(gramsInput.value) || 0;
                
                if (foodIndex !== '' && grams > 0) {
                    const food = foodDatabase[foodIndex];
                    const calories = (food.calories * grams / 100);  // 每100g的卡路里
                    totalFeedCalories += calories;
                    totalFeedGrams += grams;
                    
                    currentMeal.push({
                        name: food.name,
                        feedGrams: grams,
                        caloriesPerGram: food.calories / 100
                    });
                }
            });

            const summaryElement = document.getElementById('feedingSummary');
            const saveBtn = document.getElementById('saveMealBtn');
            
            if (totalFeedGrams > 0) {
                document.getElementById('totalFeedGrams').textContent = totalFeedGrams.toFixed(1);
                document.getElementById('totalCalories').textContent = totalFeedCalories.toFixed(1);
                summaryElement.style.display = 'block';
                
                // 綁定實際吃了多少的計算
                const actualEatenInput = document.getElementById('actualEatenGrams');
                actualEatenInput.max = totalFeedGrams; // 設定最大值為總餵食量
                actualEatenInput.placeholder = `實際吃了多少克 (最多${totalFeedGrams.toFixed(1)}g)`;
                actualEatenInput.oninput = function() {
                    calculateActualCalories(totalFeedCalories, totalFeedGrams);
                };
                
                saveBtn.style.display = 'block';
            } else {
                summaryElement.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }

        // 計算實際攝取卡路里
        function calculateActualCalories(totalFeedCalories, totalFeedGrams) {
            const actualEatenInput = document.getElementById('actualEatenGrams');
            const inputValue = actualEatenInput.value.trim();
            let actualEatenGrams;
            
            // 處理空白輸入
            if (inputValue === '') {
                actualEatenGrams = 0; // 空白預設為 0
            } else {
                actualEatenGrams = parseFloat(inputValue) || 0;
                
                // 如果輸入值超過總餵食量，自動調整為最大值
                if (actualEatenGrams > totalFeedGrams) {
                    actualEatenGrams = totalFeedGrams;
                    actualEatenInput.value = totalFeedGrams.toFixed(1);
                    showSyncStatus(`實際攝取已自動調整為最大值 ${totalFeedGrams.toFixed(1)}g`, 'warning');
                }
            }
            
            if (actualEatenGrams > 0) {
                // 按比例計算實際攝取的卡路里
                const ratio = actualEatenGrams / totalFeedGrams;
                const actualCalories = totalFeedCalories * ratio;
                
                document.getElementById('actualCaloriesValue').textContent = actualCalories.toFixed(1);
                document.getElementById('actualCalories').style.display = 'block';
                
                // 更新 currentMeal 資料
                currentMeal.forEach(food => {
                    food.actualGrams = food.feedGrams * ratio;
                    food.actualCalories = food.caloriesPerGram * food.actualGrams;
                });
                
                return actualCalories;
            } else {
                document.getElementById('actualCalories').style.display = 'none';
                return 0;
            }
        }

        // 儲存餐點
        function saveMeal() {
            if (currentMeal.length === 0) return;
            
            const totalFeedGrams = currentMeal.reduce((sum, food) => sum + food.feedGrams, 0);
            const actualEatenInput = document.getElementById('actualEatenGrams').value.trim();
            let actualEatenGrams;
            
            // 允許空白輸入，表示還沒開始吃或還沒吃完
            if (actualEatenInput === '') {
                // 空白時預設為 0（表示還沒吃或還沒吃完）
                actualEatenGrams = 0;
                showSyncStatus('實際攝取量為空，預設為 0g（可稍後更新）', 'info');
            } else {
                actualEatenGrams = parseFloat(actualEatenInput);
                if (isNaN(actualEatenGrams) || actualEatenGrams < 0) {
                    alert('請輸入有效的實際攝取量（可留空表示還沒吃）');
                    return;
                }
                
                // 確保實際攝取不超過總餵食量
                if (actualEatenGrams > totalFeedGrams) {
                    actualEatenGrams = totalFeedGrams;
                    document.getElementById('actualEatenGrams').value = totalFeedGrams.toFixed(1);
                    showSyncStatus(`實際攝取已自動調整為最大值 ${totalFeedGrams.toFixed(1)}g`, 'warning');
                }
            }
            
            const totalFeedCalories = currentMeal.reduce((sum, food) => sum + (food.caloriesPerGram * food.feedGrams), 0);
            const actualCalories = calculateActualCalories(totalFeedCalories, totalFeedGrams);
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].slice(0, 5);
            
            const meal = {
                date: dateStr,
                time: timeStr,
                foods: currentMeal.map(food => ({
                    name: food.name,
                    feedGrams: food.feedGrams,
                    actualGrams: food.actualGrams,
                    actualCalories: food.actualCalories
                })),
                totalFeedGrams: totalFeedGrams,
                actualEatenGrams: actualEatenGrams,
                totalFeedCalories: totalFeedCalories,
                actualCalories: actualCalories
            };
            
            if (editingMealIndex >= 0) {
                // 編輯模式：更新現有餐點
                mealHistory[editingMealIndex] = meal;
                editingMealIndex = -1;
                showSyncStatus('餐點已更新！', 'success');
            } else {
                // 新增模式：加入新餐點
                mealHistory.unshift(meal);
                showSyncStatus('餐點已記錄！', 'success');
            }
            
            saveHistoryToStorage();
            syncToCloud();
            
            // 清空表單
            resetForm();
            
            // 更新顯示
            displayHistory();
            updateChart();
        }

        // 重置表單
        function resetForm() {
            const container = document.getElementById('foodSelectors');
            container.innerHTML = `
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="重量 (克)" step="0.1" min="0">
                </div>
            `;
            
            foodSelectorCount = 1;
            populateFoodSelect('foodSelect0');
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            document.getElementById('feedingSummary').style.display = 'none';
            document.getElementById('saveMealBtn').style.display = 'none';
            document.getElementById('saveMealBtn').textContent = '儲存這餐';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('actualEatenGrams').value = '';
            
            currentMeal = [];
            editingMealIndex = -1;
        }

        // 顯示歷史記錄
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (mealHistory.length === 0) {
                historyList.innerHTML = '<p>尚無飲食記錄</p>';
                return;
            }
            
            // 按日期分組
            const groupedHistory = {};
            mealHistory.forEach(meal => {
                if (!groupedHistory[meal.date]) {
                    groupedHistory[meal.date] = [];
                }
                groupedHistory[meal.date].push(meal);
            });
            
            historyList.innerHTML = '';
            
            Object.keys(groupedHistory).sort().reverse().forEach(date => {
                const dayMeals = groupedHistory[date];
                const dayTotal = dayMeals.reduce((sum, meal) => sum + (meal.actualCalories || meal.totalCalories || 0), 0);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'history-item';
                
                let mealsHtml = '';
                dayMeals.forEach((meal, mealIndex) => {
                    const globalMealIndex = mealHistory.findIndex(m => m === meal);
                    const foodsText = meal.foods.map(f => `${f.name} ${f.feedGrams}g`).join(', ');
                    mealsHtml += `
                        <div class="meal-detail" id="meal-${globalMealIndex}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <button class="edit-btn" onclick="editMeal(${globalMealIndex})">✏️ 編輯</button>
                                <span style="flex: 1; text-align: center; padding: 0 10px;">
                                    ${meal.time} - 實際攝取: ${meal.actualCalories.toFixed(1)} kcal<br>
                                    <small>(餵${meal.totalFeedGrams.toFixed(1)}g，吃${meal.actualEatenGrams.toFixed(1)}g)</small>
                                </span>
                                <button class="delete-btn" onclick="deleteMeal(${globalMealIndex})">🗑️ 刪除</button>
                            </div>
                            <small style="display: block; padding: 5px 0; color: #666;">${foodsText}</small>
                        </div>
                    `;
                });
                
                dayElement.innerHTML = `
                    <div class="date-calories">${date} - 總計: ${dayTotal.toFixed(1)} kcal</div>
                    ${mealsHtml}
                `;
                
                historyList.appendChild(dayElement);
            });
            
            // 更新數據來源顯示
            updateDataSourceDisplay();
        }

        // 更新圖表
        function updateChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            
            // 準備圖表資料
            const dailyCalories = {};
            mealHistory.forEach(meal => {
                if (!dailyCalories[meal.date]) {
                    dailyCalories[meal.date] = 0;
                }
                dailyCalories[meal.date] += (meal.actualCalories || meal.totalCalories || 0);
            });
            
            const dates = Object.keys(dailyCalories).sort();
            const calories = dates.map(date => dailyCalories[date].toFixed(1));
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '每日卡路里',
                        data: calories,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '卡路里 (kcal)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // 本地儲存
        function saveHistoryToStorage() {
            localStorage.setItem('catFoodHistory', JSON.stringify(mealHistory));
        }

        function loadHistoryFromStorage() {
            const stored = localStorage.getItem('catFoodHistory');
            if (stored) {
                mealHistory = JSON.parse(stored);
                displayHistory();
            }
        }

        // 雲端同步功能
        async function syncToCloud() {
            // 如果有 GitHub 設定，自動同步到 GitHub
            if (githubToken && githubGistId) {
                try {
                    await saveToGitHub();
                    console.log('數據已自動同步到 GitHub');
                } catch (error) {
                    console.warn('自動同步到 GitHub 失敗:', error);
                    showSyncStatus('自動同步失敗，請檢查網路連線', 'error');
                }
            }
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 編輯餐點
        function editMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) return;
            
            editingMealIndex = mealIndex;
            
            // 清空現有表單
            const container = document.getElementById('foodSelectors');
            container.innerHTML = '';
            
            // 重建表單以符合要編輯的餐點
            foodSelectorCount = 0;
            meal.foods.forEach((food, index) => {
                const newSelector = document.createElement('div');
                newSelector.className = 'food-selector';
                newSelector.innerHTML = `
                    <select id="foodSelect${foodSelectorCount}">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams${foodSelectorCount}" placeholder="重量 (克)" step="0.1" min="0" value="${food.feedGrams}">
                    ${foodSelectorCount > 0 ? '<button type="button" class="remove-btn" onclick="removeFoodSelector(this)">移除</button>' : ''}
                `;
                
                container.appendChild(newSelector);
                populateFoodSelect(`foodSelect${foodSelectorCount}`);
                
                // 設定選中的食物
                const foodIndex = foodDatabase.findIndex(f => f.name === food.name);
                if (foodIndex >= 0) {
                    document.getElementById(`foodSelect${foodSelectorCount}`).value = foodIndex;
                }
                
                document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
                
                foodSelectorCount++;
            });
            
            // 設定實際攝取量
            document.getElementById('actualEatenGrams').value = meal.actualEatenGrams;
            
            // 重新計算卡路里以顯示預覽
            calculateCalories();
            
            // 修改按鈕文字
            document.getElementById('saveMealBtn').textContent = '更新餐點';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // 滾動到表單頂部
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            
            showSyncStatus('編輯模式：修改完成後點擊「更新餐點」', 'success');
        }
        
        // 刪除餐點
        function deleteMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) {
                console.error('找不到要刪除的餐點，索引:', mealIndex);
                alert('找不到要刪除的記錄，請重新整理頁面');
                return;
            }
            
            const confirmDelete = confirm(`確定要刪除 ${meal.date} ${meal.time} 的餐點記錄嗎？\n實際攝取: ${meal.actualCalories.toFixed(1)} kcal`);
            
            if (confirmDelete) {
                console.log(`刪除餐點，索引: ${mealIndex}, 刪除前總數: ${mealHistory.length}`);
                mealHistory.splice(mealIndex, 1);
                console.log(`刪除後總數: ${mealHistory.length}`);
                
                saveHistoryToStorage();
                
                // 更新顯示
                displayHistory();
                updateChart();
                
                // 自動同步到 GitHub
                syncToCloud();
                
                showSyncStatus('餐點記錄已刪除並同步到 GitHub', 'success');
            }
        }
        
        // 取消編輯
        function cancelEdit() {
            editingMealIndex = -1;
            resetForm();
            document.getElementById('saveMealBtn').textContent = '儲存這餐';
            showSyncStatus('已取消編輯', 'success');
        }
        
        // ==================== 雲端同步功能 ====================





        // 尋找數據衝突
        function findDataConflicts(localData, driveData) {
            const conflicts = [];
            const localMealMap = new Map();
            
            localData.forEach((meal, index) => {
                const key = `${meal.date}_${meal.time}`;
                localMealMap.set(key, { meal, index });
            });

            driveData.forEach((driveMeal, driveIndex) => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (localMealMap.has(key)) {
                    const localEntry = localMealMap.get(key);
                    if (JSON.stringify(localEntry.meal) !== JSON.stringify(driveMeal)) {
                        conflicts.push({
                            local: localEntry.meal,
                            drive: driveMeal,
                            localIndex: localEntry.index,
                            driveIndex: driveIndex
                        });
                    }
                }
            });

            return conflicts;
        }

        // 合併數據陣列
        function mergeDataArrays(localData, driveData) {
            const merged = [...localData];
            const localKeys = new Set(localData.map(meal => `${meal.date}_${meal.time}`));

            driveData.forEach(driveMeal => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (!localKeys.has(key)) {
                    merged.push(driveMeal);
                }
            });

            // 按日期時間排序
            return merged.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateB - dateA;
            });
        }

        // 處理數據衝突
        function handleDataConflicts(driveData, fileName, conflicts) {
            const message = `在合併 ${fileName} 時發現 ${conflicts.length} 個衝突記錄。\n\n` +
                           `選擇處理方式：\n` +
                           `• 確定：使用 Google Drive 版本覆蓋本地版本\n` +
                           `• 取消：保留本地版本，忽略 Google Drive 版本`;
            
            if (confirm(message)) {
                // 使用 Drive 版本
                conflicts.forEach(conflict => {
                    mealHistory[conflict.localIndex] = conflict.drive;
                });
                
                // 合併其他非衝突記錄
                const mergedData = mergeDataArrays(mealHistory, driveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已使用 Google Drive 版本解決 ${conflicts.length} 個衝突`, 'success');
            } else {
                // 保留本地版本，只合併非衝突記錄
                const nonConflictDriveData = driveData.filter(driveMeal => {
                    const key = `${driveMeal.date}_${driveMeal.time}`;
                    return !conflicts.some(conflict => 
                        `${conflict.drive.date}_${conflict.drive.time}` === key
                    );
                });
                
                const mergedData = mergeDataArrays(mealHistory, nonConflictDriveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已保留本地版本，合併了 ${nonConflictDriveData.length} 筆非衝突記錄`, 'success');
            }
        }

        // 切換自動同步
        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSync').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                showSyncStatus('已啟用自動同步到 Google Drive', 'success');
            } else {
                showSyncStatus('已停用自動同步', 'success');
            }
        }

        // 載入自動同步設定
        function loadAutoSyncSetting() {
            const saved = localStorage.getItem('autoSyncEnabled');
            if (saved !== null) {
                autoSyncEnabled = saved === 'true';
                document.getElementById('autoSync').checked = autoSyncEnabled;
            }
        }

        // 顯示後備認證選項
        function showFallbackAuth() {
            // loadingAuth 元素已移除
            document.getElementById('fallbackAuth').style.display = 'block';
            
            // 添加調試信息
            const debugInfo = {
                gapi: typeof gapi !== 'undefined',
                google: typeof google !== 'undefined',
                isGoogleApiLoaded: isGoogleApiLoaded,
                currentURL: window.location.href,
                userAgent: navigator.userAgent
            };
            
            console.warn('Google API 載入超時，顯示後備選項');
            console.log('調試信息:', debugInfo);
        }

        // 調試模式 - 檢查 Google API 狀態
        function debugGoogleAPI() {
            console.log('=== Google API 調試信息 ===');
            console.log('gapi 是否已載入:', typeof gapi !== 'undefined');
            console.log('google 是否已載入:', typeof google !== 'undefined');
            console.log('isGoogleApiLoaded:', isGoogleApiLoaded);
            console.log('isAuthorized:', isAuthorized);
            console.log('當前網址:', window.location.href);
            console.log('GOOGLE_CONFIG:', GOOGLE_CONFIG);
            
            if (typeof gapi !== 'undefined') {
                console.log('gapi.client:', gapi.client);
                try {
                    console.log('gapi.client.getToken():', gapi.client.getToken());
                } catch (e) {
                    console.log('獲取 token 失敗:', e.message);
                }
            }
            
            console.log('=== 調試信息結束 ===');
        }

        // 啟用離線模式
        function enableOfflineMode() {
            // loadingAuth 元素已移除
            // fallbackAuth 元素已移除
            document.getElementById('googleAuth').innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px;">
                    <h4>📱 本地模式已啟用</h4>
                    <p>✅ <strong>所有功能都可以正常使用！</strong></p>
                    <p>您的數據將保存在此瀏覽器的本地存儲中。</p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>📋 本地模式功能：</h5>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>✅ 記錄餐點和卡路里</li>
                            <li>✅ 編輯和刪除記錄</li>
                            <li>✅ 查看卡路里趨勢圖</li>
                            <li>✅ 數據自動保存</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>💾 數據備份建議：</h5>
                        <p style="margin: 5px 0;">定期匯出數據以防資料遺失：</p>
                        <button onclick="exportLocalData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0;">匯出數據</button>
                        <small style="display: block; margin-top: 5px;">將數據下載為 JSON 檔案保存</small>
                    </div>
                    
                    <p><small>💡 提示：您可以隨時重新整理頁面來重試 Google Drive 功能。</small></p>
                </div>
            `;
            // googleAuth 元素已移除
            
            showSyncStatus('已啟用本地模式 - 所有功能都可正常使用！', 'success');
            console.log('本地模式已啟用');
        }

        // Google API 連線測試
        async function testGoogleAPI() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>🔍 正在進行詳細測試...</p>';
            
            const tests = [];
            
            // 測試 1: 基本 API 腳本載入
            try {
                const response = await fetch('https://apis.google.com/js/api.js');
                tests.push(`✅ Google API 腳本可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google API 腳本無法訪問: ${error.message}`);
            }
            
            // 測試 2: Google Identity Services (詳細測試)
            try {
                const response = await fetch('https://accounts.google.com/gsi/client', { method: 'HEAD' });
                tests.push(`✅ Google Identity Services 可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google Identity Services 無法訪問: ${error.message}`);
            }
            
            // 測試 3: 替代 Google 服務測試
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo?access_token=test', { method: 'HEAD' });
                tests.push(`✅ Google OAuth API 可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google OAuth API 無法訪問: ${error.message}`);
            }
            
            // 測試 4: Google 主域名測試
            try {
                const response = await fetch('https://accounts.google.com', { method: 'HEAD', mode: 'no-cors' });
                tests.push(`✅ Google 主域名可訪問`);
            } catch (error) {
                tests.push(`❌ Google 主域名無法訪問: ${error.message}`);
            }
            
            // 測試 5: 檢查腳本載入錯誤
            if (scriptErrors.length > 0) {
                tests.push(`❌ 腳本載入錯誤: ${scriptErrors.join(', ')}`);
            } else {
                tests.push(`✅ 沒有檢測到腳本載入錯誤`);
            }
            
            // 測試 6: 檢查變數
            tests.push(`gapi 變數: ${typeof gapi !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}`);
            tests.push(`google 變數: ${typeof google !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}`);
            
            // 測試 7: 瀏覽器環境檢查
            tests.push(`瀏覽器: ${navigator.userAgent.split(' ')[0]}`);
            tests.push(`是否支援 fetch: ${typeof fetch !== 'undefined' ? '✅' : '❌'}`);
            tests.push(`是否為 HTTPS: ${location.protocol === 'https:' ? '✅' : '❌'}`);
            tests.push(`第三方 Cookie: ${navigator.cookieEnabled ? '✅ 啟用' : '❌ 禁用'}`);
            
            // 測試 8: 檢查可能的阻擋因素
            const blockers = [];
            if (window.chrome && window.chrome.runtime) {
                blockers.push('Chrome 擴展可能影響');
            }
            if (navigator.brave) {
                blockers.push('Brave 瀏覽器內建阻擋');
            }
            if (window.safari) {
                blockers.push('Safari 追蹤防護可能影響');
            }
            if (blockers.length > 0) {
                tests.push(`⚠️ 偵測到潛在阻擋因素: ${blockers.join(', ')}`);
            }
            
            // 判斷主要問題並提供解決方案
            let mainIssue = '';
            let solutions = [];
            
            if (tests.some(test => test.includes('Google Identity Services 無法訪問'))) {
                mainIssue = '🔒 Google Identity Services 被阻擋';
                solutions = [];
                
                // 根據檢測到的情況提供具體建議
                if (tests.some(test => test.includes('Brave 瀏覽器'))) {
                    solutions.push('Brave: 設定 → 隱私權與安全 → 關閉「阻擋腳本」');
                }
                if (tests.some(test => test.includes('Safari'))) {
                    solutions.push('Safari: 偏好設定 → 隱私權 → 關閉「防止跨網站追蹤」');
                }
                if (tests.some(test => test.includes('Chrome 擴展'))) {
                    solutions.push('檢查 Chrome 擴展，暫時停用安全相關擴展');
                }
                
                // Chrome 專用建議
                if (navigator.userAgent.includes('Chrome')) {
                    solutions.unshift('🌐 Chrome 專用解決方案：');
                    solutions.unshift('1. 設定 → 隱私權和安全性 → 網站設定 → JavaScript → 允許');
                    solutions.unshift('2. 設定 → 隱私權和安全性 → 網站設定 → Cookie → 允許第三方 Cookie');
                    solutions.unshift('3. 設定 → 隱私權和安全性 → 安全瀏覽 → 選擇「標準保護」');
                    solutions.unshift('4. 檢查是否啟用了「增強型保護」→ 改為「標準保護」');
                    solutions.unshift('5. 網址列 → 點擊鎖頭圖示 → Cookie → 允許此網站的 Cookie');
                    solutions.unshift('━━━━━━━━━━━━━━━━━━━━━━━━━');
                } else if (navigator.userAgent.includes('Mozilla') && navigator.userAgent.includes('Firefox')) {
                    solutions.unshift('🦊 Firefox 設定：');
                    solutions.unshift('1. 網址列輸入 about:config → 搜尋 privacy.resistFingerprinting → 設為 false');
                    solutions.unshift('2. 設定 → 隱私權與安全 → 增強型追蹤保護 → 選擇「標準」');
                    solutions.unshift('3. 設定 → 隱私權與安全 → Cookie → 選擇「標準」');
                }
                
                // 通用解決方案
                solutions.push('檢查瀏覽器隱私權設定，允許第三方腳本');
                solutions.push('嘗試無痕/私人瀏覽模式');
                solutions.push('檢查網路是否有企業防火牆或過濾器');
                solutions.push('嘗試關閉 VPN 或代理伺服器');
                solutions.push('檢查防毒軟體是否阻擋 Google 服務');
                solutions.push('或直接使用「僅使用本地模式」');
                
            } else if (typeof gapi === 'undefined') {
                mainIssue = '📡 Google API 腳本載入失敗';
                solutions = [
                    '檢查網路連線',
                    '重新載入頁面',
                    '清除瀏覽器緩存',
                    '嘗試不同的 DNS 設定 (如 8.8.8.8)'
                ];
            }

            resultsDiv.innerHTML = `
                <h5>🔍 測試結果：</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                    ${tests.map(test => `<li>${test}</li>`).join('')}
                </ul>
                ${mainIssue ? `
                    <div style="margin: 10px 0; padding: 8px; background: #fff3cd; border-radius: 4px;">
                        <strong style="font-size: 12px;">${mainIssue}</strong>
                        <ol style="margin: 5px 0 0 0; padding-left: 18px; font-size: 11px;">
                            ${solutions.map(solution => `<li>${solution}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
            `;
        }

        // 顯示修復指南
        function showFixGuide() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h5>🔧 Chrome 專用修復指南</h5>
                    <p><strong>最常見原因：Chrome 的安全瀏覽設定過於嚴格</strong></p>
                    
                    <h6>🎯 立即嘗試：</h6>
                    <ol style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li><strong>檢查網址列鎖頭</strong>：點擊網址列左側的鎖頭圖示 → Cookie → 「允許」</li>
                        <li><strong>檢查安全瀏覽</strong>：Chrome 設定 → 隱私權和安全性 → 安全瀏覽 → 選擇「標準保護」</li>
                        <li><strong>允許第三方 Cookie</strong>：設定 → 隱私權和安全性 → 網站設定 → Cookie → 允許第三方 Cookie</li>
                        <li><strong>無痕模式測試</strong>：Ctrl+Shift+N 開啟無痕視窗測試</li>
                    </ol>
                    
                    <h6>🔍 其他可能原因：</h6>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li>企業或學校網路阻擋 OAuth 服務</li>
                        <li>防毒軟體或網路安全軟體干擾</li>
                        <li>ISP 或 DNS 過濾服務</li>
                        <li>Chrome 擴展程式衝突</li>
                    </ul>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>💡 快速測試：</strong>如果上述方法都不行，請點擊「本地模式」直接使用應用！
                    </div>
                </div>
            `;
        }

        // 嘗試無痕模式
        function tryIncognitoMode() {
            const url = window.location.href;
            const message = `請嘗試在無痕/私人瀏覽模式下開啟：\n\n${url}\n\n快捷鍵：\nChrome/Edge: Ctrl+Shift+N\nFirefox: Ctrl+Shift+P\nSafari: Cmd+Shift+N`;
            
            if (navigator.share) {
                navigator.share({
                    title: '貓咪飲食追蹤器',
                    url: url
                }).catch(() => {
                    alert(message);
                });
            } else {
                alert(message);
                // 嘗試複製到剪貼板
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(url);
                }
            }
        }

        // 更新數據來源顯示
        function updateDataSourceDisplay() {
            const sourceElement = document.getElementById('dataSource');
            if (!sourceElement) return;
            
            const hasGitHubToken = githubToken && githubGistId;
            
            if (dataSource === 'github' && hasGitHubToken) {
                sourceElement.innerHTML = '(📂 GitHub 雲端數據)';
                sourceElement.style.color = '#28a745';
            } else if (hasGitHubToken) {
                sourceElement.innerHTML = '(💾 本地數據 + GitHub 同步)';
                sourceElement.style.color = '#17a2b8';
            } else {
                sourceElement.innerHTML = '(💾 僅本地數據)';
                sourceElement.style.color = '#ffc107';
            }
        }

        // ==================== 智能食物搜索功能 ====================
        
        let currentActiveFilters = {
            brand: '',
            category: '',
            meat: [],
            search: ''
        };

        // 初始化智能食物搜索
        function initSmartFoodSearch() {
            // 初始化品牌選項
            const brands = [...new Set(foodDatabase.map(food => food.brand))].sort();
            const brandFilter = document.getElementById('brandFilter');
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });

            // 初始化肉類標籤
            const allMeats = [...new Set(foodDatabase.flatMap(food => food.meat))].sort();
            const meatFilters = document.getElementById('meatFilters');
            allMeats.forEach(meat => {
                if (meat !== '混合') {
                    const tag = document.createElement('span');
                    tag.className = 'meat-tag';
                    tag.textContent = meat;
                    tag.onclick = () => toggleMeatFilter(meat, tag);
                    tag.style.cssText = `
                        background: #e9ecef; 
                        border: 1px solid #ced4da; 
                        padding: 4px 8px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        cursor: pointer;
                        user-select: none;
                        transition: all 0.2s;
                    `;
                    meatFilters.appendChild(tag);
                }
            });

            // 初始顯示所有食物
            displayFilteredFoods(foodDatabase);
        }

        // 切換肉類篩選
        function toggleMeatFilter(meat, element) {
            const index = currentActiveFilters.meat.indexOf(meat);
            if (index > -1) {
                currentActiveFilters.meat.splice(index, 1);
                element.style.background = '#e9ecef';
                element.style.color = '#495057';
            } else {
                currentActiveFilters.meat.push(meat);
                element.style.background = '#007bff';
                element.style.color = 'white';
            }
            filterFoods();
        }

        // 篩選食物
        function filterFoods() {
            const brandFilter = document.getElementById('brandFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            currentActiveFilters.brand = brandFilter;
            currentActiveFilters.category = categoryFilter;
            currentActiveFilters.search = searchInput;

            let filteredFoods = foodDatabase.filter(food => {
                // 品牌篩選
                if (brandFilter && food.brand !== brandFilter) return false;
                
                // 分類篩選
                if (categoryFilter && food.category !== categoryFilter) return false;
                
                // 肉類篩選
                if (currentActiveFilters.meat.length > 0) {
                    const hasSelectedMeat = currentActiveFilters.meat.some(selectedMeat => 
                        food.meat.includes(selectedMeat)
                    );
                    if (!hasSelectedMeat) return false;
                }
                
                // 關鍵字搜索
                if (searchInput) {
                    const searchText = `${food.name} ${food.brand} ${food.meat.join(' ')}`.toLowerCase();
                    if (!searchText.includes(searchInput)) return false;
                }
                
                return true;
            });

            // 按熱量排序
            filteredFoods.sort((a, b) => a.calories - b.calories);

            displayFilteredFoods(filteredFoods);
        }

        // 顯示篩選結果
        function displayFilteredFoods(foods) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (foods.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">沒有找到符合條件的食物</div>';
                return;
            }

            let html = '';
            foods.slice(0, 20).forEach((food, index) => { // 限制顯示前20項
                const meatText = food.meat.join(', ');
                const calorieColor = getCalorieColor(food.calories);
                
                html += `
                    <div class="search-result-item" onclick="selectFoodFromSearch(${foodDatabase.indexOf(food)})" 
                         style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; hover:background-color: #f8f9fa;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${food.name}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #666;">
                                <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${food.brand}</span>
                                <span style="background: #f0f8f0; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${food.category}</span>
                                <span style="background: #fff3e0; padding: 2px 6px; border-radius: 3px;">${food.texture}</span>
                            </div>
                            <div style="font-weight: bold; color: ${calorieColor};">${food.calories} kcal/100g</div>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">🥩 ${meatText}</div>
                    </div>
                `;
            });

            if (foods.length > 20) {
                html += `<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">還有 ${foods.length - 20} 項食物，請縮小搜索範圍</div>`;
            }

            resultsContainer.innerHTML = html;
        }

        // 從搜索結果選擇食物
        function selectFoodFromSearch(foodIndex) {
            // 找到當前活躍的食物選擇器
            const selectors = document.querySelectorAll('#foodSelectors select');
            let targetSelector = null;
            
            // 找到第一個空的選擇器
            for (let selector of selectors) {
                if (selector.value === '') {
                    targetSelector = selector;
                    break;
                }
            }
            
            // 如果沒有空的選擇器，創建一個新的
            if (!targetSelector) {
                addFoodSelector();
                const newSelectors = document.querySelectorAll('#foodSelectors select');
                targetSelector = newSelectors[newSelectors.length - 1];
            }
            
            // 設置選中的食物
            targetSelector.value = foodIndex;
            
            // 觸發變更事件
            const event = new Event('change');
            targetSelector.dispatchEvent(event);
            
            // 聚焦到對應的重量輸入框
            const selectorIndex = Array.from(selectors).indexOf(targetSelector);
            const gramsInput = document.getElementById(`grams${selectorIndex}`);
            if (gramsInput) {
                gramsInput.focus();
            }
            
            showSyncStatus(`已選擇：${foodDatabase[foodIndex].name}`, 'success');
        }

        // 獲取熱量顏色
        function getCalorieColor(calories) {
            if (calories < 80) return '#28a745';      // 綠色 - 低熱量
            if (calories < 120) return '#ffc107';    // 黃色 - 中等熱量
            if (calories < 200) return '#fd7e14';    // 橙色 - 較高熱量
            return '#dc3545';                        // 紅色 - 高熱量
        }

        // 顯示雲端選項
        function showCloudOptions() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>☁️ 選擇您的雲端存儲方案</h4>
                    <p>為了實現跨平台同步，請選擇一個適合的存儲方案：</p>
                    
                    <div style="margin: 15px 0;">
                        <!-- GitHub Gist 選項 -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>🗂️ GitHub Gist（推薦）</h6>
                            <p>免費、穩定、跨平台，適合技術用戶</p>
                            <button onclick="setupGitHubSync()" style="background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">設置 GitHub 同步</button>
                        </div>
                        
                        <!-- 手動同步選項 -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>📋 手動同步（即時分享）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>裝置A生成連結 → 裝置B掃描/點擊 → 立即合併資料</p>
                            <div style="background: #f8f9fa; padding: 6px; border-radius: 3px; margin: 5px 0; font-size: 11px;">
                                <span style="color: #28a745;">✅ 適合：</span>偶爾同步、臨時分享<br>
                                <span style="color: #007bff;">🔄 資料處理：</span>智能合併，不會覆蓋現有資料<br>
                                <span style="color: #ffc107;">⚠️ 注意：</span>連結有效期短，需即時使用
                            </div>
                            <button onclick="showManualSync()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">手動同步</button>
                        </div>
                        
                        <!-- 文件存儲同步選項 -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>💾 文件存儲（安全備份）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>匯出JSON檔 → 雲端硬碟 → 其他裝置匯入 → 選擇合併或覆蓋</p>
                            <div style="background: #f8f9fa; padding: 6px; border-radius: 3px; margin: 5px 0; font-size: 11px;">
                                <span style="color: #28a745;">✅ 適合：</span>定期備份、完全控制資料<br>
                                <span style="color: #007bff;">🔄 資料處理：</span>您決定是合併還是完全替換<br>
                                <span style="color: #28a745;">🛡️ 安全：</span>檔案在您的雲端硬碟，最私密
                            </div>
                            <button onclick="showFileSync()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">文件同步</button>
                        </div>
                        
                        <!-- 在線剪貼板選項 -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>🔗 在線剪貼板（臨時分享）</h6>
                            <p style="margin: 5px 0; font-size: 13px;">💡 <strong>資料流：</strong>上傳到Pastebin → 取得連結 → 其他裝置載入 → 合併資料</p>
                            <div style="background: #f8f9fa; padding: 6px; border-radius: 3px; margin: 5px 0; font-size: 11px;">
                                <span style="color: #28a745;">✅ 適合：</span>快速分享、無需註冊帳號<br>
                                <span style="color: #007bff;">🔄 資料處理：</span>自動合併，保留雙方資料<br>
                                <span style="color: #dc3545;">⚠️ 隱私：</span>資料暫時公開，敏感資料請勿使用
                            </div>
                            <button onclick="showPastebinSync()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">剪貼板同步</button>
                        </div>
                    </div>
                    
                    <!-- 提示信息 -->
                    <div style="margin: 15px 0; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                        <small><strong>💡 提示：</strong>所有方案都會保持您的數據私密性，建議先試用 GitHub Gist 方案。</small>
                    </div>
                </div>
            `;
            // 顯示雲端設定頁面
            document.querySelector('.cloud-sync-cover').style.display = 'none';
            document.getElementById('cloudOptions').style.display = 'block';
            document.getElementById('cloudOptionsContent').innerHTML = content;
        }

        // GitHub Gist 同步設置
        function setupGitHubSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>🗂️ GitHub Gist 同步設置</h4>
                    <p>GitHub Gist 提供免費、穩定的雲端數據存儲，讓您的貓咪飲食記錄在所有設備間同步。</p>
                    
                    <!-- 快速設置 -->
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                        <h5 style="margin: 0 0 10px 0;">⚡ 快速設置</h5>
                        <p style="margin: 0 0 10px 0;">將您的 GitHub 令牌貼在下面：</p>
                        <input type="password" id="githubToken" placeholder="貼上您的 GitHub 個人訪問令牌" style="width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #007bff; border-radius: 5px;">
                        <button onclick="initGitHubSync()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">🚀 開始使用 GitHub 同步</button>
                        <div id="githubSetupResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <!-- 詳細教學按鈕 -->
                    <div style="text-align: center; margin: 20px 0;">
                        <button onclick="toggleGitHubTutorial()" id="tutorialToggle" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">📋 查看詳細設置教學</button>
                    </div>
                    
                    <!-- 詳細教學內容（預設隱藏）-->
                    <div id="gitHubTutorial" style="display: none;">
                        <div style="border-top: 2px solid #ddd; padding-top: 20px;">
                            <h5>📖 詳細設置教學</h5>
                            
                            <div style="background: #f0f8f0; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h6>步驟 1：準備 GitHub 帳戶</h6>
                                <p>如果您還沒有 GitHub 帳戶：</p>
                                <a href="https://github.com/join" target="_blank" style="background: #333; color: white; padding: 6px 12px; text-decoration: none; border-radius: 3px; font-size: 12px;">註冊 GitHub 帳戶</a>
                            </div>
                            
                            <div style="background: #f0f8f0; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h6>步驟 2：創建訪問令牌</h6>
                                <p style="font-size: 14px; margin-bottom: 15px;">按照以下圖片步驟操作：</p>
                                
                                <!-- 四個步驟的圖片 -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="text-align: center;">
                                        <img src="Create gists token/1.png" alt="步驟1" style="width: 100%; max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">
                                        <p style="font-size: 11px; margin: 5px 0; color: #666;"><strong>① 進入設定頁面</strong><br>點擊「Generate new token」</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <img src="Create gists token/2.png" alt="步驟2" style="width: 100%; max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">
                                        <p style="font-size: 11px; margin: 5px 0; color: #666;"><strong>② 選擇令牌類型</strong><br>選擇「classic」版本</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <img src="Create gists token/3.png" alt="步驟3" style="width: 100%; max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">
                                        <p style="font-size: 11px; margin: 5px 0; color: #666;"><strong>③ 勾選權限</strong><br>只需勾選「gist」</p>
                                    </div>
                                    <div style="text-align: center;">
                                        <img src="Create gists token/4.png" alt="步驟4" style="width: 100%; max-width: 200px; border: 1px solid #ddd; border-radius: 3px;">
                                        <p style="font-size: 11px; margin: 5px 0; color: #666;"><strong>④ 生成令牌</strong><br>點擊「Generate token」</p>
                                    </div>
                                </div>
                                
                                <div style="background: #fff3cd; padding: 8px; border-radius: 3px; margin-top: 15px;">
                                    <p style="font-size: 12px; margin: 0;"><strong>⚠️ 重要：</strong>生成後立即複製令牌，離開頁面後就看不到了！</p>
                                </div>
                                
                                <div style="text-align: center; margin-top: 10px;">
                                    <a href="https://github.com/settings/tokens" target="_blank" style="background: #007bff; color: white; padding: 8px 15px; text-decoration: none; border-radius: 3px; font-size: 12px;">🔗 前往 GitHub 建立令牌</a>
                                </div>
                            </div>
                            
                            <div style="background: #f0f8f0; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <h6>步驟 3：完成設置</h6>
                                <p style="font-size: 12px;">將複製的令牌貼到上方輸入框，點擊「開始使用 GitHub 同步」即可完成設置。</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="showCloudOptions()" class="btn btn-secondary">← 返回其他同步選項</button>
                    </div>
                </div>
            `;
            document.getElementById('cloudOptionsContent').innerHTML = content;
        }

        // 切換教學顯示
        function toggleGitHubTutorial() {
            const tutorial = document.getElementById('gitHubTutorial');
            const toggleBtn = document.getElementById('tutorialToggle');
            
            if (tutorial.style.display === 'none') {
                tutorial.style.display = 'block';
                toggleBtn.textContent = '📋 隱藏詳細教學';
                toggleBtn.style.background = '#6c757d';
            } else {
                tutorial.style.display = 'none';
                toggleBtn.textContent = '📋 查看詳細設置教學';
                toggleBtn.style.background = '#17a2b8';
            }
        }

        // 手動同步
        function showManualSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>📋 手動數據同步（即時分享）</h4>
                    <p style="font-size: 14px; margin-bottom: 15px;">🔄 <strong>資料流程：</strong>裝置A生成分享連結 → 裝置B立即掃描/點擊連結 → 智能合併雙方資料</p>
                    
                    <!-- 資料安全說明 -->
                    <div style="background: #d1ecf1; border: 1px solid #17a2b8; padding: 10px; border-radius: 5px; margin: 15px 0;">
                        <h6 style="color: #0c5460; margin: 0 0 8px 0;">🛡️ 資料安全保證</h6>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: #0c5460;">
                            <li><strong>智能合併：</strong>系統會保留雙方的記錄，不會覆蓋任何現有資料</li>
                            <li><strong>即時有效：</strong>連結僅在生成後短時間內有效，確保安全性</li>
                            <li><strong>不會重複：</strong>相同的記錄不會被重複添加</li>
                            <li><strong>本地處理：</strong>資料在瀏覽器內處理，不上傳到任何伺服器</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📤 步驟1：從此設備分享資料</h6>
                        <p style="font-size: 13px; margin: 5px 0;">將目前的 ${mealHistory ? mealHistory.length : 0} 筆記錄打包成分享連結或QR碼</p>
                        <button onclick="generateShareLink()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">🔗 生成分享連結</button>
                        <button onclick="generateQRCode()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">📱 生成二維碼</button>
                        <p style="font-size: 11px; color: #666; margin: 5px 0;">💡 QR碼適合手機間分享，連結適合電腦間複製貼上</p>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📥 步驟2：載入其他設備的資料</h6>
                        <p style="font-size: 13px; margin: 5px 0;">貼上從其他設備獲得的分享連結</p>
                        <input type="text" id="shareLink" placeholder="貼上分享連結（如：https://yoursite.com#data=...）" style="width: 100%; padding: 8px; margin: 5px 0; font-size: 12px;">
                        <button onclick="loadFromShareLink()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">🔄 載入並合併資料</button>
                        <div style="background: #d4f8d4; padding: 6px; border-radius: 3px; margin: 8px 0; font-size: 11px;">
                            ✅ <strong>安全提醒：</strong>載入的資料會與現有記錄合併，您的原有資料完全不會遺失
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>🎯 使用場景</h6>
                        <ul style="margin: 5px 0; padding-left: 18px; font-size: 12px;">
                            <li><strong>家庭同步：</strong>多人共同照顧貓咪，需要即時同步餵食記錄</li>
                            <li><strong>臨時分享：</strong>偶爾需要與朋友分享貓咪飲食資料</li>
                            <li><strong>設備切換：</strong>從舊手機換到新手機時快速轉移資料</li>
                            <li><strong>緊急備份：</strong>其他同步方法無法使用時的應急選擇</li>
                        </ul>
                    </div>
                    
                    <div id="shareResult" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" class="btn btn-secondary">← 返回其他同步選項</button>
                </div>
            `;
            document.getElementById('cloudOptionsContent').innerHTML = content;
        }

        // 文件同步
        function showFileSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>💾 文件存儲同步（最安全的方法）</h4>
                    <p style="font-size: 14px; margin-bottom: 15px;">📂 <strong>資料流程：</strong>此裝置匯出JSON檔案 → 儲存到您的雲端硬碟 → 其他裝置下載並匯入檔案</p>
                    
                    <!-- 安全說明 -->
                    <div style="background: #d4f8d4; border: 1px solid #28a745; padding: 10px; border-radius: 5px; margin: 15px 0;">
                        <h6 style="color: #155724; margin: 0 0 8px 0;">🛡️ 資料安全保證</h6>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: #155724;">
                            <li>檔案只保存在您的雲端硬碟，完全私密</li>
                            <li>匯入時您可選擇「合併」或「替換」現有資料</li>
                            <li>合併：保留雙方資料，不會遺失任何記錄</li>
                            <li>替換：清除當前資料，完全使用檔案內容</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📤 步驟1：匯出當前資料</h6>
                        <p style="font-size: 13px; margin: 5px 0;">將目前的 ${mealHistory ? mealHistory.length : 0} 筆記錄下載為JSON檔案</p>
                        <button onclick="exportLocalData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">📥 下載數據文件</button>
                        <p style="font-size: 11px; color: #666; margin: 5px 0;">💡 檔案會自動命名為：貓咪食物追蹤數據-日期.json</p>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📥 步驟2：匯入其他裝置的資料</h6>
                        <p style="font-size: 13px; margin: 5px 0;">選擇從其他裝置匯出的JSON檔案</p>
                        <input type="file" id="importFile" accept=".json" style="margin: 5px 0; font-size: 12px;">
                        <button onclick="importFromFile()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">📤 載入文件</button>
                        <div style="background: #fff3cd; padding: 6px; border-radius: 3px; margin: 8px 0; font-size: 11px;">
                            ⚠️ <strong>匯入前確認：</strong>系統會詢問您要「合併」或「替換」資料，請根據需要選擇
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📋 推薦工作流程</h6>
                        <ol style="margin: 5px 0; padding-left: 18px; font-size: 12px;">
                            <li><strong>定期備份：</strong>每週匯出檔案到雲端硬碟（Dropbox/OneDrive/iCloud）</li>
                            <li><strong>跨裝置同步：</strong>在A裝置匯出 → 雲端硬碟 → B裝置下載匯入</li>
                            <li><strong>檔案管理：</strong>建議用日期命名檔案，如：貓咪食物-2024-01-15.json</li>
                            <li><strong>安全原則：</strong>匯入前先匯出當前資料作為備份</li>
                        </ol>
                    </div>
                    
                    <button onclick="showCloudOptions()" class="btn btn-secondary">← 返回其他同步選項</button>
                </div>
            `;
            document.getElementById('cloudOptionsContent').innerHTML = content;
        }

        // 在線剪貼板同步
        function showPastebinSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>🔗 在線剪貼板同步（快速分享）</h4>
                    <p style="font-size: 14px; margin-bottom: 15px;">📡 <strong>資料流程：</strong>此裝置上傳到Pastebin → 獲得公開連結 → 其他裝置用連結載入資料</p>
                    
                    <!-- 隱私警告 -->
                    <div style="background: #f8d7da; border: 1px solid #dc3545; padding: 10px; border-radius: 5px; margin: 15px 0;">
                        <h6 style="color: #721c24; margin: 0 0 8px 0;">⚠️ 重要隱私提醒</h6>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: #721c24;">
                            <li><strong>資料會暫時公開</strong>：任何人都可能看到您的飲食記錄</li>
                            <li><strong>建議用途</strong>：僅用於快速分享，不含敏感資訊時使用</li>
                            <li><strong>資料處理</strong>：載入時會與現有資料合併，不會覆蓋</li>
                            <li><strong>有效期限</strong>：Pastebin連結會在一段時間後自動刪除</li>
                        </ul>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📤 步驟1：上傳資料到剪貼板</h6>
                        <p style="font-size: 13px; margin: 5px 0;">將目前的 ${mealHistory ? mealHistory.length : 0} 筆記錄上傳到公開剪貼板</p>
                        <button onclick="uploadToPastebin()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">🌐 上傳到 Pastebin</button>
                        <p style="font-size: 11px; color: #666; margin: 5px 0;">💡 上傳後會獲得一個公開連結，請立即分享給其他裝置</p>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📥 步驟2：從剪貼板載入資料</h6>
                        <p style="font-size: 13px; margin: 5px 0;">貼上從其他裝置獲得的Pastebin連結</p>
                        <input type="text" id="pastebinUrl" placeholder="貼上 Pastebin 連結（如：https://pastebin.com/xxxxxxxx）" style="width: 100%; padding: 8px; margin: 5px 0; font-size: 12px;">
                        <button onclick="loadFromPastebin()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">📥 載入數據</button>
                        <div style="background: #d1ecf1; padding: 6px; border-radius: 3px; margin: 8px 0; font-size: 11px;">
                            ℹ️ <strong>安全提醒：</strong>載入的資料會與現有記錄合併，不會刪除您當前的資料
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>🎯 適用場景</h6>
                        <ul style="margin: 5px 0; padding-left: 18px; font-size: 12px;">
                            <li>✅ <strong>臨時分享：</strong>快速傳送幾筆記錄給朋友參考</li>
                            <li>✅ <strong>緊急備份：</strong>無法使用其他方法時的應急選項</li>
                            <li>✅ <strong>測試用途：</strong>測試資料同步功能</li>
                            <li>❌ <strong>不適合：</strong>長期儲存、大量資料、隱私要求高的情況</li>
                        </ul>
                    </div>
                    
                    <div id="pastebinResult" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" class="btn btn-secondary">← 返回其他同步選項</button>
                </div>
            `;
            document.getElementById('cloudOptionsContent').innerHTML = content;
        }

        // 匯出本地數據
        function exportLocalData() {
            try {
                const dataToExport = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    source: 'local_storage',
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null,
                        exportedFrom: window.location.href
                    }
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `貓咪食物追蹤數據-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSyncStatus(`已匯出 ${mealHistory.length} 筆記錄到檔案`, 'success');
                
            } catch (error) {
                console.error('匯出數據失敗:', error);
                showSyncStatus('匯出失敗: ' + error.message, 'error');
            }
        }

        // 匯入文件數據
        function importFromFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                showSyncStatus('請選擇一個 JSON 文件', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // 驗證數據格式
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        throw new Error('文件格式不正確：缺少有效的數據陣列');
                    }
                    
                    // 詢問用戶如何處理現有數據
                    let mergeChoice = 'replace';
                    if (mealHistory.length > 0) {
                        mergeChoice = confirm(
                            `您當前有 ${mealHistory.length} 筆記錄。\n\n` +
                            `點擊「確定」：合併數據（保留兩邊的記錄）\n` +
                            `點擊「取消」：替換數據（清除現有記錄）`
                        ) ? 'merge' : 'replace';
                    }
                    
                    if (mergeChoice === 'merge') {
                        // 合併數據
                        const mergedData = mergeDataArrays(mealHistory, importedData.data);
                        mealHistory = mergedData;
                        showSyncStatus(`已成功合併 ${importedData.data.length} 筆新記錄`, 'success');
                    } else {
                        // 替換數據
                        mealHistory = importedData.data;
                        showSyncStatus(`已載入 ${importedData.data.length} 筆記錄`, 'success');
                    }
                    
                    // 更新顯示
                    saveHistoryToStorage();
                    displayHistory();
                    updateChart();
                    
                } catch (error) {
                    console.error('匯入文件失敗:', error);
                    showSyncStatus('文件匯入失敗: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // 生成分享連結 (使用 Base64 編碼)
        function generateShareLink() {
            try {
                const dataToShare = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: mealHistory
                };
                
                const encodedData = btoa(encodeURIComponent(JSON.stringify(dataToShare)));
                const shareUrl = `${window.location.origin}${window.location.pathname}#data=${encodedData}`;
                
                // 複製到剪貼板
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        document.getElementById('shareResult').innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                <h6>✅ 分享連結已生成並複製到剪貼板</h6>
                                <p style="word-break: break-all; font-size: 12px;">${shareUrl}</p>
                                <p><strong>使用方法：</strong>在其他設備上開啟此連結，數據會自動載入。</p>
                            </div>
                        `;
                    });
                } else {
                    // 手動複製
                    document.getElementById('shareResult').innerHTML = `
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                            <h6>✅ 分享連結已生成</h6>
                            <textarea readonly style="width: 100%; height: 60px; font-size: 12px;">${shareUrl}</textarea>
                            <p><strong>使用方法：</strong>複製上方連結，在其他設備上開啟，數據會自動載入。</p>
                        </div>
                    `;
                }
                
                showSyncStatus(`已生成包含 ${mealHistory.length} 筆記錄的分享連結`, 'success');
                
            } catch (error) {
                console.error('生成分享連結失敗:', error);
                showSyncStatus('分享連結生成失敗: ' + error.message, 'error');
            }
        }

        // 檢查 URL 中的分享數據
        function checkForSharedData() {
            const hash = window.location.hash;
            if (hash.startsWith('#data=')) {
                try {
                    const encodedData = hash.substring(6);
                    const decodedData = JSON.parse(decodeURIComponent(atob(encodedData)));
                    
                    if (decodedData.data && Array.isArray(decodedData.data)) {
                        // 詢問用戶是否載入分享的數據
                        if (confirm(`檢測到分享的數據（${decodedData.data.length} 筆記錄）。\n\n是否載入這些數據？\n\n點擊「確定」載入，「取消」忽略。`)) {
                            mealHistory = decodedData.data;
                            saveHistoryToStorage();
                            displayHistory();
                            updateChart();
                            showSyncStatus(`已載入分享的 ${decodedData.data.length} 筆記錄`, 'success');
                            
                            // 清除 URL 中的數據
                            window.location.hash = '';
                        }
                    }
                } catch (error) {
                    console.error('載入分享數據失敗:', error);
                    showSyncStatus('載入分享數據失敗: ' + error.message, 'error');
                }
            }
        }

        // GitHub 同步相關變數
        let githubToken = '';
        let githubGistId = '';
        let isGitHubSyncEnabled = false;

        // 初始化 GitHub 同步
        function initGitHubSync() {
            console.log('initGitHubSync 被調用');
            
            const tokenInput = document.getElementById('githubToken');
            const resultDiv = document.getElementById('githubSetupResult');
            
            console.log('tokenInput:', tokenInput);
            console.log('resultDiv:', resultDiv);
            
            if (!tokenInput) {
                console.error('找不到 githubToken 輸入框');
                alert('找不到令牌輸入框，請重新打開設置頁面');
                return;
            }
            
            if (!resultDiv) {
                console.error('找不到 githubSetupResult 結果區域');
                alert('找不到結果顯示區域，請重新打開設置頁面');
                return;
            }
            
            const token = tokenInput.value.trim();
            console.log('輸入的令牌長度:', token.length);
            
            if (!token) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">❌ 請輸入 GitHub 個人訪問令牌</div>';
                showSyncStatus('請輸入 GitHub 個人訪問令牌', 'error');
                return;
            }

            // 顯示正在驗證狀態
            resultDiv.innerHTML = '<div style="background: #d1ecf1; padding: 10px; border-radius: 5px; color: #0c5460;">🔄 正在驗證 GitHub 令牌...</div>';

            githubToken = token;
            localStorage.setItem('github_token', token);
            
            // 測試令牌有效性
            testGitHubToken();
        }

        // 測試 GitHub 令牌
        async function testGitHubToken() {
            const resultDiv = document.getElementById('githubSetupResult');
            
            try {
                showSyncStatus('正在驗證 GitHub 令牌...', 'success');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // 更新設置頁面的結果顯示
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                ✅ GitHub 連接成功！<br>
                                歡迎用戶: <strong>${user.login}</strong><br>
                                <small>正在設置同步界面...</small>
                            </div>
                        `;
                    }
                    
                    showSyncStatus(`GitHub 連接成功！歡迎 ${user.login}`, 'success');
                    
                    // 短暫延遲後設置界面
                    setTimeout(() => {
                        setupGitHubInterface(user);
                    }, 1000);
                } else {
                    throw new Error(`HTTP ${response.status}: 令牌無效或權限不足`);
                }
            } catch (error) {
                console.error('GitHub 令牌驗證失敗:', error);
                
                // 更新設置頁面的錯誤顯示
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                            ❌ 驗證失敗: ${error.message}<br>
                            <small>請檢查令牌是否正確，且具有 'gist' 權限</small>
                        </div>
                    `;
                }
                
                showSyncStatus('GitHub 令牌驗證失敗: ' + error.message, 'error');
            }
        }

        // 設置 GitHub 同步界面
        async function setupGitHubInterface(user) {
            isGitHubSyncEnabled = true;
            let savedGistId = localStorage.getItem('github_gist_id');
            
            // 如果沒有保存的 Gist ID，嘗試搜尋現有的貓咪飲食追蹤 Gist
            if (!savedGistId) {
                try {
                    const existingGist = await findExistingFoodTrackingGist();
                    if (existingGist) {
                        savedGistId = existingGist.id;
                        githubGistId = existingGist.id;
                        localStorage.setItem('github_gist_id', existingGist.id);
                        console.log('找到現有的貓咪飲食追蹤 Gist:', existingGist.id);
                        
                        // 自動載入現有資料
                        await loadFromGitHubSilently();
                        if (mealHistory.length > 0) {
                            dataSource = 'github';
                            showSyncStatus(`已自動載入現有的 ${mealHistory.length} 筆記錄`, 'success');
                            displayHistory();
                            updateDataSourceDisplay();
                        }
                    }
                } catch (error) {
                    console.warn('搜尋現有 Gist 時發生錯誤:', error);
                }
            }
            
            const content = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px;">
                    <h4>✅ GitHub 同步已啟用</h4>
                    <p>已連接到 GitHub 用戶: <strong>${user.login}</strong></p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>📊 同步狀態</h6>
                        <p>Gist ID: ${savedGistId || '尚未創建'}</p>
                        <p>當前數據: ${mealHistory.length} 筆記錄</p>
                        ${savedGistId ? '<p style="color: #28a745;">✅ 已連接到跨裝置共用資料</p>' : '<p style="color: #ffc107;">⚠️ 將在首次保存時建立新的共用資料</p>'}
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <button onclick="saveToGitHub()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">保存到 GitHub</button>
                        <button onclick="loadFromGitHub()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">從 GitHub 載入</button>
                        <button onclick="enableGitHubAutoSync()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">啟用自動同步</button>
                        <button onclick="disconnectGitHub()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">斷開連接</button>
                    </div>
                    
                    <div id="githubSyncStatus" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" class="btn btn-secondary">返回選項</button>
                </div>
            `;
            document.getElementById('cloudOptionsContent').innerHTML = content;
            
            // 設置 Gist ID
            if (savedGistId) {
                githubGistId = savedGistId;
            }
        }

        // 搜尋現有的貓咪飲食追蹤 Gist
        async function findExistingFoodTrackingGist() {
            if (!githubToken) {
                return null;
            }

            try {
                // 獲取用戶的所有 Gist
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    console.warn('無法獲取 Gist 列表:', response.status);
                    return null;
                }

                const gists = await response.json();
                console.log(`找到 ${gists.length} 個 Gist`);

                // 搜尋包含貓咪飲食追蹤資料的 Gist
                for (const gist of gists) {
                    // 檢查描述是否包含相關關鍵字
                    if (gist.description && gist.description.includes('貓咪飲食追蹤')) {
                        console.log('根據描述找到可能的 Gist:', gist.id);
                        return gist;
                    }

                    // 檢查是否包含我們的標準檔案名
                    if (gist.files && gist.files['cat-food-data.json']) {
                        console.log('根據檔案名找到可能的 Gist:', gist.id);
                        
                        // 進一步驗證檔案內容是否為我們的格式
                        try {
                            const fileResponse = await fetch(gist.files['cat-food-data.json'].raw_url);
                            if (fileResponse.ok) {
                                const content = await fileResponse.text();
                                const data = JSON.parse(content);
                                
                                // 檢查是否為我們的資料格式
                                if (data.data && Array.isArray(data.data) && data.version) {
                                    console.log('確認為貓咪飲食追蹤資料:', gist.id);
                                    return gist;
                                }
                            }
                        } catch (error) {
                            console.warn('檢查 Gist 內容時發生錯誤:', error);
                            continue;
                        }
                    }
                }

                console.log('未找到現有的貓咪飲食追蹤 Gist');
                return null;

            } catch (error) {
                console.error('搜尋現有 Gist 時發生錯誤:', error);
                return null;
            }
        }

        // 保存數據到 GitHub Gist
        async function saveToGitHub() {
            if (!githubToken) {
                showSyncStatus('GitHub 尚未連接', 'error');
                return;
            }

            try {
                // 只在有界面元素時更新狀態
                const statusElement = document.getElementById('githubSyncStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<p>🔄 正在保存到 GitHub...</p>';
                }
                
                const dataToSave = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null
                    }
                };

                const gistData = {
                    description: `貓咪飲食追蹤數據 - ${new Date().toLocaleDateString()}`,
                    public: false,
                    files: {
                        'cat-food-data.json': {
                            content: JSON.stringify(dataToSave, null, 2)
                        }
                    }
                };

                let response;
                if (githubGistId) {
                    // 更新現有 Gist
                    response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                } else {
                    // 創建新 Gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    githubGistId = result.id;
                    localStorage.setItem('github_gist_id', githubGistId);
                    
                    // 只在有界面元素時更新狀態
                    const statusElement = document.getElementById('githubSyncStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                ✅ 已成功保存 ${mealHistory.length} 筆記錄到 GitHub<br>
                                <small>Gist ID: ${githubGistId}</small>
                            </div>
                        `;
                    }
                    showSyncStatus('數據已成功保存到 GitHub Gist', 'success');
                } else {
                    throw new Error(`保存失敗: ${response.status}`);
                }

            } catch (error) {
                console.error('保存到 GitHub 失敗:', error);
                
                // 只在有界面元素時更新狀態
                const statusElement = document.getElementById('githubSyncStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                            ❌ 保存失敗: ${error.message}
                        </div>
                    `;
                }
                showSyncStatus('GitHub 保存失敗: ' + error.message, 'error');
                throw error; // 重新拋出錯誤供自動同步捕獲
            }
        }

        // 從 GitHub Gist 載入數據（靜默版本，用於自動初始化）
        async function loadFromGitHubSilently() {
            if (!githubToken || !githubGistId) {
                throw new Error('GitHub 令牌或 Gist ID 不存在');
            }

            const response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const gist = await response.json();
            const fileContent = gist.files['cat-food-data.json'].content;
            const importedData = JSON.parse(fileContent);
            
            if (!importedData.data || !Array.isArray(importedData.data)) {
                throw new Error('GitHub 數據格式不正確');
            }

            // 直接使用 GitHub 數據，不詢問用戶
            mealHistory = importedData.data;
            saveHistoryToStorage(); // 同步到本地存儲
            
            return mealHistory;
        }

        // 從 GitHub Gist 載入數據（用戶手動操作版本）
        async function loadFromGitHub() {
            if (!githubToken || !githubGistId) {
                showSyncStatus('請先保存數據到 GitHub 或確認 Gist ID', 'error');
                return;
            }

            try {
                document.getElementById('githubSyncStatus').innerHTML = '<p>🔄 正在從 GitHub 載入...</p>';
                
                const response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const fileContent = gist.files['cat-food-data.json'].content;
                    const importedData = JSON.parse(fileContent);
                    
                    if (importedData.data && Array.isArray(importedData.data)) {
                        // 直接使用 GitHub 數據替換本地數據
                        mealHistory = importedData.data;
                        
                        // 更新顯示
                        saveHistoryToStorage();
                        displayHistory();
                        updateChart();
                        
                        document.getElementById('githubSyncStatus').innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                ✅ 已成功載入 ${importedData.data.length} 筆記錄
                            </div>
                        `;
                        showSyncStatus('數據已成功從 GitHub 載入', 'success');
                    } else {
                        throw new Error('GitHub 數據格式不正確');
                    }
                } else {
                    throw new Error(`載入失敗: ${response.status}`);
                }

            } catch (error) {
                console.error('從 GitHub 載入失敗:', error);
                document.getElementById('githubSyncStatus').innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                        ❌ 載入失敗: ${error.message}
                    </div>
                `;
                showSyncStatus('GitHub 載入失敗: ' + error.message, 'error');
            }
        }

        // 斷開 GitHub 連接
        function disconnectGitHub() {
            if (confirm('確定要斷開 GitHub 連接嗎？')) {
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_gist_id');
                githubToken = '';
                githubGistId = '';
                isGitHubSyncEnabled = false;
                showCloudOptions();
                showSyncStatus('已斷開 GitHub 連接', 'success');
            }
        }

        // 初始化 GitHub 並自動載入數據
        async function initializeWithGitHub() {
            const savedToken = localStorage.getItem('github_token');
            const savedGistId = localStorage.getItem('github_gist_id');
            
            if (savedToken && savedGistId) {
                githubToken = savedToken;
                githubGistId = savedGistId;
                
                try {
                    console.log('嘗試從 GitHub 自動載入數據...');
                    showSyncStatus('正在從 GitHub 載入最新數據...', 'success');
                    
                    await loadFromGitHubSilently();
                    
                    if (mealHistory.length > 0) {
                        console.log(`成功從 GitHub 載入 ${mealHistory.length} 筆記錄`);
                        dataSource = 'github';
                        showSyncStatus(`已從 GitHub 載入 ${mealHistory.length} 筆記錄`, 'success');
                        displayHistory();
                        updateDataSourceDisplay();
                        return;
                    }
                } catch (error) {
                    console.warn('從 GitHub 載入失敗:', error);
                    showSyncStatus('GitHub 載入失敗，使用本地數據', 'error');
                }
            } else if (savedToken) {
                githubToken = savedToken;
                console.log('有 GitHub 令牌但沒有 Gist ID，等待用戶手動設置');
            }
        }
        
        // 檢查已保存的 GitHub 設定（保留舊函數供其他地方使用）
        function checkSavedGitHubSettings() {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                githubToken = savedToken;
                githubGistId = localStorage.getItem('github_gist_id') || '';
            }
        }

        // 在 window 對象上暴露調試函數供手動調用
        window.debugGoogleAPI = debugGoogleAPI;
        window.testGoogleAPI = testGoogleAPI;
        window.tryIncognitoMode = tryIncognitoMode;
        window.showFixGuide = showFixGuide;
        window.exportLocalData = exportLocalData;
        window.importFromFile = importFromFile;
        window.generateShareLink = generateShareLink;
        window.showCloudOptions = showCloudOptions;
        window.setupGitHubSync = setupGitHubSync;
        window.showManualSync = showManualSync;
        window.showFileSync = showFileSync;
        window.showPastebinSync = showPastebinSync;
        window.initGitHubSync = initGitHubSync;
        window.saveToGitHub = saveToGitHub;
        window.loadFromGitHub = loadFromGitHub;
        window.disconnectGitHub = disconnectGitHub;

        // 頁面載入時初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>