<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貓咪飲食追蹤器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .food-selector {
            margin-bottom: 15px;
        }
        
        select, input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .remove-btn {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .remove-btn:hover {
            background: #c0392b;
        }
        
        .selected-food {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .food-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-calories {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .date-calories {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .meal-detail {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        
        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .edit-btn:hover {
            background: #e67e22;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .edit-form {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .edit-form h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .food-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .google-auth-loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        
        .google-auth-error {
            color: #e74c3c;
            background: #fdf2f2;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        
        .google-auth-error h4 {
            margin: 0 0 10px 0;
        }
        
        .google-auth-error ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .retry-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background: #2980b9;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://apis.google.com/js/api.js" onerror="handleScriptError('gapi')"></script>
    <script src="https://accounts.google.com/gsi/client" onerror="handleScriptError('gsi')"></script>
    <script>
        // 腳本載入錯誤處理
        let scriptErrors = [];
        function handleScriptError(scriptType) {
            scriptErrors.push(scriptType);
            console.error(`${scriptType} 腳本載入失敗`);
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>🐱 貓咪飲食追蹤器</h1>
        
        <div id="syncStatus" class="sync-status" style="display: none;"></div>
        
        <div class="card">
            <h2>Google Drive 同步</h2>
            <div id="googleAuth" style="display: none;">
                <div id="authSection">
                    <button id="authorizeButton" onclick="handleAuthClick()">使用 Google 登入</button>
                    <button id="signoutButton" onclick="handleSignoutClick()" style="display: none;">登出</button>
                </div>
                <div id="userInfo" style="display: none; margin: 10px 0;">
                    <span id="userEmail"></span>
                </div>
                <div id="syncControls" style="display: none;">
                    <button onclick="saveToGoogleDrive()" style="background: #27ae60;">保存到 Google Drive</button>
                    <button onclick="showGooglePicker()" style="background: #f39c12;">從 Google Drive 載入</button>
                    <label>
                        <input type="checkbox" id="autoSync" onchange="toggleAutoSync()">
                        自動同步
                    </label>
                </div>
            </div>
            <div id="loadingAuth" class="google-auth-loading">
                <p>正在載入 Google API...</p>
                <small>如果載入時間過長，請檢查網路連線或重新整理頁面</small>
            </div>
            <div id="fallbackAuth" style="display: none;">
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px;">
                    <h4>⚠️ Google API 載入問題</h4>
                    <p><strong>說明：</strong>每個用戶使用自己的 Google 帳號登入，數據保存在自己的 Google Drive 中。</p>
                    <p>如果此訊息持續顯示，可能的原因：</p>
                    <ul>
                        <li>網路連線問題或 DNS 解析失敗</li>
                        <li>廣告攔截器阻擋了 Google API (如 uBlock Origin、AdBlock)</li>
                        <li>瀏覽器禁用了 JavaScript 或第三方腳本</li>
                        <li>公司/學校網路阻擋了 Google 服務</li>
                        <li>VPN 或代理伺服器影響</li>
                    </ul>
                    <div style="margin: 15px 0;">
                        <button onclick="location.reload()" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px;">重新載入</button>
                        <button onclick="testGoogleAPI()" style="background: #e67e22; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px;">詳細測試</button>
                        <button onclick="tryIncognitoMode()" style="background: #9b59b6; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px;">無痕模式</button>
                        <button onclick="showFixGuide()" style="background: #f39c12; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px;">修復指南</button>
                        <button onclick="enableOfflineMode()" style="background: #27ae60; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; margin: 2px; font-size: 12px;">本地模式</button>
                    </div>
                    <div id="testResults" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>新增餐點記錄</h2>
            <div id="foodSelectors">
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="重量 (克)" step="0.1" min="0">
                </div>
            </div>
            <button onclick="addFoodSelector()">+ 新增食物</button>
            <div id="feedingSummary" style="display: none;">
                <div class="total-calories">
                    總餵食: <span id="totalFeedGrams">0</span>g | 總卡路里: <span id="totalCalories">0</span> kcal
                </div>
                <input type="number" id="actualEatenGrams" placeholder="實際吃了多少克" step="0.1" min="0">
                <div id="actualCalories" class="total-calories" style="display: none; background: #e74c3c;">
                    實際攝取: <span id="actualCaloriesValue">0</span> kcal
                </div>
            </div>
            <button onclick="saveMeal()" id="saveMealBtn" style="display: none;">儲存這餐</button>
            <button onclick="cancelEdit()" id="cancelEditBtn" style="display: none; background: #95a5a6; margin-top: 10px;">取消編輯</button>
        </div>
        
        <div class="card">
            <h2>卡路里趨勢圖</h2>
            <div class="chart-container">
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>飲食記錄</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // Google API 配置
        const GOOGLE_CONFIG = {
            CLIENT_ID: '688115592260-jakdnknejup5fnouuak9hm13fj7vj2ti.apps.googleusercontent.com',
            API_KEY: 'AIzaSyACXGZQadACb5ZCFsS_1nnafeX4Wzcv8Tk',
            DISCOVERY_DOC: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
            SCOPES: 'https://www.googleapis.com/auth/drive.file',
            APP_FOLDER_NAME: 'CatFoodTracker'
        };

        // Google API 相關變數
        let gapi;
        let google;
        let tokenClient;
        let isGoogleApiLoaded = false;
        let isAuthorized = false;
        let autoSyncEnabled = false;
        let appFolderId = null;

        // 貓糧資料庫
        const foodDatabase = [
            {name: "catdives 貓爾地夫 全齡貓營養升級 魩仔魚+板腱牛+雞胸肉", calories: 100.2},
            {name: "catdives 貓爾地夫 全齡貓營養升級 魩仔魚+鮪魚+雞胸肉", calories: 97.9},
            {name: "catdives 貓爾地夫 經典回味 嚴選羊雞胸肉", calories: 102.8},
            {name: "catdives 貓爾地夫 經典回味 板腱牛雞胸肉", calories: 107.9},
            {name: "catdives 貓爾地夫 經典回味 雞胸肉", calories: 100.3},
            {name: "catdives 貓爾地夫 經典回味 鮪魚雞胸肉", calories: 97.3},
            {name: "catdives 貓爾地夫 頂級享受 嚴選鹿", calories: 84.7},
            {name: "catdives 貓爾地夫 頂級享受 菲力牛", calories: 95.3},
            {name: "Dog Cat Star 汪喵星球 冷凍乾燥生食-櫻桃鴨", calories: 480},
            {name: "Dr. Wish 雞肉+鮪魚+牛磺酸", calories: 39},
            {name: "Dr. Wish 鮪魚+果寡糖", calories: 34},
            {name: "Dr. Wish 鮪魚+維他命A", calories: 34},
            {name: "Dr. Wish 鮪魚+雞肉+維他命B群", calories: 32},
            {name: "K9 Natural 無穀牛", calories: 112.3},
            {name: "K9 Natural 無穀牛+鱈魚", calories: 94.5},
            {name: "K9 Natural 無穀羊", calories: 121.1},
            {name: "K9 Natural 無穀羊+鮭魚", calories: 106},
            {name: "K9 Natural 無穀雞", calories: 101.3},
            {name: "K9 Natural 無穀雞+鹿", calories: 86.2},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶燉雞", calories: 127.5},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶虱目魚", calories: 127.5},
            {name: "Lady Flavor 好味小姐 1+1 幼母貓 厚奶鱸魚", calories: 126.5},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-原野牛腿", calories: 124.2},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-白蝦干貝", calories: 103.7},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-肥美鯖魚", calories: 114.4},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-野味火雞", calories: 118.1},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-香嫩鴨胸", calories: 117.3},
            {name: "Lady Flavor 好味小姐 1+1滴雞精-鮮香鰹魚", calories: 120.6},
            {name: "Lady Flavor 好味小姐 1+1益生菌 四種魚｜白肉", calories: 123.2},
            {name: "Lady Flavor 好味小姐 1+1益生菌 四種魚｜紅肉", calories: 117.8},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合海陸", calories: 117.8},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合蝦貝", calories: 116.3},
            {name: "Lady Flavor 好味小姐 1+1益生菌 綜合野味", calories: 117.8},
            {name: "Lady Flavor 好味小姐 1+1益生菌 雞肉莓果", calories: 115.1},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 慢燉鮮魚", calories: 112.1},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 濃湯牛腿", calories: 112.1},
            {name: "Lady Flavor 好味小姐 1+1貓鮮食 白醬嫩雞", calories: 100.1},
            {name: "LitoMON 怪獸部落 98%鮮肉-雞肉", calories: 415},
            {name: "MAC's 馬克 幼貓-火雞肉+兔肉", calories: 98},
            {name: "MAC's 馬克 火雞肉+火雞心", calories: 89},
            {name: "MAC's 馬克 羊肉", calories: 90},
            {name: "MAC's 馬克 羊肉+火雞肉", calories: 98},
            {name: "MAC's 馬克 雞肉+雞心", calories: 111},
            {name: "MAC's 馬克 鮭魚+雞肉", calories: 98},
            {name: "MAC's 馬克 鴨肉+火雞肉+雞肉", calories: 101},
            {name: "Meow Servant 喵皇奴 純雞肉", calories: 114},
            {name: "Meow Servant 喵皇奴 雞肉+牛肉", calories: 120},
            {name: "Meow Servant 喵皇奴 鮭魚+雞肉", calories: 121},
            {name: "Meow Servant 喵皇奴 鵪鶉+雞肉", calories: 115},
            {name: "Orijen 歐睿健 幼貓鮮雞", calories: 412},
            {name: "ROYAL CANIN 皇家 K36 幼貓專用", calories: 370},
            {name: "ROYAL CANIN 皇家 LP34 泌尿道配方乾糧", calories: 387.2},
            {name: "ROYAL CANIN 皇家 S33W 腸胃保健", calories: 78.8},
            {name: "ROYAL CANIN 皇家 幼貓", calories: 80.6},
            {name: "ZIWIPeak 巔峰 雞肉", calories: 550}
        ];

        let foodSelectorCount = 1;
        let currentMeal = [];
        let mealHistory = [];
        let chart = null;
        let editingMealIndex = -1;

        // 初始化
        function init() {
            populateFoodSelect('foodSelect0');
            loadHistoryFromStorage();
            updateChart();
            
            // 綁定事件
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            // 初始化 Google API（使用超時處理）
            initializeGoogleAPI();
            
            // 設定後備超時機制
            setTimeout(() => {
                if (!isGoogleApiLoaded) {
                    showFallbackAuth();
                    // 再等 5 秒，如果用戶沒有採取行動就自動啟用本地模式
                    setTimeout(() => {
                        if (!isGoogleApiLoaded) {
                            console.log('自動啟用本地模式');
                            enableOfflineMode();
                        }
                    }, 5000);
                }
            }, 15000); // 15秒後如果還沒載入完成，顯示後備選項
        }

        // 填充食物選項
        function populateFoodSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">選擇食物...</option>';
            
            foodDatabase.forEach((food, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = food.name;
                select.appendChild(option);
            });
            
            select.addEventListener('change', calculateCalories);
        }

        // 新增食物選擇器
        function addFoodSelector() {
            const container = document.getElementById('foodSelectors');
            const newSelector = document.createElement('div');
            newSelector.className = 'food-selector';
            newSelector.innerHTML = `
                <select id="foodSelect${foodSelectorCount}">
                    <option value="">選擇食物...</option>
                </select>
                <input type="number" id="grams${foodSelectorCount}" placeholder="重量 (克)" step="0.1" min="0">
                <button type="button" class="remove-btn" onclick="removeFoodSelector(this)">移除</button>
            `;
            
            container.appendChild(newSelector);
            populateFoodSelect(`foodSelect${foodSelectorCount}`);
            
            document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
            
            foodSelectorCount++;
        }

        // 移除食物選擇器
        function removeFoodSelector(button) {
            button.parentElement.remove();
            calculateCalories();
        }

        // 計算卡路里
        function calculateCalories() {
            const selectors = document.querySelectorAll('.food-selector');
            let totalFeedCalories = 0;
            let totalFeedGrams = 0;
            currentMeal = [];

            selectors.forEach((selector, index) => {
                const foodSelect = selector.querySelector('select');
                const gramsInput = selector.querySelector('input[type="number"]');
                
                const foodIndex = foodSelect.value;
                const grams = parseFloat(gramsInput.value) || 0;
                
                if (foodIndex !== '' && grams > 0) {
                    const food = foodDatabase[foodIndex];
                    const calories = (food.calories * grams / 100);  // 每100g的卡路里
                    totalFeedCalories += calories;
                    totalFeedGrams += grams;
                    
                    currentMeal.push({
                        name: food.name,
                        feedGrams: grams,
                        caloriesPerGram: food.calories / 100
                    });
                }
            });

            const summaryElement = document.getElementById('feedingSummary');
            const saveBtn = document.getElementById('saveMealBtn');
            
            if (totalFeedGrams > 0) {
                document.getElementById('totalFeedGrams').textContent = totalFeedGrams.toFixed(1);
                document.getElementById('totalCalories').textContent = totalFeedCalories.toFixed(1);
                summaryElement.style.display = 'block';
                
                // 綁定實際吃了多少的計算
                const actualEatenInput = document.getElementById('actualEatenGrams');
                actualEatenInput.oninput = function() {
                    calculateActualCalories(totalFeedCalories, totalFeedGrams);
                };
                
                saveBtn.style.display = 'block';
            } else {
                summaryElement.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }

        // 計算實際攝取卡路里
        function calculateActualCalories(totalFeedCalories, totalFeedGrams) {
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value) || 0;
            
            if (actualEatenGrams > 0) {
                // 按比例計算實際攝取的卡路里
                const ratio = actualEatenGrams / totalFeedGrams;
                const actualCalories = totalFeedCalories * ratio;
                
                document.getElementById('actualCaloriesValue').textContent = actualCalories.toFixed(1);
                document.getElementById('actualCalories').style.display = 'block';
                
                // 更新 currentMeal 資料
                currentMeal.forEach(food => {
                    food.actualGrams = food.feedGrams * ratio;
                    food.actualCalories = food.caloriesPerGram * food.actualGrams;
                });
                
                return actualCalories;
            } else {
                document.getElementById('actualCalories').style.display = 'none';
                return 0;
            }
        }

        // 儲存餐點
        function saveMeal() {
            if (currentMeal.length === 0) return;
            
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value);
            if (!actualEatenGrams || actualEatenGrams <= 0) {
                alert('請輸入實際吃了多少克');
                return;
            }
            
            const totalFeedGrams = currentMeal.reduce((sum, food) => sum + food.feedGrams, 0);
            const totalFeedCalories = currentMeal.reduce((sum, food) => sum + (food.caloriesPerGram * food.feedGrams), 0);
            const actualCalories = calculateActualCalories(totalFeedCalories, totalFeedGrams);
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].slice(0, 5);
            
            const meal = {
                date: dateStr,
                time: timeStr,
                foods: currentMeal.map(food => ({
                    name: food.name,
                    feedGrams: food.feedGrams,
                    actualGrams: food.actualGrams,
                    actualCalories: food.actualCalories
                })),
                totalFeedGrams: totalFeedGrams,
                actualEatenGrams: actualEatenGrams,
                totalFeedCalories: totalFeedCalories,
                actualCalories: actualCalories
            };
            
            if (editingMealIndex >= 0) {
                // 編輯模式：更新現有餐點
                mealHistory[editingMealIndex] = meal;
                editingMealIndex = -1;
                showSyncStatus('餐點已更新！', 'success');
            } else {
                // 新增模式：加入新餐點
                mealHistory.unshift(meal);
                showSyncStatus('餐點已記錄！', 'success');
            }
            
            saveHistoryToStorage();
            syncToCloud();
            
            // 清空表單
            resetForm();
            
            // 更新顯示
            displayHistory();
            updateChart();
        }

        // 重置表單
        function resetForm() {
            const container = document.getElementById('foodSelectors');
            container.innerHTML = `
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="重量 (克)" step="0.1" min="0">
                </div>
            `;
            
            foodSelectorCount = 1;
            populateFoodSelect('foodSelect0');
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            document.getElementById('feedingSummary').style.display = 'none';
            document.getElementById('saveMealBtn').style.display = 'none';
            document.getElementById('saveMealBtn').textContent = '儲存這餐';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('actualEatenGrams').value = '';
            
            currentMeal = [];
            editingMealIndex = -1;
        }

        // 顯示歷史記錄
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (mealHistory.length === 0) {
                historyList.innerHTML = '<p>尚無飲食記錄</p>';
                return;
            }
            
            // 按日期分組
            const groupedHistory = {};
            mealHistory.forEach(meal => {
                if (!groupedHistory[meal.date]) {
                    groupedHistory[meal.date] = [];
                }
                groupedHistory[meal.date].push(meal);
            });
            
            historyList.innerHTML = '';
            
            Object.keys(groupedHistory).sort().reverse().forEach(date => {
                const dayMeals = groupedHistory[date];
                const dayTotal = dayMeals.reduce((sum, meal) => sum + (meal.actualCalories || meal.totalCalories || 0), 0);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'history-item';
                
                let mealsHtml = '';
                dayMeals.forEach((meal, mealIndex) => {
                    const globalMealIndex = mealHistory.findIndex(m => m === meal);
                    const foodsText = meal.foods.map(f => `${f.name} ${f.feedGrams}g`).join(', ');
                    mealsHtml += `
                        <div class="meal-detail" id="meal-${globalMealIndex}">
                            ${meal.time} - 實際攝取: ${meal.actualCalories.toFixed(1)} kcal (餵${meal.totalFeedGrams.toFixed(1)}g，吃${meal.actualEatenGrams.toFixed(1)}g)
                            <button class="edit-btn" onclick="editMeal(${globalMealIndex})">編輯</button>
                            <button class="delete-btn" onclick="deleteMeal(${globalMealIndex})">刪除</button>
                            <br>
                            <small>${foodsText}</small>
                        </div>
                    `;
                });
                
                dayElement.innerHTML = `
                    <div class="date-calories">${date} - 總計: ${dayTotal.toFixed(1)} kcal</div>
                    ${mealsHtml}
                `;
                
                historyList.appendChild(dayElement);
            });
        }

        // 更新圖表
        function updateChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            
            // 準備圖表資料
            const dailyCalories = {};
            mealHistory.forEach(meal => {
                if (!dailyCalories[meal.date]) {
                    dailyCalories[meal.date] = 0;
                }
                dailyCalories[meal.date] += (meal.actualCalories || meal.totalCalories || 0);
            });
            
            const dates = Object.keys(dailyCalories).sort();
            const calories = dates.map(date => dailyCalories[date].toFixed(1));
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '每日卡路里',
                        data: calories,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '卡路里 (kcal)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // 本地儲存
        function saveHistoryToStorage() {
            localStorage.setItem('catFoodHistory', JSON.stringify(mealHistory));
        }

        function loadHistoryFromStorage() {
            const stored = localStorage.getItem('catFoodHistory');
            if (stored) {
                mealHistory = JSON.parse(stored);
                displayHistory();
            }
        }

        // 雲端同步功能
        function syncToCloud() {
            if (isAuthorized && autoSyncEnabled) {
                saveToGoogleDrive();
            }
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // 編輯餐點
        function editMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) return;
            
            editingMealIndex = mealIndex;
            
            // 清空現有表單
            const container = document.getElementById('foodSelectors');
            container.innerHTML = '';
            
            // 重建表單以符合要編輯的餐點
            foodSelectorCount = 0;
            meal.foods.forEach((food, index) => {
                const newSelector = document.createElement('div');
                newSelector.className = 'food-selector';
                newSelector.innerHTML = `
                    <select id="foodSelect${foodSelectorCount}">
                        <option value="">選擇食物...</option>
                    </select>
                    <input type="number" id="grams${foodSelectorCount}" placeholder="重量 (克)" step="0.1" min="0" value="${food.feedGrams}">
                    ${foodSelectorCount > 0 ? '<button type="button" class="remove-btn" onclick="removeFoodSelector(this)">移除</button>' : ''}
                `;
                
                container.appendChild(newSelector);
                populateFoodSelect(`foodSelect${foodSelectorCount}`);
                
                // 設定選中的食物
                const foodIndex = foodDatabase.findIndex(f => f.name === food.name);
                if (foodIndex >= 0) {
                    document.getElementById(`foodSelect${foodSelectorCount}`).value = foodIndex;
                }
                
                document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
                
                foodSelectorCount++;
            });
            
            // 設定實際攝取量
            document.getElementById('actualEatenGrams').value = meal.actualEatenGrams;
            
            // 重新計算卡路里以顯示預覽
            calculateCalories();
            
            // 修改按鈕文字
            document.getElementById('saveMealBtn').textContent = '更新餐點';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // 滾動到表單頂部
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            
            showSyncStatus('編輯模式：修改完成後點擊「更新餐點」', 'success');
        }
        
        // 刪除餐點
        function deleteMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) return;
            
            const confirmDelete = confirm(`確定要刪除 ${meal.date} ${meal.time} 的餐點記錄嗎？\n實際攝取: ${meal.actualCalories.toFixed(1)} kcal`);
            
            if (confirmDelete) {
                mealHistory.splice(mealIndex, 1);
                saveHistoryToStorage();
                syncToCloud();
                
                // 更新顯示
                displayHistory();
                updateChart();
                
                showSyncStatus('餐點記錄已刪除', 'success');
            }
        }
        
        // 取消編輯
        function cancelEdit() {
            editingMealIndex = -1;
            resetForm();
            document.getElementById('saveMealBtn').textContent = '儲存這餐';
            showSyncStatus('已取消編輯', 'success');
        }
        
        // ==================== Google API 函數 ====================
        
        // 初始化 Google API
        async function initializeGoogleAPI() {
            try {
                console.log('開始初始化 Google API...');
                
                // 檢查基本的 JavaScript 功能
                if (typeof window === 'undefined') {
                    throw new Error('JavaScript 環境異常');
                }
                
                // 更新載入狀態
                const loadingElement = document.getElementById('loadingAuth');
                if (loadingElement) {
                    loadingElement.innerHTML = '<p>正在載入 Google API...</p><small>請稍候，首次載入可能需要幾秒鐘</small>';
                }
                
                // 等待 Google API 腳本載入
                if (typeof gapi === 'undefined' || typeof google === 'undefined') {
                    console.log('等待 Google API 腳本載入...');
                    await waitForGoogleAPI();
                }
                
                console.log('Google API 腳本已載入，開始初始化客戶端...');
                
                // 使用 Promise 包裝 gapi.load
                await new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error('Google API 客戶端初始化超時'));
                    }, 12000); // 12秒超時
                    
                    gapi.load('client:picker', async () => {
                        try {
                            clearTimeout(timeoutId);
                            console.log('開始初始化 Google Drive 客戶端...');
                            await initClient();
                            resolve();
                        } catch (error) {
                            clearTimeout(timeoutId);
                            reject(error);
                        }
                    }, (error) => {
                        clearTimeout(timeoutId);
                        reject(new Error('Google API 模組載入失敗: ' + error));
                    });
                });
                
                console.log('初始化 OAuth 2.0...');
                // 初始化 OAuth 2.0
                initAuth();
                
                console.log('Google API 初始化完成');
                
            } catch (error) {
                console.error('Google API 初始化失敗:', error);
                handleGoogleAPIError(error);
            }
        }

        // 等待 Google API 載入
        function waitForGoogleAPI() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10秒最大等待時間
                
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                        clearInterval(checkInterval);
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        reject(new Error('Google API 腳本載入超時'));
                    }
                }, 100);
            });
        }

        // Google API 錯誤處理
        function handleGoogleAPIError(error) {
            let errorMessage = 'Google API 發生錯誤';
            let suggestions = [];

            if (error.message.includes('載入超時')) {
                errorMessage = 'Google API 載入超時';
                suggestions = [
                    '請檢查網路連線',
                    '嘗試重新整理頁面',
                    '確認沒有廣告攔截器封鎖 Google API'
                ];
            } else if (error.message.includes('unauthorized_client')) {
                errorMessage = 'OAuth 客戶端未授權';
                suggestions = [
                    '請確認網域已在 Google Cloud Console 中授權',
                    '檢查客戶端 ID 是否正確'
                ];
            } else if (error.message.includes('access_denied')) {
                errorMessage = '用戶拒絕授權或權限不足';
                suggestions = [
                    '請重新登入並授權應用',
                    '確認已允許必要的權限'
                ];
            } else if (error.message.includes('network')) {
                errorMessage = '網路連線問題';
                suggestions = [
                    '請檢查網路連線',
                    '稍後再試'
                ];
            }

            const loadingElement = document.getElementById('loadingAuth');
            loadingElement.innerHTML = `
                <div class="google-auth-error">
                    <h4>❌ ${errorMessage}</h4>
                    ${suggestions.length > 0 ? `
                        <p><strong>建議解決方案：</strong></p>
                        <ul>
                            ${suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                        </ul>
                    ` : ''}
                    <p><small>錯誤詳情: ${error.message}</small></p>
                    <button onclick="initializeGoogleAPI()" class="retry-button">重試</button>
                </div>
            `;
        }

        // 初始化認證
        function initAuth() {
            if (typeof google !== 'undefined' && google.accounts) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CONFIG.CLIENT_ID,
                    scope: GOOGLE_CONFIG.SCOPES,
                    callback: handleAuthResponse,
                });
            } else {
                console.error('Google Identity Services 尚未載入');
            }
        }

        // 初始化客戶端
        async function initClient() {
            await gapi.client.init({
                apiKey: GOOGLE_CONFIG.API_KEY,
                discoveryDocs: [GOOGLE_CONFIG.DISCOVERY_DOC],
            });

            isGoogleApiLoaded = true;
            document.getElementById('loadingAuth').style.display = 'none';
            document.getElementById('googleAuth').style.display = 'block';
            
            // 檢查是否已經有儲存的授權
            checkSavedAuth();
        }

        // 檢查儲存的授權狀態
        function checkSavedAuth() {
            const savedToken = localStorage.getItem('google_access_token');
            if (savedToken) {
                gapi.client.setToken({ access_token: savedToken });
                verifyToken(savedToken);
            }
        }

        // 驗證 token 是否仍然有效
        async function verifyToken(token) {
            try {
                const response = await fetch(`https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=${token}`);
                if (response.ok) {
                    const userInfo = await gapi.client.request({
                        path: 'https://www.googleapis.com/oauth2/v2/userinfo'
                    });
                    handleAuthSuccess(userInfo.result);
                } else {
                    // Token 無效，清除儲存的 token
                    localStorage.removeItem('google_access_token');
                }
            } catch (error) {
                console.error('驗證 token 失敗:', error);
                localStorage.removeItem('google_access_token');
            }
        }

        // 處理認證響應
        function handleAuthResponse(resp) {
            if (resp.error !== undefined) {
                let errorMessage = '登入失敗: ' + resp.error;
                if (resp.error === 'access_denied') {
                    errorMessage = '用戶拒絕授權訪問 Google Drive';
                } else if (resp.error === 'unauthorized_client') {
                    errorMessage = '應用未授權，請聯繫管理員';
                }
                showSyncStatus(errorMessage, 'error');
                return;
            }

            try {
                localStorage.setItem('google_access_token', resp.access_token);
                
                // 獲取用戶信息
                gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v2/userinfo'
                }).then(response => {
                    handleAuthSuccess(response.result);
                }).catch(error => {
                    console.error('獲取用戶信息失敗:', error);
                    showSyncStatus('無法獲取用戶信息，但登入成功', 'error');
                });
            } catch (error) {
                console.error('處理認證響應失敗:', error);
                showSyncStatus('認證處理失敗: ' + error.message, 'error');
            }
        }

        // 處理認證成功
        async function handleAuthSuccess(userInfo) {
            isAuthorized = true;
            
            document.getElementById('authorizeButton').style.display = 'none';
            document.getElementById('signoutButton').style.display = 'inline-block';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('syncControls').style.display = 'block';
            document.getElementById('userEmail').textContent = userInfo.email;
            
            showSyncStatus('已成功登入 Google 帳戶: ' + userInfo.email, 'success');
            
            // 檢查或創建應用資料夾
            await ensureAppFolder();
            
            // 載入自動同步設定
            loadAutoSyncSetting();
        }

        // 登入按鈕點擊
        function handleAuthClick() {
            if (!isGoogleApiLoaded) {
                showSyncStatus('Google API 尚未載入完成', 'error');
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        // 登出按鈕點擊
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            localStorage.removeItem('google_access_token');
            isAuthorized = false;
            
            document.getElementById('authorizeButton').style.display = 'inline-block';
            document.getElementById('signoutButton').style.display = 'none';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('syncControls').style.display = 'none';
            
            showSyncStatus('已登出 Google 帳戶', 'success');
        }

        // 確保應用資料夾存在
        async function ensureAppFolder() {
            try {
                // 搜尋應用資料夾
                const response = await gapi.client.drive.files.list({
                    q: `name='${GOOGLE_CONFIG.APP_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                    spaces: 'drive'
                });

                if (response.result.files.length === 0) {
                    // 創建應用資料夾
                    const createResponse = await gapi.client.drive.files.create({
                        resource: {
                            name: GOOGLE_CONFIG.APP_FOLDER_NAME,
                            mimeType: 'application/vnd.google-apps.folder'
                        }
                    });
                    appFolderId = createResponse.result.id;
                } else {
                    appFolderId = response.result.files[0].id;
                }
            } catch (error) {
                console.error('創建/檢查應用資料夾失敗:', error);
                showSyncStatus('無法訪問 Google Drive 資料夾', 'error');
            }
        }

        // 保存到 Google Drive
        async function saveToGoogleDrive() {
            if (!isAuthorized) {
                showSyncStatus('請先登入 Google 帳戶', 'error');
                return;
            }

            if (!appFolderId) {
                try {
                    await ensureAppFolder();
                    if (!appFolderId) {
                        showSyncStatus('無法創建 Google Drive 資料夾', 'error');
                        return;
                    }
                } catch (error) {
                    showSyncStatus('資料夾創建失敗: ' + error.message, 'error');
                    return;
                }
            }

            if (mealHistory.length === 0) {
                showSyncStatus('沒有數據需要同步', 'error');
                return;
            }

            try {
                showSyncStatus('正在同步到 Google Drive...', 'success');
                
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-');
                const fileName = `貓咪食物追蹤數據-${timestamp.split('T')[0]}.json`;
                
                const dataToSave = {
                    version: '1.0',
                    timestamp: now.toISOString(),
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null
                    }
                };

                const fileMetadata = {
                    name: fileName,
                    parents: [appFolderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
                form.append('file', new Blob([JSON.stringify(dataToSave, null, 2)], {type: 'application/json'}));

                const token = gapi.client.getToken();
                if (!token || !token.access_token) {
                    throw new Error('認證令牌無效，請重新登入');
                }

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({
                        'Authorization': `Bearer ${token.access_token}`
                    }),
                    body: form
                });

                if (response.ok) {
                    const result = await response.json();
                    showSyncStatus(`數據已成功保存到 Google Drive: ${fileName}`, 'success');
                    localStorage.setItem('lastGoogleDriveSync', now.toISOString());
                    return result;
                } else {
                    const errorText = await response.text();
                    let errorMessage = `HTTP ${response.status}`;
                    
                    if (response.status === 401) {
                        errorMessage = '認證已過期，請重新登入';
                        handleSignoutClick(); // 自動登出
                    } else if (response.status === 403) {
                        errorMessage = '權限不足，請檢查 Google Drive API 權限';
                    } else if (response.status === 429) {
                        errorMessage = '請求過於頻繁，請稍後再試';
                    }
                    
                    throw new Error(errorMessage + (errorText ? `: ${errorText}` : ''));
                }

            } catch (error) {
                console.error('保存到 Google Drive 失敗:', error);
                if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                    showSyncStatus('網路連線問題，請檢查網路後重試', 'error');
                } else {
                    showSyncStatus('同步失敗: ' + error.message, 'error');
                }
            }
        }

        // 顯示 Google Picker
        function showGooglePicker() {
            if (!isAuthorized) {
                showSyncStatus('請先登入 Google 帳戶', 'error');
                return;
            }

            if (!appFolderId) {
                showSyncStatus('應用資料夾尚未建立，請先保存一次數據', 'error');
                return;
            }

            try {
                const token = gapi.client.getToken();
                if (!token || !token.access_token) {
                    showSyncStatus('認證令牌無效，請重新登入', 'error');
                    return;
                }

                if (typeof google.picker === 'undefined') {
                    showSyncStatus('Google Picker API 尚未載入', 'error');
                    return;
                }

                const view = new google.picker.View(google.picker.ViewId.DOCS);
                view.setParent(appFolderId);
                view.setMimeTypes('application/json');

                const picker = new google.picker.PickerBuilder()
                    .enableFeature(google.picker.Feature.NAV_HIDDEN)
                    .setAppId(GOOGLE_CONFIG.CLIENT_ID.split('-')[0])
                    .setOAuthToken(token.access_token)
                    .addView(view)
                    .setDeveloperKey(GOOGLE_CONFIG.API_KEY)
                    .setCallback(handlePickerCallback)
                    .build();

                picker.setVisible(true);
                showSyncStatus('正在開啟文件選擇器...', 'success');

            } catch (error) {
                console.error('Google Picker 錯誤:', error);
                showSyncStatus('無法開啟文件選擇器: ' + error.message, 'error');
            }
        }

        // 處理 Picker 回調
        async function handlePickerCallback(data) {
            if (data.action === google.picker.Action.PICKED) {
                if (!data.docs || data.docs.length === 0) {
                    showSyncStatus('未選擇任何文件', 'error');
                    return;
                }

                const fileId = data.docs[0].id;
                const fileName = data.docs[0].name;
                
                try {
                    showSyncStatus('正在從 Google Drive 載入數據...', 'success');
                    
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    if (!response.body) {
                        throw new Error('文件內容為空');
                    }

                    let fileData;
                    try {
                        fileData = JSON.parse(response.body);
                    } catch (parseError) {
                        throw new Error('文件格式不是有效的 JSON');
                    }
                    
                    // 驗證文件格式
                    if (!fileData.data) {
                        throw new Error('文件缺少數據欄位');
                    }
                    
                    if (!Array.isArray(fileData.data)) {
                        throw new Error('數據格式不正確，應該是陣列');
                    }

                    // 驗證數據結構
                    if (fileData.data.length > 0) {
                        const sampleMeal = fileData.data[0];
                        if (!sampleMeal.date || !sampleMeal.time || !sampleMeal.foods) {
                            throw new Error('餐點數據格式不正確');
                        }
                    }

                    // 處理數據合併
                    await mergeDataFromGoogleDrive(fileData.data, fileName);

                } catch (error) {
                    console.error('從 Google Drive 載入失敗:', error);
                    let errorMessage = '載入失敗: ';
                    
                    if (error.result && error.result.error) {
                        const apiError = error.result.error;
                        if (apiError.code === 404) {
                            errorMessage += '文件不存在或已刪除';
                        } else if (apiError.code === 403) {
                            errorMessage += '權限不足，無法讀取文件';
                        } else {
                            errorMessage += apiError.message || '未知 API 錯誤';
                        }
                    } else {
                        errorMessage += error.message;
                    }
                    
                    showSyncStatus(errorMessage, 'error');
                }
            } else if (data.action === google.picker.Action.CANCEL) {
                showSyncStatus('已取消文件選擇', 'success');
            }
        }

        // 合併 Google Drive 數據
        async function mergeDataFromGoogleDrive(driveData, fileName) {
            if (mealHistory.length === 0) {
                // 如果本地沒有數據，直接使用 Drive 數據
                mealHistory = driveData;
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已成功載入 ${fileName}`, 'success');
                return;
            }

            // 如果本地有數據，需要處理合併
            const conflicts = findDataConflicts(mealHistory, driveData);
            
            if (conflicts.length === 0) {
                // 沒有衝突，合併數據
                const mergedData = mergeDataArrays(mealHistory, driveData);
                mealHistory = mergedData;
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已成功合併 ${fileName} 中的 ${driveData.length} 筆記錄`, 'success');
            } else {
                // 有衝突，詢問用戶如何處理
                handleDataConflicts(driveData, fileName, conflicts);
            }
        }

        // 尋找數據衝突
        function findDataConflicts(localData, driveData) {
            const conflicts = [];
            const localMealMap = new Map();
            
            localData.forEach((meal, index) => {
                const key = `${meal.date}_${meal.time}`;
                localMealMap.set(key, { meal, index });
            });

            driveData.forEach((driveMeal, driveIndex) => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (localMealMap.has(key)) {
                    const localEntry = localMealMap.get(key);
                    if (JSON.stringify(localEntry.meal) !== JSON.stringify(driveMeal)) {
                        conflicts.push({
                            local: localEntry.meal,
                            drive: driveMeal,
                            localIndex: localEntry.index,
                            driveIndex: driveIndex
                        });
                    }
                }
            });

            return conflicts;
        }

        // 合併數據陣列
        function mergeDataArrays(localData, driveData) {
            const merged = [...localData];
            const localKeys = new Set(localData.map(meal => `${meal.date}_${meal.time}`));

            driveData.forEach(driveMeal => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (!localKeys.has(key)) {
                    merged.push(driveMeal);
                }
            });

            // 按日期時間排序
            return merged.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateB - dateA;
            });
        }

        // 處理數據衝突
        function handleDataConflicts(driveData, fileName, conflicts) {
            const message = `在合併 ${fileName} 時發現 ${conflicts.length} 個衝突記錄。\n\n` +
                           `選擇處理方式：\n` +
                           `• 確定：使用 Google Drive 版本覆蓋本地版本\n` +
                           `• 取消：保留本地版本，忽略 Google Drive 版本`;
            
            if (confirm(message)) {
                // 使用 Drive 版本
                conflicts.forEach(conflict => {
                    mealHistory[conflict.localIndex] = conflict.drive;
                });
                
                // 合併其他非衝突記錄
                const mergedData = mergeDataArrays(mealHistory, driveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已使用 Google Drive 版本解決 ${conflicts.length} 個衝突`, 'success');
            } else {
                // 保留本地版本，只合併非衝突記錄
                const nonConflictDriveData = driveData.filter(driveMeal => {
                    const key = `${driveMeal.date}_${driveMeal.time}`;
                    return !conflicts.some(conflict => 
                        `${conflict.drive.date}_${conflict.drive.time}` === key
                    );
                });
                
                const mergedData = mergeDataArrays(mealHistory, nonConflictDriveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`已保留本地版本，合併了 ${nonConflictDriveData.length} 筆非衝突記錄`, 'success');
            }
        }

        // 切換自動同步
        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSync').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                showSyncStatus('已啟用自動同步到 Google Drive', 'success');
            } else {
                showSyncStatus('已停用自動同步', 'success');
            }
        }

        // 載入自動同步設定
        function loadAutoSyncSetting() {
            const saved = localStorage.getItem('autoSyncEnabled');
            if (saved !== null) {
                autoSyncEnabled = saved === 'true';
                document.getElementById('autoSync').checked = autoSyncEnabled;
            }
        }

        // 顯示後備認證選項
        function showFallbackAuth() {
            document.getElementById('loadingAuth').style.display = 'none';
            document.getElementById('fallbackAuth').style.display = 'block';
            
            // 添加調試信息
            const debugInfo = {
                gapi: typeof gapi !== 'undefined',
                google: typeof google !== 'undefined',
                isGoogleApiLoaded: isGoogleApiLoaded,
                currentURL: window.location.href,
                userAgent: navigator.userAgent
            };
            
            console.warn('Google API 載入超時，顯示後備選項');
            console.log('調試信息:', debugInfo);
        }

        // 調試模式 - 檢查 Google API 狀態
        function debugGoogleAPI() {
            console.log('=== Google API 調試信息 ===');
            console.log('gapi 是否已載入:', typeof gapi !== 'undefined');
            console.log('google 是否已載入:', typeof google !== 'undefined');
            console.log('isGoogleApiLoaded:', isGoogleApiLoaded);
            console.log('isAuthorized:', isAuthorized);
            console.log('當前網址:', window.location.href);
            console.log('GOOGLE_CONFIG:', GOOGLE_CONFIG);
            
            if (typeof gapi !== 'undefined') {
                console.log('gapi.client:', gapi.client);
                try {
                    console.log('gapi.client.getToken():', gapi.client.getToken());
                } catch (e) {
                    console.log('獲取 token 失敗:', e.message);
                }
            }
            
            console.log('=== 調試信息結束 ===');
        }

        // 啟用離線模式
        function enableOfflineMode() {
            document.getElementById('loadingAuth').style.display = 'none';
            document.getElementById('fallbackAuth').style.display = 'none';
            document.getElementById('googleAuth').innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px;">
                    <h4>📱 本地模式已啟用</h4>
                    <p>✅ <strong>所有功能都可以正常使用！</strong></p>
                    <p>您的數據將保存在此瀏覽器的本地存儲中。</p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>📋 本地模式功能：</h5>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>✅ 記錄餐點和卡路里</li>
                            <li>✅ 編輯和刪除記錄</li>
                            <li>✅ 查看卡路里趨勢圖</li>
                            <li>✅ 數據自動保存</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>💾 數據備份建議：</h5>
                        <p style="margin: 5px 0;">定期匯出數據以防資料遺失：</p>
                        <button onclick="exportLocalData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0;">匯出數據</button>
                        <small style="display: block; margin-top: 5px;">將數據下載為 JSON 檔案保存</small>
                    </div>
                    
                    <p><small>💡 提示：您可以隨時重新整理頁面來重試 Google Drive 功能。</small></p>
                </div>
            `;
            document.getElementById('googleAuth').style.display = 'block';
            
            showSyncStatus('已啟用本地模式 - 所有功能都可正常使用！', 'success');
            console.log('本地模式已啟用');
        }

        // Google API 連線測試
        async function testGoogleAPI() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>🔍 正在進行詳細測試...</p>';
            
            const tests = [];
            
            // 測試 1: 基本 API 腳本載入
            try {
                const response = await fetch('https://apis.google.com/js/api.js');
                tests.push(`✅ Google API 腳本可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google API 腳本無法訪問: ${error.message}`);
            }
            
            // 測試 2: Google Identity Services (詳細測試)
            try {
                const response = await fetch('https://accounts.google.com/gsi/client', { method: 'HEAD' });
                tests.push(`✅ Google Identity Services 可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google Identity Services 無法訪問: ${error.message}`);
            }
            
            // 測試 3: 替代 Google 服務測試
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo?access_token=test', { method: 'HEAD' });
                tests.push(`✅ Google OAuth API 可訪問 (${response.status})`);
            } catch (error) {
                tests.push(`❌ Google OAuth API 無法訪問: ${error.message}`);
            }
            
            // 測試 4: Google 主域名測試
            try {
                const response = await fetch('https://accounts.google.com', { method: 'HEAD', mode: 'no-cors' });
                tests.push(`✅ Google 主域名可訪問`);
            } catch (error) {
                tests.push(`❌ Google 主域名無法訪問: ${error.message}`);
            }
            
            // 測試 5: 檢查腳本載入錯誤
            if (scriptErrors.length > 0) {
                tests.push(`❌ 腳本載入錯誤: ${scriptErrors.join(', ')}`);
            } else {
                tests.push(`✅ 沒有檢測到腳本載入錯誤`);
            }
            
            // 測試 6: 檢查變數
            tests.push(`gapi 變數: ${typeof gapi !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}`);
            tests.push(`google 變數: ${typeof google !== 'undefined' ? '✅ 已載入' : '❌ 未載入'}`);
            
            // 測試 7: 瀏覽器環境檢查
            tests.push(`瀏覽器: ${navigator.userAgent.split(' ')[0]}`);
            tests.push(`是否支援 fetch: ${typeof fetch !== 'undefined' ? '✅' : '❌'}`);
            tests.push(`是否為 HTTPS: ${location.protocol === 'https:' ? '✅' : '❌'}`);
            tests.push(`第三方 Cookie: ${navigator.cookieEnabled ? '✅ 啟用' : '❌ 禁用'}`);
            
            // 測試 8: 檢查可能的阻擋因素
            const blockers = [];
            if (window.chrome && window.chrome.runtime) {
                blockers.push('Chrome 擴展可能影響');
            }
            if (navigator.brave) {
                blockers.push('Brave 瀏覽器內建阻擋');
            }
            if (window.safari) {
                blockers.push('Safari 追蹤防護可能影響');
            }
            if (blockers.length > 0) {
                tests.push(`⚠️ 偵測到潛在阻擋因素: ${blockers.join(', ')}`);
            }
            
            // 判斷主要問題並提供解決方案
            let mainIssue = '';
            let solutions = [];
            
            if (tests.some(test => test.includes('Google Identity Services 無法訪問'))) {
                mainIssue = '🔒 Google Identity Services 被阻擋';
                solutions = [];
                
                // 根據檢測到的情況提供具體建議
                if (tests.some(test => test.includes('Brave 瀏覽器'))) {
                    solutions.push('Brave: 設定 → 隱私權與安全 → 關閉「阻擋腳本」');
                }
                if (tests.some(test => test.includes('Safari'))) {
                    solutions.push('Safari: 偏好設定 → 隱私權 → 關閉「防止跨網站追蹤」');
                }
                if (tests.some(test => test.includes('Chrome 擴展'))) {
                    solutions.push('檢查 Chrome 擴展，暫時停用安全相關擴展');
                }
                
                // Chrome 專用建議
                if (navigator.userAgent.includes('Chrome')) {
                    solutions.unshift('🌐 Chrome 專用解決方案：');
                    solutions.unshift('1. 設定 → 隱私權和安全性 → 網站設定 → JavaScript → 允許');
                    solutions.unshift('2. 設定 → 隱私權和安全性 → 網站設定 → Cookie → 允許第三方 Cookie');
                    solutions.unshift('3. 設定 → 隱私權和安全性 → 安全瀏覽 → 選擇「標準保護」');
                    solutions.unshift('4. 檢查是否啟用了「增強型保護」→ 改為「標準保護」');
                    solutions.unshift('5. 網址列 → 點擊鎖頭圖示 → Cookie → 允許此網站的 Cookie');
                    solutions.unshift('━━━━━━━━━━━━━━━━━━━━━━━━━');
                } else if (navigator.userAgent.includes('Mozilla') && navigator.userAgent.includes('Firefox')) {
                    solutions.unshift('🦊 Firefox 設定：');
                    solutions.unshift('1. 網址列輸入 about:config → 搜尋 privacy.resistFingerprinting → 設為 false');
                    solutions.unshift('2. 設定 → 隱私權與安全 → 增強型追蹤保護 → 選擇「標準」');
                    solutions.unshift('3. 設定 → 隱私權與安全 → Cookie → 選擇「標準」');
                }
                
                // 通用解決方案
                solutions.push('檢查瀏覽器隱私權設定，允許第三方腳本');
                solutions.push('嘗試無痕/私人瀏覽模式');
                solutions.push('檢查網路是否有企業防火牆或過濾器');
                solutions.push('嘗試關閉 VPN 或代理伺服器');
                solutions.push('檢查防毒軟體是否阻擋 Google 服務');
                solutions.push('或直接使用「僅使用本地模式」');
                
            } else if (typeof gapi === 'undefined') {
                mainIssue = '📡 Google API 腳本載入失敗';
                solutions = [
                    '檢查網路連線',
                    '重新載入頁面',
                    '清除瀏覽器緩存',
                    '嘗試不同的 DNS 設定 (如 8.8.8.8)'
                ];
            }

            resultsDiv.innerHTML = `
                <h5>🔍 測試結果：</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                    ${tests.map(test => `<li>${test}</li>`).join('')}
                </ul>
                ${mainIssue ? `
                    <div style="margin: 10px 0; padding: 8px; background: #fff3cd; border-radius: 4px;">
                        <strong style="font-size: 12px;">${mainIssue}</strong>
                        <ol style="margin: 5px 0 0 0; padding-left: 18px; font-size: 11px;">
                            ${solutions.map(solution => `<li>${solution}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
            `;
        }

        // 顯示修復指南
        function showFixGuide() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h5>🔧 Chrome 專用修復指南</h5>
                    <p><strong>最常見原因：Chrome 的安全瀏覽設定過於嚴格</strong></p>
                    
                    <h6>🎯 立即嘗試：</h6>
                    <ol style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li><strong>檢查網址列鎖頭</strong>：點擊網址列左側的鎖頭圖示 → Cookie → 「允許」</li>
                        <li><strong>檢查安全瀏覽</strong>：Chrome 設定 → 隱私權和安全性 → 安全瀏覽 → 選擇「標準保護」</li>
                        <li><strong>允許第三方 Cookie</strong>：設定 → 隱私權和安全性 → 網站設定 → Cookie → 允許第三方 Cookie</li>
                        <li><strong>無痕模式測試</strong>：Ctrl+Shift+N 開啟無痕視窗測試</li>
                    </ol>
                    
                    <h6>🔍 其他可能原因：</h6>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li>企業或學校網路阻擋 OAuth 服務</li>
                        <li>防毒軟體或網路安全軟體干擾</li>
                        <li>ISP 或 DNS 過濾服務</li>
                        <li>Chrome 擴展程式衝突</li>
                    </ul>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>💡 快速測試：</strong>如果上述方法都不行，請點擊「本地模式」直接使用應用！
                    </div>
                </div>
            `;
        }

        // 嘗試無痕模式
        function tryIncognitoMode() {
            const url = window.location.href;
            const message = `請嘗試在無痕/私人瀏覽模式下開啟：\n\n${url}\n\n快捷鍵：\nChrome/Edge: Ctrl+Shift+N\nFirefox: Ctrl+Shift+P\nSafari: Cmd+Shift+N`;
            
            if (navigator.share) {
                navigator.share({
                    title: '貓咪飲食追蹤器',
                    url: url
                }).catch(() => {
                    alert(message);
                });
            } else {
                alert(message);
                // 嘗試複製到剪貼板
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(url);
                }
            }
        }

        // 匯出本地數據
        function exportLocalData() {
            try {
                const dataToExport = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    source: 'local_storage',
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null,
                        exportedFrom: window.location.href
                    }
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `貓咪食物追蹤數據-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSyncStatus(`已匯出 ${mealHistory.length} 筆記錄到檔案`, 'success');
                
            } catch (error) {
                console.error('匯出數據失敗:', error);
                showSyncStatus('匯出失敗: ' + error.message, 'error');
            }
        }

        // 在 window 對象上暴露調試函數供手動調用
        window.debugGoogleAPI = debugGoogleAPI;
        window.testGoogleAPI = testGoogleAPI;
        window.tryIncognitoMode = tryIncognitoMode;
        window.showFixGuide = showFixGuide;
        window.exportLocalData = exportLocalData;

        // 頁面載入時初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>