<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²“å’ªé£²é£Ÿè¿½è¹¤å™¨ v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1, h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .food-selector {
            margin-bottom: 15px;
        }
        
        select, input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .remove-btn {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .remove-btn:hover {
            background: #c0392b;
        }
        
        .selected-food {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #3498db;
        }
        
        .food-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .total-calories {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #9b59b6;
        }
        
        .date-calories {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .meal-detail {
            font-size: 14px;
            color: #666;
            margin-left: 10px;
        }
        
        .edit-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .edit-btn:hover {
            background: #e67e22;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .edit-form {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .edit-form h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .food-info {
                flex-direction: column;
                align-items: flex-start;
            }
        }
        
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
        
        .sync-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        
        .retry-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .retry-button:hover {
            background: #2980b9;
        }
        
        .search-result-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .meat-tag:hover {
            opacity: 0.8;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ± è²“å’ªé£²é£Ÿè¿½è¹¤å™¨</h1>
        
        <div id="syncStatus" class="sync-status" style="display: none;"></div>
        
        <div class="card">
            <h2>é›²ç«¯æ•¸æ“šåŒæ­¥</h2>
            <div id="cloudOptions">
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>â˜ï¸ é¸æ“‡æ‚¨çš„é›²ç«¯å­˜å„²æ–¹æ¡ˆ</h4>
                    <p>ç‚ºäº†å¯¦ç¾è·¨å¹³å°åŒæ­¥ï¼Œè«‹é¸æ“‡ä¸€å€‹é©åˆçš„å­˜å„²æ–¹æ¡ˆï¼š</p>
                    
                    <div style="margin: 15px 0;">
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>ğŸ—‚ï¸ GitHub Gistï¼ˆæ¨è–¦ï¼‰</h6>
                            <p>å…è²»ã€ç©©å®šã€è·¨å¹³å°ï¼Œé©åˆæŠ€è¡“ç”¨æˆ¶</p>
                            <button onclick="setupGitHubSync()" style="background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¨­ç½® GitHub åŒæ­¥</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>ğŸ“‹ æ‰‹å‹•åŒæ­¥</h6>
                            <p>ä½¿ç”¨åˆ†äº«é€£çµæˆ– QR Code åœ¨è¨­å‚™é–“åŒæ­¥æ•¸æ“š</p>
                            <button onclick="showManualSync()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">æ‰‹å‹•åŒæ­¥</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>ğŸ’¾ æ–‡ä»¶å­˜å„²</h6>
                            <p>åŒ¯å‡º/åŒ¯å…¥ JSON æ–‡ä»¶ï¼Œä¿å­˜åˆ°æ‚¨çš„é›²ç«¯ç¡¬ç¢Ÿ</p>
                            <button onclick="showFileSync()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">æ–‡ä»¶åŒæ­¥</button>
                        </div>
                        
                        <div style="background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0;">
                            <h6>ğŸ”— åœ¨ç·šå‰ªè²¼æ¿</h6>
                            <p>ä½¿ç”¨ Pastebin ç­‰æœå‹™åˆ†äº«æ•¸æ“š</p>
                            <button onclick="showPastebinSync()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">å‰ªè²¼æ¿åŒæ­¥</button>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                        <small><strong>ğŸ’¡ æç¤ºï¼š</strong>æ‰€æœ‰æ–¹æ¡ˆéƒ½æœƒä¿æŒæ‚¨çš„æ•¸æ“šç§å¯†æ€§ï¼Œå»ºè­°å…ˆè©¦ç”¨ GitHub Gist æ–¹æ¡ˆã€‚</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>æ–°å¢é¤é»è¨˜éŒ„</h2>
            
            <!-- æ™ºèƒ½æœç´¢å€ -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px;">ğŸ” å¿«é€ŸæŸ¥æ‰¾è²“é£Ÿ</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 12px; color: #666;">å“ç‰Œç¯©é¸</label>
                        <select id="brandFilter" onchange="filterFoods()" style="margin-bottom: 5px;">
                            <option value="">æ‰€æœ‰å“ç‰Œ</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #666;">åˆ†é¡ç¯©é¸</label>
                        <select id="categoryFilter" onchange="filterFoods()" style="margin-bottom: 5px;">
                            <option value="">æ‰€æœ‰åˆ†é¡</option>
                            <option value="ä¸»é£Ÿç½">ä¸»é£Ÿç½</option>
                            <option value="å‰¯é£Ÿç½">å‰¯é£Ÿç½</option>
                            <option value="ä¹¾ç³§">ä¹¾ç³§</option>
                            <option value="ä¸»é£Ÿé¤åŒ…">ä¸»é£Ÿé¤åŒ…</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 12px; color: #666;">è‚‰é¡ç¯©é¸</label>
                    <div id="meatFilters" style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                        <!-- å‹•æ…‹ç”Ÿæˆè‚‰é¡æ¨™ç±¤ -->
                    </div>
                </div>
                
                <div>
                    <label style="font-size: 12px; color: #666;">é—œéµå­—æœç´¢</label>
                    <input type="text" id="searchInput" placeholder="è¼¸å…¥å“åã€å“ç‰Œæˆ–è‚‰é¡..." 
                           onkeyup="filterFoods()" style="margin-bottom: 5px;">
                </div>
                
                <div id="searchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; background: white;">
                    <!-- æœç´¢çµæœæœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>
            </div>

            <div id="foodSelectors">
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">é¸æ“‡é£Ÿç‰©...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                </div>
            </div>
            <button onclick="addFoodSelector()">+ æ–°å¢é£Ÿç‰©</button>
            <div id="feedingSummary" style="display: none;">
                <div class="total-calories">
                    ç¸½é¤µé£Ÿ: <span id="totalFeedGrams">0</span>g | ç¸½å¡è·¯é‡Œ: <span id="totalCalories">0</span> kcal
                </div>
                <input type="number" id="actualEatenGrams" placeholder="å¯¦éš›åƒäº†å¤šå°‘å…‹" step="0.1" min="0">
                <div id="actualCalories" class="total-calories" style="display: none; background: #e74c3c;">
                    å¯¦éš›æ”å–: <span id="actualCaloriesValue">0</span> kcal
                </div>
            </div>
            <button onclick="saveMeal()" id="saveMealBtn" style="display: none;">å„²å­˜é€™é¤</button>
            <button onclick="cancelEdit()" id="cancelEditBtn" style="display: none; background: #95a5a6; margin-top: 10px;">å–æ¶ˆç·¨è¼¯</button>
        </div>
        
        <div class="card">
            <h2>å¡è·¯é‡Œè¶¨å‹¢åœ–</h2>
            <div class="chart-container">
                <canvas id="caloriesChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <h2>é£²é£Ÿè¨˜éŒ„ <span id="dataSource" style="font-size: 14px; color: #666;"></span></h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // é›²ç«¯åŒæ­¥ç›¸é—œè®Šæ•¸
        let cloudSyncEnabled = false;
        let dataSource = 'local'; // 'github' or 'local'

        // è²“ç³§è³‡æ–™åº«
        const foodDatabase = [
            {name: "catdives è²“çˆ¾åœ°å¤« å…¨é½¡è²“ç‡Ÿé¤Šå‡ç´š é­©ä»”é­š+æ¿è…±ç‰›+é›èƒ¸è‚‰", calories: 100.2, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["ç‰›è‚‰","è²é¡","é›è‚‰","é­©ä»”é­š"], texture: "ä¹¾ç³§", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« å…¨é½¡è²“ç‡Ÿé¤Šå‡ç´š é­©ä»”é­š+é®ªé­š+é›èƒ¸è‚‰", calories: 97.9, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["è²é¡","é›è‚‰","é­©ä»”é­š","é®ªé­š"], texture: "ä¹¾ç³§", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ åš´é¸ç¾Šé›èƒ¸è‚‰", calories: 102.8, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["ç¾Šè‚‰","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ æ¿è…±ç‰›é›èƒ¸è‚‰", calories: 107.9, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["ç‰›è‚‰","è²é¡","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ é›èƒ¸è‚‰", calories: 100.3, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« ç¶“å…¸å›å‘³ é®ªé­šé›èƒ¸è‚‰", calories: 97.3, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["é›è‚‰","é®ªé­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« é ‚ç´šäº«å— åš´é¸é¹¿", calories: 84.7, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["é¹¿"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "catdives è²“çˆ¾åœ°å¤« é ‚ç´šäº«å— è²åŠ›ç‰›", calories: 95.3, category: "ä¸»é£Ÿç½", brand: "catdives è²“çˆ¾åœ°å¤«", meat: ["ç‰›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Dog Cat Star æ±ªå–µæ˜Ÿçƒ å†·å‡ä¹¾ç‡¥ç”Ÿé£Ÿ-æ«»æ¡ƒé´¨", calories: 480, category: "ä¹¾ç³§", brand: "Dog Cat Star æ±ªå–µæ˜Ÿçƒ", meat: ["é›è‚‰","é´¨è‚‰"], texture: "ä¹¾ç³§", origin: "å°ç£"},
            {name: "Dr. Wish é›è‚‰+é®ªé­š+ç‰›ç£ºé…¸", calories: 39, category: "å‰¯é£Ÿç½", brand: "Dr. Wish", meat: ["é›è‚‰","é®ªé­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Dr. Wish é®ªé­š+æœå¯¡ç³–", calories: 34, category: "å‰¯é£Ÿç½", brand: "Dr. Wish", meat: ["é®ªé­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Dr. Wish é®ªé­š+ç¶­ä»–å‘½A", calories: 34, category: "å‰¯é£Ÿç½", brand: "Dr. Wish", meat: ["é®ªé­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Dr. Wish é®ªé­š+é›è‚‰+ç¶­ä»–å‘½Bç¾¤", calories: 32, category: "å‰¯é£Ÿç½", brand: "Dr. Wish", meat: ["é›è‚‰","é®ªé­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "K9 Natural ç„¡ç©€ç‰›", calories: 112.3, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["ç‰›è‚‰"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "K9 Natural ç„¡ç©€ç‰›+é±ˆé­š", calories: 94.5, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["ç‰›è‚‰","é±ˆé­š"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "K9 Natural ç„¡ç©€ç¾Š", calories: 121.1, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["ç¾Šè‚‰"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "K9 Natural ç„¡ç©€ç¾Š+é®­é­š", calories: 106, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["ç¾Šè‚‰","é®­é­š"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "K9 Natural ç„¡ç©€é›", calories: 101.3, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["é›è‚‰"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "K9 Natural ç„¡ç©€é›+é¹¿", calories: 86.2, category: "ä¸»é£Ÿç½", brand: "K9 Natural", meat: ["é›è‚‰","é¹¿"], texture: "è‚‰æ³¥", origin: "ç´è¥¿è˜­"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶ç‡‰é›", calories: 127.5, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶è™±ç›®é­š", calories: 127.5, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["è™±ç›®é­š","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1 å¹¼æ¯è²“ åšå¥¶é±¸é­š", calories: 126.5, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰","é±¸é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-åŸé‡ç‰›è…¿", calories: 124.2, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["ç‰›è‚‰","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-ç™½è¦å¹²è²", calories: 103.7, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["è²é¡","é›è‚‰","é®®è¦","é°¹é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-è‚¥ç¾é¯–é­š", calories: 114.4, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰","é¯–é­š","é°¹é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é‡å‘³ç«é›", calories: 118.1, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["ç«é›è‚‰","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é¦™å«©é´¨èƒ¸", calories: 117.3, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰","é´¨è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1æ»´é›ç²¾-é®®é¦™é°¹é­š", calories: 120.6, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰","é°¹é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ å››ç¨®é­šï½œç™½è‚‰", calories: 123.2, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["è™±ç›®é­š","é›è‚‰","é¯›é­š","é°¹é­š","é±¸é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ å››ç¨®é­šï½œç´…è‚‰", calories: 117.8, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["æ——é­š","é›è‚‰","é®­é­š","é¯–é­š","é°¹é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆæµ·é™¸", calories: 117.8, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["ç‰›è‚‰","é›è‚‰","é¯›é­š","é°¹é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆè¦è²", calories: 116.3, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["è²é¡","é›è‚‰","é®®è¦"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ ç¶œåˆé‡å‘³", calories: 117.8, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["ç‰›è‚‰","ç¾Šè‚‰","é›è‚‰","é´¨è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1ç›Šç”ŸèŒ é›è‚‰è“æœ", calories: 115.1, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ æ…¢ç‡‰é®®é­š", calories: 112.1, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰","é®­é­š","é¯›é­š"], texture: "è‚‰æ¹¯", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ æ¿ƒæ¹¯ç‰›è…¿", calories: 112.1, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["ç‰›è‚‰","é›è‚‰"], texture: "è‚‰æ¹¯", origin: "å°ç£"},
            {name: "Lady Flavor å¥½å‘³å°å§ 1+1è²“é®®é£Ÿ ç™½é†¬å«©é›", calories: 100.1, category: "ä¸»é£Ÿç½", brand: "Lady Flavor å¥½å‘³å°å§", meat: ["é›è‚‰"], texture: "è‚‰æ¹¯", origin: "å°ç£"},
            {name: "LitoMON æ€ªç¸éƒ¨è½ 98%é®®è‚‰-é›è‚‰", calories: 415, category: "ä¹¾ç³§", brand: "LitoMON æ€ªç¸éƒ¨è½", meat: ["é›è‚‰"], texture: "ä¹¾ç³§", origin: "å°ç£"},
            {name: "MAC's é¦¬å…‹ å¹¼è²“-ç«é›è‚‰+å…”è‚‰", calories: 98, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["å…”è‚‰","ç«é›è‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ ç«é›è‚‰+ç«é›å¿ƒ", calories: 89, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["ç«é›è‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ ç¾Šè‚‰", calories: 90, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["ç¾Šè‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ ç¾Šè‚‰+ç«é›è‚‰", calories: 98, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["ç«é›è‚‰","ç¾Šè‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ é›è‚‰+é›å¿ƒ", calories: 111, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["é›è‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ é®­é­š+é›è‚‰", calories: 98, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["é›è‚‰","é®­é­š"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "MAC's é¦¬å…‹ é´¨è‚‰+ç«é›è‚‰+é›è‚‰", calories: 101, category: "ä¸»é£Ÿç½", brand: "MAC's é¦¬å…‹", meat: ["ç«é›è‚‰","é›è‚‰","é´¨è‚‰"], texture: "ç¢è‚‰", origin: "å¾·åœ‹"},
            {name: "Meow Servant å–µçš‡å¥´ ç´”é›è‚‰", calories: 114, category: "ä¸»é£Ÿç½", brand: "Meow Servant å–µçš‡å¥´", meat: ["é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Meow Servant å–µçš‡å¥´ é›è‚‰+ç‰›è‚‰", calories: 120, category: "ä¸»é£Ÿç½", brand: "Meow Servant å–µçš‡å¥´", meat: ["ç‰›è‚‰","é›è‚‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Meow Servant å–µçš‡å¥´ é®­é­š+é›è‚‰", calories: 121, category: "ä¸»é£Ÿç½", brand: "Meow Servant å–µçš‡å¥´", meat: ["é›è‚‰","é®­é­š"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Meow Servant å–µçš‡å¥´ éµªé¶‰+é›è‚‰", calories: 115, category: "ä¸»é£Ÿç½", brand: "Meow Servant å–µçš‡å¥´", meat: ["é›è‚‰","éµªé¶‰"], texture: "è‚‰æ³¥", origin: "å°ç£"},
            {name: "Orijen æ­ç¿å¥ å¹¼è²“é®®é›", calories: 412, category: "ä¹¾ç³§", brand: "Orijen æ­ç¿å¥/æ¥µè‡´", meat: ["æ··åˆ"], texture: "ä¹¾ç³§", origin: "åŠ æ‹¿å¤§"},
            {name: "ROYAL CANIN çš‡å®¶ K36 å¹¼è²“å°ˆç”¨", calories: 370, category: "ä¹¾ç³§", brand: "ROYAL CANIN çš‡å®¶", meat: ["æ··åˆ"], texture: "ä¹¾ç³§", origin: "æ³•åœ‹"},
            {name: "ROYAL CANIN çš‡å®¶ LP34 æ³Œå°¿é“é…æ–¹ä¹¾ç³§", calories: 387.2, category: "ä¹¾ç³§", brand: "ROYAL CANIN çš‡å®¶", meat: ["æ··åˆ"], texture: "ä¹¾ç³§", origin: "æ³•åœ‹"},
            {name: "ROYAL CANIN çš‡å®¶ S33W è…¸èƒƒä¿å¥", calories: 78.8, category: "ä¸»é£Ÿé¤åŒ…", brand: "ROYAL CANIN çš‡å®¶", meat: ["æ··åˆ"], texture: "è‚‰å¡Š", origin: "æ³•åœ‹"},
            {name: "ROYAL CANIN çš‡å®¶ å¹¼è²“", calories: 80.6, category: "ä¸»é£Ÿé¤åŒ…", brand: "ROYAL CANIN çš‡å®¶", meat: ["æ··åˆ"], texture: "è‚‰å¡Š", origin: "æ³•åœ‹"},
            {name: "ZIWIPeak å·”å³° é›è‚‰", calories: 550, category: "ä¹¾ç³§", brand: "ZIWIPeak å·”å³°", meat: ["é›è‚‰"], texture: "ä¹¾ç³§", origin: "ç´è¥¿è˜­"}
        ];

        let foodSelectorCount = 1;
        let currentMeal = [];
        let mealHistory = [];
        let chart = null;
        let editingMealIndex = -1;

        // åˆå§‹åŒ–
        async function init() {
            populateFoodSelect('foodSelect0');
            initSmartFoodSearch();
            
            // ç¶å®šäº‹ä»¶
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            // ç«‹å³é¡¯ç¤ºé›²ç«¯åŒæ­¥é¸é …ï¼Œä¸è¼‰å…¥ Google API
            document.getElementById('cloudOptions').style.display = 'block';
            
            // æª¢æŸ¥åˆ†äº«æ•¸æ“š
            checkForSharedData();
            
            // æª¢æŸ¥å·²ä¿å­˜çš„ GitHub è¨­å®šä¸¦å˜—è©¦è‡ªå‹•è¼‰å…¥
            await initializeWithGitHub();
            
            // å¦‚æœ GitHub æ²’æœ‰æ•¸æ“šï¼Œå‰‡è¼‰å…¥æœ¬åœ°æ•¸æ“šä½œç‚ºå¾Œå‚™
            if (mealHistory.length === 0) {
                loadHistoryFromStorage();
                dataSource = 'local';
            }
            
            updateChart();
            updateDataSourceDisplay();
        }

        // å¡«å……é£Ÿç‰©é¸é …
        function populateFoodSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">é¸æ“‡é£Ÿç‰©...</option>';
            
            foodDatabase.forEach((food, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = food.name;
                select.appendChild(option);
            });
            
            select.addEventListener('change', calculateCalories);
        }

        // æ–°å¢é£Ÿç‰©é¸æ“‡å™¨
        function addFoodSelector() {
            const container = document.getElementById('foodSelectors');
            const newSelector = document.createElement('div');
            newSelector.className = 'food-selector';
            newSelector.innerHTML = `
                <select id="foodSelect${foodSelectorCount}">
                    <option value="">é¸æ“‡é£Ÿç‰©...</option>
                </select>
                <input type="number" id="grams${foodSelectorCount}" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                <button type="button" class="remove-btn" onclick="removeFoodSelector(this)">ç§»é™¤</button>
            `;
            
            container.appendChild(newSelector);
            populateFoodSelect(`foodSelect${foodSelectorCount}`);
            
            document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
            
            foodSelectorCount++;
        }

        // ç§»é™¤é£Ÿç‰©é¸æ“‡å™¨
        function removeFoodSelector(button) {
            button.parentElement.remove();
            calculateCalories();
        }

        // è¨ˆç®—å¡è·¯é‡Œ
        function calculateCalories() {
            const selectors = document.querySelectorAll('.food-selector');
            let totalFeedCalories = 0;
            let totalFeedGrams = 0;
            currentMeal = [];

            selectors.forEach((selector, index) => {
                const foodSelect = selector.querySelector('select');
                const gramsInput = selector.querySelector('input[type="number"]');
                
                const foodIndex = foodSelect.value;
                const grams = parseFloat(gramsInput.value) || 0;
                
                if (foodIndex !== '' && grams > 0) {
                    const food = foodDatabase[foodIndex];
                    const calories = (food.calories * grams / 100);  // æ¯100gçš„å¡è·¯é‡Œ
                    totalFeedCalories += calories;
                    totalFeedGrams += grams;
                    
                    currentMeal.push({
                        name: food.name,
                        feedGrams: grams,
                        caloriesPerGram: food.calories / 100
                    });
                }
            });

            const summaryElement = document.getElementById('feedingSummary');
            const saveBtn = document.getElementById('saveMealBtn');
            
            if (totalFeedGrams > 0) {
                document.getElementById('totalFeedGrams').textContent = totalFeedGrams.toFixed(1);
                document.getElementById('totalCalories').textContent = totalFeedCalories.toFixed(1);
                summaryElement.style.display = 'block';
                
                // ç¶å®šå¯¦éš›åƒäº†å¤šå°‘çš„è¨ˆç®—
                const actualEatenInput = document.getElementById('actualEatenGrams');
                actualEatenInput.oninput = function() {
                    calculateActualCalories(totalFeedCalories, totalFeedGrams);
                };
                
                saveBtn.style.display = 'block';
            } else {
                summaryElement.style.display = 'none';
                saveBtn.style.display = 'none';
            }
        }

        // è¨ˆç®—å¯¦éš›æ”å–å¡è·¯é‡Œ
        function calculateActualCalories(totalFeedCalories, totalFeedGrams) {
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value) || 0;
            
            if (actualEatenGrams > 0) {
                // æŒ‰æ¯”ä¾‹è¨ˆç®—å¯¦éš›æ”å–çš„å¡è·¯é‡Œ
                const ratio = actualEatenGrams / totalFeedGrams;
                const actualCalories = totalFeedCalories * ratio;
                
                document.getElementById('actualCaloriesValue').textContent = actualCalories.toFixed(1);
                document.getElementById('actualCalories').style.display = 'block';
                
                // æ›´æ–° currentMeal è³‡æ–™
                currentMeal.forEach(food => {
                    food.actualGrams = food.feedGrams * ratio;
                    food.actualCalories = food.caloriesPerGram * food.actualGrams;
                });
                
                return actualCalories;
            } else {
                document.getElementById('actualCalories').style.display = 'none';
                return 0;
            }
        }

        // å„²å­˜é¤é»
        function saveMeal() {
            if (currentMeal.length === 0) return;
            
            const actualEatenGrams = parseFloat(document.getElementById('actualEatenGrams').value);
            if (!actualEatenGrams || actualEatenGrams <= 0) {
                alert('è«‹è¼¸å…¥å¯¦éš›åƒäº†å¤šå°‘å…‹');
                return;
            }
            
            const totalFeedGrams = currentMeal.reduce((sum, food) => sum + food.feedGrams, 0);
            const totalFeedCalories = currentMeal.reduce((sum, food) => sum + (food.caloriesPerGram * food.feedGrams), 0);
            const actualCalories = calculateActualCalories(totalFeedCalories, totalFeedGrams);
            
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0].slice(0, 5);
            
            const meal = {
                date: dateStr,
                time: timeStr,
                foods: currentMeal.map(food => ({
                    name: food.name,
                    feedGrams: food.feedGrams,
                    actualGrams: food.actualGrams,
                    actualCalories: food.actualCalories
                })),
                totalFeedGrams: totalFeedGrams,
                actualEatenGrams: actualEatenGrams,
                totalFeedCalories: totalFeedCalories,
                actualCalories: actualCalories
            };
            
            if (editingMealIndex >= 0) {
                // ç·¨è¼¯æ¨¡å¼ï¼šæ›´æ–°ç¾æœ‰é¤é»
                mealHistory[editingMealIndex] = meal;
                editingMealIndex = -1;
                showSyncStatus('é¤é»å·²æ›´æ–°ï¼', 'success');
            } else {
                // æ–°å¢æ¨¡å¼ï¼šåŠ å…¥æ–°é¤é»
                mealHistory.unshift(meal);
                showSyncStatus('é¤é»å·²è¨˜éŒ„ï¼', 'success');
            }
            
            saveHistoryToStorage();
            syncToCloud();
            
            // æ¸…ç©ºè¡¨å–®
            resetForm();
            
            // æ›´æ–°é¡¯ç¤º
            displayHistory();
            updateChart();
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            const container = document.getElementById('foodSelectors');
            container.innerHTML = `
                <div class="food-selector">
                    <select id="foodSelect0">
                        <option value="">é¸æ“‡é£Ÿç‰©...</option>
                    </select>
                    <input type="number" id="grams0" placeholder="é‡é‡ (å…‹)" step="0.1" min="0">
                </div>
            `;
            
            foodSelectorCount = 1;
            populateFoodSelect('foodSelect0');
            document.getElementById('grams0').addEventListener('input', calculateCalories);
            
            document.getElementById('feedingSummary').style.display = 'none';
            document.getElementById('saveMealBtn').style.display = 'none';
            document.getElementById('saveMealBtn').textContent = 'å„²å­˜é€™é¤';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('actualEatenGrams').value = '';
            
            currentMeal = [];
            editingMealIndex = -1;
        }

        // é¡¯ç¤ºæ­·å²è¨˜éŒ„
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            
            if (mealHistory.length === 0) {
                historyList.innerHTML = '<p>å°šç„¡é£²é£Ÿè¨˜éŒ„</p>';
                return;
            }
            
            // æŒ‰æ—¥æœŸåˆ†çµ„
            const groupedHistory = {};
            mealHistory.forEach(meal => {
                if (!groupedHistory[meal.date]) {
                    groupedHistory[meal.date] = [];
                }
                groupedHistory[meal.date].push(meal);
            });
            
            historyList.innerHTML = '';
            
            Object.keys(groupedHistory).sort().reverse().forEach(date => {
                const dayMeals = groupedHistory[date];
                const dayTotal = dayMeals.reduce((sum, meal) => sum + (meal.actualCalories || meal.totalCalories || 0), 0);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'history-item';
                
                let mealsHtml = '';
                dayMeals.forEach((meal, mealIndex) => {
                    const globalMealIndex = mealHistory.findIndex(m => m === meal);
                    const foodsText = meal.foods.map(f => `${f.name} ${f.feedGrams}g`).join(', ');
                    mealsHtml += `
                        <div class="meal-detail" id="meal-${globalMealIndex}">
                            ${meal.time} - å¯¦éš›æ”å–: ${meal.actualCalories.toFixed(1)} kcal (é¤µ${meal.totalFeedGrams.toFixed(1)}gï¼Œåƒ${meal.actualEatenGrams.toFixed(1)}g)
                            <button class="edit-btn" onclick="editMeal(${globalMealIndex})">ç·¨è¼¯</button>
                            <button class="delete-btn" onclick="deleteMeal(${globalMealIndex})">åˆªé™¤</button>
                            <br>
                            <small>${foodsText}</small>
                        </div>
                    `;
                });
                
                dayElement.innerHTML = `
                    <div class="date-calories">${date} - ç¸½è¨ˆ: ${dayTotal.toFixed(1)} kcal</div>
                    ${mealsHtml}
                `;
                
                historyList.appendChild(dayElement);
            });
            
            // æ›´æ–°æ•¸æ“šä¾†æºé¡¯ç¤º
            updateDataSourceDisplay();
        }

        // æ›´æ–°åœ–è¡¨
        function updateChart() {
            const ctx = document.getElementById('caloriesChart').getContext('2d');
            
            // æº–å‚™åœ–è¡¨è³‡æ–™
            const dailyCalories = {};
            mealHistory.forEach(meal => {
                if (!dailyCalories[meal.date]) {
                    dailyCalories[meal.date] = 0;
                }
                dailyCalories[meal.date] += (meal.actualCalories || meal.totalCalories || 0);
            });
            
            const dates = Object.keys(dailyCalories).sort();
            const calories = dates.map(date => dailyCalories[date].toFixed(1));
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'æ¯æ—¥å¡è·¯é‡Œ',
                        data: calories,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å¡è·¯é‡Œ (kcal)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }

        // æœ¬åœ°å„²å­˜
        function saveHistoryToStorage() {
            localStorage.setItem('catFoodHistory', JSON.stringify(mealHistory));
        }

        function loadHistoryFromStorage() {
            const stored = localStorage.getItem('catFoodHistory');
            if (stored) {
                mealHistory = JSON.parse(stored);
                displayHistory();
            }
        }

        // é›²ç«¯åŒæ­¥åŠŸèƒ½
        async function syncToCloud() {
            // å¦‚æœæœ‰ GitHub è¨­å®šï¼Œè‡ªå‹•åŒæ­¥åˆ° GitHub
            if (githubToken && githubGistId) {
                try {
                    await saveToGitHub();
                    console.log('æ•¸æ“šå·²è‡ªå‹•åŒæ­¥åˆ° GitHub');
                } catch (error) {
                    console.warn('è‡ªå‹•åŒæ­¥åˆ° GitHub å¤±æ•—:', error);
                    showSyncStatus('è‡ªå‹•åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                }
            }
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.textContent = message;
            statusElement.className = `sync-status sync-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // ç·¨è¼¯é¤é»
        function editMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) return;
            
            editingMealIndex = mealIndex;
            
            // æ¸…ç©ºç¾æœ‰è¡¨å–®
            const container = document.getElementById('foodSelectors');
            container.innerHTML = '';
            
            // é‡å»ºè¡¨å–®ä»¥ç¬¦åˆè¦ç·¨è¼¯çš„é¤é»
            foodSelectorCount = 0;
            meal.foods.forEach((food, index) => {
                const newSelector = document.createElement('div');
                newSelector.className = 'food-selector';
                newSelector.innerHTML = `
                    <select id="foodSelect${foodSelectorCount}">
                        <option value="">é¸æ“‡é£Ÿç‰©...</option>
                    </select>
                    <input type="number" id="grams${foodSelectorCount}" placeholder="é‡é‡ (å…‹)" step="0.1" min="0" value="${food.feedGrams}">
                    ${foodSelectorCount > 0 ? '<button type="button" class="remove-btn" onclick="removeFoodSelector(this)">ç§»é™¤</button>' : ''}
                `;
                
                container.appendChild(newSelector);
                populateFoodSelect(`foodSelect${foodSelectorCount}`);
                
                // è¨­å®šé¸ä¸­çš„é£Ÿç‰©
                const foodIndex = foodDatabase.findIndex(f => f.name === food.name);
                if (foodIndex >= 0) {
                    document.getElementById(`foodSelect${foodSelectorCount}`).value = foodIndex;
                }
                
                document.getElementById(`grams${foodSelectorCount}`).addEventListener('input', calculateCalories);
                
                foodSelectorCount++;
            });
            
            // è¨­å®šå¯¦éš›æ”å–é‡
            document.getElementById('actualEatenGrams').value = meal.actualEatenGrams;
            
            // é‡æ–°è¨ˆç®—å¡è·¯é‡Œä»¥é¡¯ç¤ºé è¦½
            calculateCalories();
            
            // ä¿®æ”¹æŒ‰éˆ•æ–‡å­—
            document.getElementById('saveMealBtn').textContent = 'æ›´æ–°é¤é»';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            // æ»¾å‹•åˆ°è¡¨å–®é ‚éƒ¨
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            
            showSyncStatus('ç·¨è¼¯æ¨¡å¼ï¼šä¿®æ”¹å®Œæˆå¾Œé»æ“Šã€Œæ›´æ–°é¤é»ã€', 'success');
        }
        
        // åˆªé™¤é¤é»
        function deleteMeal(mealIndex) {
            const meal = mealHistory[mealIndex];
            if (!meal) {
                console.error('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„é¤é»ï¼Œç´¢å¼•:', mealIndex);
                alert('æ‰¾ä¸åˆ°è¦åˆªé™¤çš„è¨˜éŒ„ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }
            
            const confirmDelete = confirm(`ç¢ºå®šè¦åˆªé™¤ ${meal.date} ${meal.time} çš„é¤é»è¨˜éŒ„å—ï¼Ÿ\nå¯¦éš›æ”å–: ${meal.actualCalories.toFixed(1)} kcal`);
            
            if (confirmDelete) {
                console.log(`åˆªé™¤é¤é»ï¼Œç´¢å¼•: ${mealIndex}, åˆªé™¤å‰ç¸½æ•¸: ${mealHistory.length}`);
                mealHistory.splice(mealIndex, 1);
                console.log(`åˆªé™¤å¾Œç¸½æ•¸: ${mealHistory.length}`);
                
                saveHistoryToStorage();
                
                // æ›´æ–°é¡¯ç¤º
                displayHistory();
                updateChart();
                
                // è‡ªå‹•åŒæ­¥åˆ° GitHub
                syncToCloud();
                
                showSyncStatus('é¤é»è¨˜éŒ„å·²åˆªé™¤ä¸¦åŒæ­¥åˆ° GitHub', 'success');
            }
        }
        
        // å–æ¶ˆç·¨è¼¯
        function cancelEdit() {
            editingMealIndex = -1;
            resetForm();
            document.getElementById('saveMealBtn').textContent = 'å„²å­˜é€™é¤';
            showSyncStatus('å·²å–æ¶ˆç·¨è¼¯', 'success');
        }
        
        // ==================== é›²ç«¯åŒæ­¥åŠŸèƒ½ ====================





        // å°‹æ‰¾æ•¸æ“šè¡çª
        function findDataConflicts(localData, driveData) {
            const conflicts = [];
            const localMealMap = new Map();
            
            localData.forEach((meal, index) => {
                const key = `${meal.date}_${meal.time}`;
                localMealMap.set(key, { meal, index });
            });

            driveData.forEach((driveMeal, driveIndex) => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (localMealMap.has(key)) {
                    const localEntry = localMealMap.get(key);
                    if (JSON.stringify(localEntry.meal) !== JSON.stringify(driveMeal)) {
                        conflicts.push({
                            local: localEntry.meal,
                            drive: driveMeal,
                            localIndex: localEntry.index,
                            driveIndex: driveIndex
                        });
                    }
                }
            });

            return conflicts;
        }

        // åˆä½µæ•¸æ“šé™£åˆ—
        function mergeDataArrays(localData, driveData) {
            const merged = [...localData];
            const localKeys = new Set(localData.map(meal => `${meal.date}_${meal.time}`));

            driveData.forEach(driveMeal => {
                const key = `${driveMeal.date}_${driveMeal.time}`;
                if (!localKeys.has(key)) {
                    merged.push(driveMeal);
                }
            });

            // æŒ‰æ—¥æœŸæ™‚é–“æ’åº
            return merged.sort((a, b) => {
                const dateA = new Date(`${a.date} ${a.time}`);
                const dateB = new Date(`${b.date} ${b.time}`);
                return dateB - dateA;
            });
        }

        // è™•ç†æ•¸æ“šè¡çª
        function handleDataConflicts(driveData, fileName, conflicts) {
            const message = `åœ¨åˆä½µ ${fileName} æ™‚ç™¼ç¾ ${conflicts.length} å€‹è¡çªè¨˜éŒ„ã€‚\n\n` +
                           `é¸æ“‡è™•ç†æ–¹å¼ï¼š\n` +
                           `â€¢ ç¢ºå®šï¼šä½¿ç”¨ Google Drive ç‰ˆæœ¬è¦†è“‹æœ¬åœ°ç‰ˆæœ¬\n` +
                           `â€¢ å–æ¶ˆï¼šä¿ç•™æœ¬åœ°ç‰ˆæœ¬ï¼Œå¿½ç•¥ Google Drive ç‰ˆæœ¬`;
            
            if (confirm(message)) {
                // ä½¿ç”¨ Drive ç‰ˆæœ¬
                conflicts.forEach(conflict => {
                    mealHistory[conflict.localIndex] = conflict.drive;
                });
                
                // åˆä½µå…¶ä»–éè¡çªè¨˜éŒ„
                const mergedData = mergeDataArrays(mealHistory, driveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`å·²ä½¿ç”¨ Google Drive ç‰ˆæœ¬è§£æ±º ${conflicts.length} å€‹è¡çª`, 'success');
            } else {
                // ä¿ç•™æœ¬åœ°ç‰ˆæœ¬ï¼Œåªåˆä½µéè¡çªè¨˜éŒ„
                const nonConflictDriveData = driveData.filter(driveMeal => {
                    const key = `${driveMeal.date}_${driveMeal.time}`;
                    return !conflicts.some(conflict => 
                        `${conflict.drive.date}_${conflict.drive.time}` === key
                    );
                });
                
                const mergedData = mergeDataArrays(mealHistory, nonConflictDriveData);
                mealHistory = mergedData;
                
                saveHistoryToStorage();
                displayHistory();
                updateChart();
                showSyncStatus(`å·²ä¿ç•™æœ¬åœ°ç‰ˆæœ¬ï¼Œåˆä½µäº† ${nonConflictDriveData.length} ç­†éè¡çªè¨˜éŒ„`, 'success');
            }
        }

        // åˆ‡æ›è‡ªå‹•åŒæ­¥
        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSync').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled.toString());
            
            if (autoSyncEnabled) {
                showSyncStatus('å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥åˆ° Google Drive', 'success');
            } else {
                showSyncStatus('å·²åœç”¨è‡ªå‹•åŒæ­¥', 'success');
            }
        }

        // è¼‰å…¥è‡ªå‹•åŒæ­¥è¨­å®š
        function loadAutoSyncSetting() {
            const saved = localStorage.getItem('autoSyncEnabled');
            if (saved !== null) {
                autoSyncEnabled = saved === 'true';
                document.getElementById('autoSync').checked = autoSyncEnabled;
            }
        }

        // é¡¯ç¤ºå¾Œå‚™èªè­‰é¸é …
        function showFallbackAuth() {
            // loadingAuth å…ƒç´ å·²ç§»é™¤
            document.getElementById('fallbackAuth').style.display = 'block';
            
            // æ·»åŠ èª¿è©¦ä¿¡æ¯
            const debugInfo = {
                gapi: typeof gapi !== 'undefined',
                google: typeof google !== 'undefined',
                isGoogleApiLoaded: isGoogleApiLoaded,
                currentURL: window.location.href,
                userAgent: navigator.userAgent
            };
            
            console.warn('Google API è¼‰å…¥è¶…æ™‚ï¼Œé¡¯ç¤ºå¾Œå‚™é¸é …');
            console.log('èª¿è©¦ä¿¡æ¯:', debugInfo);
        }

        // èª¿è©¦æ¨¡å¼ - æª¢æŸ¥ Google API ç‹€æ…‹
        function debugGoogleAPI() {
            console.log('=== Google API èª¿è©¦ä¿¡æ¯ ===');
            console.log('gapi æ˜¯å¦å·²è¼‰å…¥:', typeof gapi !== 'undefined');
            console.log('google æ˜¯å¦å·²è¼‰å…¥:', typeof google !== 'undefined');
            console.log('isGoogleApiLoaded:', isGoogleApiLoaded);
            console.log('isAuthorized:', isAuthorized);
            console.log('ç•¶å‰ç¶²å€:', window.location.href);
            console.log('GOOGLE_CONFIG:', GOOGLE_CONFIG);
            
            if (typeof gapi !== 'undefined') {
                console.log('gapi.client:', gapi.client);
                try {
                    console.log('gapi.client.getToken():', gapi.client.getToken());
                } catch (e) {
                    console.log('ç²å– token å¤±æ•—:', e.message);
                }
            }
            
            console.log('=== èª¿è©¦ä¿¡æ¯çµæŸ ===');
        }

        // å•Ÿç”¨é›¢ç·šæ¨¡å¼
        function enableOfflineMode() {
            // loadingAuth å…ƒç´ å·²ç§»é™¤
            // fallbackAuth å…ƒç´ å·²ç§»é™¤
            document.getElementById('googleAuth').innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px;">
                    <h4>ğŸ“± æœ¬åœ°æ¨¡å¼å·²å•Ÿç”¨</h4>
                    <p>âœ… <strong>æ‰€æœ‰åŠŸèƒ½éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼</strong></p>
                    <p>æ‚¨çš„æ•¸æ“šå°‡ä¿å­˜åœ¨æ­¤ç€è¦½å™¨çš„æœ¬åœ°å­˜å„²ä¸­ã€‚</p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>ğŸ“‹ æœ¬åœ°æ¨¡å¼åŠŸèƒ½ï¼š</h5>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>âœ… è¨˜éŒ„é¤é»å’Œå¡è·¯é‡Œ</li>
                            <li>âœ… ç·¨è¼¯å’Œåˆªé™¤è¨˜éŒ„</li>
                            <li>âœ… æŸ¥çœ‹å¡è·¯é‡Œè¶¨å‹¢åœ–</li>
                            <li>âœ… æ•¸æ“šè‡ªå‹•ä¿å­˜</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h5>ğŸ’¾ æ•¸æ“šå‚™ä»½å»ºè­°ï¼š</h5>
                        <p style="margin: 5px 0;">å®šæœŸåŒ¯å‡ºæ•¸æ“šä»¥é˜²è³‡æ–™éºå¤±ï¼š</p>
                        <button onclick="exportLocalData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px 0;">åŒ¯å‡ºæ•¸æ“š</button>
                        <small style="display: block; margin-top: 5px;">å°‡æ•¸æ“šä¸‹è¼‰ç‚º JSON æª”æ¡ˆä¿å­˜</small>
                    </div>
                    
                    <p><small>ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥éš¨æ™‚é‡æ–°æ•´ç†é é¢ä¾†é‡è©¦ Google Drive åŠŸèƒ½ã€‚</small></p>
                </div>
            `;
            // googleAuth å…ƒç´ å·²ç§»é™¤
            
            showSyncStatus('å·²å•Ÿç”¨æœ¬åœ°æ¨¡å¼ - æ‰€æœ‰åŠŸèƒ½éƒ½å¯æ­£å¸¸ä½¿ç”¨ï¼', 'success');
            console.log('æœ¬åœ°æ¨¡å¼å·²å•Ÿç”¨');
        }

        // Google API é€£ç·šæ¸¬è©¦
        async function testGoogleAPI() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<p>ğŸ” æ­£åœ¨é€²è¡Œè©³ç´°æ¸¬è©¦...</p>';
            
            const tests = [];
            
            // æ¸¬è©¦ 1: åŸºæœ¬ API è…³æœ¬è¼‰å…¥
            try {
                const response = await fetch('https://apis.google.com/js/api.js');
                tests.push(`âœ… Google API è…³æœ¬å¯è¨ªå• (${response.status})`);
            } catch (error) {
                tests.push(`âŒ Google API è…³æœ¬ç„¡æ³•è¨ªå•: ${error.message}`);
            }
            
            // æ¸¬è©¦ 2: Google Identity Services (è©³ç´°æ¸¬è©¦)
            try {
                const response = await fetch('https://accounts.google.com/gsi/client', { method: 'HEAD' });
                tests.push(`âœ… Google Identity Services å¯è¨ªå• (${response.status})`);
            } catch (error) {
                tests.push(`âŒ Google Identity Services ç„¡æ³•è¨ªå•: ${error.message}`);
            }
            
            // æ¸¬è©¦ 3: æ›¿ä»£ Google æœå‹™æ¸¬è©¦
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo?access_token=test', { method: 'HEAD' });
                tests.push(`âœ… Google OAuth API å¯è¨ªå• (${response.status})`);
            } catch (error) {
                tests.push(`âŒ Google OAuth API ç„¡æ³•è¨ªå•: ${error.message}`);
            }
            
            // æ¸¬è©¦ 4: Google ä¸»åŸŸåæ¸¬è©¦
            try {
                const response = await fetch('https://accounts.google.com', { method: 'HEAD', mode: 'no-cors' });
                tests.push(`âœ… Google ä¸»åŸŸåå¯è¨ªå•`);
            } catch (error) {
                tests.push(`âŒ Google ä¸»åŸŸåç„¡æ³•è¨ªå•: ${error.message}`);
            }
            
            // æ¸¬è©¦ 5: æª¢æŸ¥è…³æœ¬è¼‰å…¥éŒ¯èª¤
            if (scriptErrors.length > 0) {
                tests.push(`âŒ è…³æœ¬è¼‰å…¥éŒ¯èª¤: ${scriptErrors.join(', ')}`);
            } else {
                tests.push(`âœ… æ²’æœ‰æª¢æ¸¬åˆ°è…³æœ¬è¼‰å…¥éŒ¯èª¤`);
            }
            
            // æ¸¬è©¦ 6: æª¢æŸ¥è®Šæ•¸
            tests.push(`gapi è®Šæ•¸: ${typeof gapi !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}`);
            tests.push(`google è®Šæ•¸: ${typeof google !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'}`);
            
            // æ¸¬è©¦ 7: ç€è¦½å™¨ç’°å¢ƒæª¢æŸ¥
            tests.push(`ç€è¦½å™¨: ${navigator.userAgent.split(' ')[0]}`);
            tests.push(`æ˜¯å¦æ”¯æ´ fetch: ${typeof fetch !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            tests.push(`æ˜¯å¦ç‚º HTTPS: ${location.protocol === 'https:' ? 'âœ…' : 'âŒ'}`);
            tests.push(`ç¬¬ä¸‰æ–¹ Cookie: ${navigator.cookieEnabled ? 'âœ… å•Ÿç”¨' : 'âŒ ç¦ç”¨'}`);
            
            // æ¸¬è©¦ 8: æª¢æŸ¥å¯èƒ½çš„é˜»æ“‹å› ç´ 
            const blockers = [];
            if (window.chrome && window.chrome.runtime) {
                blockers.push('Chrome æ“´å±•å¯èƒ½å½±éŸ¿');
            }
            if (navigator.brave) {
                blockers.push('Brave ç€è¦½å™¨å…§å»ºé˜»æ“‹');
            }
            if (window.safari) {
                blockers.push('Safari è¿½è¹¤é˜²è­·å¯èƒ½å½±éŸ¿');
            }
            if (blockers.length > 0) {
                tests.push(`âš ï¸ åµæ¸¬åˆ°æ½›åœ¨é˜»æ“‹å› ç´ : ${blockers.join(', ')}`);
            }
            
            // åˆ¤æ–·ä¸»è¦å•é¡Œä¸¦æä¾›è§£æ±ºæ–¹æ¡ˆ
            let mainIssue = '';
            let solutions = [];
            
            if (tests.some(test => test.includes('Google Identity Services ç„¡æ³•è¨ªå•'))) {
                mainIssue = 'ğŸ”’ Google Identity Services è¢«é˜»æ“‹';
                solutions = [];
                
                // æ ¹æ“šæª¢æ¸¬åˆ°çš„æƒ…æ³æä¾›å…·é«”å»ºè­°
                if (tests.some(test => test.includes('Brave ç€è¦½å™¨'))) {
                    solutions.push('Brave: è¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨ â†’ é—œé–‰ã€Œé˜»æ“‹è…³æœ¬ã€');
                }
                if (tests.some(test => test.includes('Safari'))) {
                    solutions.push('Safari: åå¥½è¨­å®š â†’ éš±ç§æ¬Š â†’ é—œé–‰ã€Œé˜²æ­¢è·¨ç¶²ç«™è¿½è¹¤ã€');
                }
                if (tests.some(test => test.includes('Chrome æ“´å±•'))) {
                    solutions.push('æª¢æŸ¥ Chrome æ“´å±•ï¼Œæš«æ™‚åœç”¨å®‰å…¨ç›¸é—œæ“´å±•');
                }
                
                // Chrome å°ˆç”¨å»ºè­°
                if (navigator.userAgent.includes('Chrome')) {
                    solutions.unshift('ğŸŒ Chrome å°ˆç”¨è§£æ±ºæ–¹æ¡ˆï¼š');
                    solutions.unshift('1. è¨­å®š â†’ éš±ç§æ¬Šå’Œå®‰å…¨æ€§ â†’ ç¶²ç«™è¨­å®š â†’ JavaScript â†’ å…è¨±');
                    solutions.unshift('2. è¨­å®š â†’ éš±ç§æ¬Šå’Œå®‰å…¨æ€§ â†’ ç¶²ç«™è¨­å®š â†’ Cookie â†’ å…è¨±ç¬¬ä¸‰æ–¹ Cookie');
                    solutions.unshift('3. è¨­å®š â†’ éš±ç§æ¬Šå’Œå®‰å…¨æ€§ â†’ å®‰å…¨ç€è¦½ â†’ é¸æ“‡ã€Œæ¨™æº–ä¿è­·ã€');
                    solutions.unshift('4. æª¢æŸ¥æ˜¯å¦å•Ÿç”¨äº†ã€Œå¢å¼·å‹ä¿è­·ã€â†’ æ”¹ç‚ºã€Œæ¨™æº–ä¿è­·ã€');
                    solutions.unshift('5. ç¶²å€åˆ— â†’ é»æ“Šé–é ­åœ–ç¤º â†’ Cookie â†’ å…è¨±æ­¤ç¶²ç«™çš„ Cookie');
                    solutions.unshift('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                } else if (navigator.userAgent.includes('Mozilla') && navigator.userAgent.includes('Firefox')) {
                    solutions.unshift('ğŸ¦Š Firefox è¨­å®šï¼š');
                    solutions.unshift('1. ç¶²å€åˆ—è¼¸å…¥ about:config â†’ æœå°‹ privacy.resistFingerprinting â†’ è¨­ç‚º false');
                    solutions.unshift('2. è¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨ â†’ å¢å¼·å‹è¿½è¹¤ä¿è­· â†’ é¸æ“‡ã€Œæ¨™æº–ã€');
                    solutions.unshift('3. è¨­å®š â†’ éš±ç§æ¬Šèˆ‡å®‰å…¨ â†’ Cookie â†’ é¸æ“‡ã€Œæ¨™æº–ã€');
                }
                
                // é€šç”¨è§£æ±ºæ–¹æ¡ˆ
                solutions.push('æª¢æŸ¥ç€è¦½å™¨éš±ç§æ¬Šè¨­å®šï¼Œå…è¨±ç¬¬ä¸‰æ–¹è…³æœ¬');
                solutions.push('å˜—è©¦ç„¡ç—•/ç§äººç€è¦½æ¨¡å¼');
                solutions.push('æª¢æŸ¥ç¶²è·¯æ˜¯å¦æœ‰ä¼æ¥­é˜²ç«ç‰†æˆ–éæ¿¾å™¨');
                solutions.push('å˜—è©¦é—œé–‰ VPN æˆ–ä»£ç†ä¼ºæœå™¨');
                solutions.push('æª¢æŸ¥é˜²æ¯’è»Ÿé«”æ˜¯å¦é˜»æ“‹ Google æœå‹™');
                solutions.push('æˆ–ç›´æ¥ä½¿ç”¨ã€Œåƒ…ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€');
                
            } else if (typeof gapi === 'undefined') {
                mainIssue = 'ğŸ“¡ Google API è…³æœ¬è¼‰å…¥å¤±æ•—';
                solutions = [
                    'æª¢æŸ¥ç¶²è·¯é€£ç·š',
                    'é‡æ–°è¼‰å…¥é é¢',
                    'æ¸…é™¤ç€è¦½å™¨ç·©å­˜',
                    'å˜—è©¦ä¸åŒçš„ DNS è¨­å®š (å¦‚ 8.8.8.8)'
                ];
            }

            resultsDiv.innerHTML = `
                <h5>ğŸ” æ¸¬è©¦çµæœï¼š</h5>
                <ul style="margin: 0; padding-left: 20px; font-size: 11px;">
                    ${tests.map(test => `<li>${test}</li>`).join('')}
                </ul>
                ${mainIssue ? `
                    <div style="margin: 10px 0; padding: 8px; background: #fff3cd; border-radius: 4px;">
                        <strong style="font-size: 12px;">${mainIssue}</strong>
                        <ol style="margin: 5px 0 0 0; padding-left: 18px; font-size: 11px;">
                            ${solutions.map(solution => `<li>${solution}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
            `;
        }

        // é¡¯ç¤ºä¿®å¾©æŒ‡å—
        function showFixGuide() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px; margin: 10px 0;">
                    <h5>ğŸ”§ Chrome å°ˆç”¨ä¿®å¾©æŒ‡å—</h5>
                    <p><strong>æœ€å¸¸è¦‹åŸå› ï¼šChrome çš„å®‰å…¨ç€è¦½è¨­å®šéæ–¼åš´æ ¼</strong></p>
                    
                    <h6>ğŸ¯ ç«‹å³å˜—è©¦ï¼š</h6>
                    <ol style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li><strong>æª¢æŸ¥ç¶²å€åˆ—é–é ­</strong>ï¼šé»æ“Šç¶²å€åˆ—å·¦å´çš„é–é ­åœ–ç¤º â†’ Cookie â†’ ã€Œå…è¨±ã€</li>
                        <li><strong>æª¢æŸ¥å®‰å…¨ç€è¦½</strong>ï¼šChrome è¨­å®š â†’ éš±ç§æ¬Šå’Œå®‰å…¨æ€§ â†’ å®‰å…¨ç€è¦½ â†’ é¸æ“‡ã€Œæ¨™æº–ä¿è­·ã€</li>
                        <li><strong>å…è¨±ç¬¬ä¸‰æ–¹ Cookie</strong>ï¼šè¨­å®š â†’ éš±ç§æ¬Šå’Œå®‰å…¨æ€§ â†’ ç¶²ç«™è¨­å®š â†’ Cookie â†’ å…è¨±ç¬¬ä¸‰æ–¹ Cookie</li>
                        <li><strong>ç„¡ç—•æ¨¡å¼æ¸¬è©¦</strong>ï¼šCtrl+Shift+N é–‹å•Ÿç„¡ç—•è¦–çª—æ¸¬è©¦</li>
                    </ol>
                    
                    <h6>ğŸ” å…¶ä»–å¯èƒ½åŸå› ï¼š</h6>
                    <ul style="margin: 10px 0; padding-left: 20px; font-size: 12px;">
                        <li>ä¼æ¥­æˆ–å­¸æ ¡ç¶²è·¯é˜»æ“‹ OAuth æœå‹™</li>
                        <li>é˜²æ¯’è»Ÿé«”æˆ–ç¶²è·¯å®‰å…¨è»Ÿé«”å¹²æ“¾</li>
                        <li>ISP æˆ– DNS éæ¿¾æœå‹™</li>
                        <li>Chrome æ“´å±•ç¨‹å¼è¡çª</li>
                    </ul>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <strong>ğŸ’¡ å¿«é€Ÿæ¸¬è©¦ï¼š</strong>å¦‚æœä¸Šè¿°æ–¹æ³•éƒ½ä¸è¡Œï¼Œè«‹é»æ“Šã€Œæœ¬åœ°æ¨¡å¼ã€ç›´æ¥ä½¿ç”¨æ‡‰ç”¨ï¼
                    </div>
                </div>
            `;
        }

        // å˜—è©¦ç„¡ç—•æ¨¡å¼
        function tryIncognitoMode() {
            const url = window.location.href;
            const message = `è«‹å˜—è©¦åœ¨ç„¡ç—•/ç§äººç€è¦½æ¨¡å¼ä¸‹é–‹å•Ÿï¼š\n\n${url}\n\nå¿«æ·éµï¼š\nChrome/Edge: Ctrl+Shift+N\nFirefox: Ctrl+Shift+P\nSafari: Cmd+Shift+N`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'è²“å’ªé£²é£Ÿè¿½è¹¤å™¨',
                    url: url
                }).catch(() => {
                    alert(message);
                });
            } else {
                alert(message);
                // å˜—è©¦è¤‡è£½åˆ°å‰ªè²¼æ¿
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(url);
                }
            }
        }

        // æ›´æ–°æ•¸æ“šä¾†æºé¡¯ç¤º
        function updateDataSourceDisplay() {
            const sourceElement = document.getElementById('dataSource');
            if (!sourceElement) return;
            
            const hasGitHubToken = githubToken && githubGistId;
            
            if (dataSource === 'github' && hasGitHubToken) {
                sourceElement.innerHTML = '(ğŸ“‚ GitHub é›²ç«¯æ•¸æ“š)';
                sourceElement.style.color = '#28a745';
            } else if (hasGitHubToken) {
                sourceElement.innerHTML = '(ğŸ’¾ æœ¬åœ°æ•¸æ“š + GitHub åŒæ­¥)';
                sourceElement.style.color = '#17a2b8';
            } else {
                sourceElement.innerHTML = '(ğŸ’¾ åƒ…æœ¬åœ°æ•¸æ“š)';
                sourceElement.style.color = '#ffc107';
            }
        }

        // ==================== æ™ºèƒ½é£Ÿç‰©æœç´¢åŠŸèƒ½ ====================
        
        let currentActiveFilters = {
            brand: '',
            category: '',
            meat: [],
            search: ''
        };

        // åˆå§‹åŒ–æ™ºèƒ½é£Ÿç‰©æœç´¢
        function initSmartFoodSearch() {
            // åˆå§‹åŒ–å“ç‰Œé¸é …
            const brands = [...new Set(foodDatabase.map(food => food.brand))].sort();
            const brandFilter = document.getElementById('brandFilter');
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilter.appendChild(option);
            });

            // åˆå§‹åŒ–è‚‰é¡æ¨™ç±¤
            const allMeats = [...new Set(foodDatabase.flatMap(food => food.meat))].sort();
            const meatFilters = document.getElementById('meatFilters');
            allMeats.forEach(meat => {
                if (meat !== 'æ··åˆ') {
                    const tag = document.createElement('span');
                    tag.className = 'meat-tag';
                    tag.textContent = meat;
                    tag.onclick = () => toggleMeatFilter(meat, tag);
                    tag.style.cssText = `
                        background: #e9ecef; 
                        border: 1px solid #ced4da; 
                        padding: 4px 8px; 
                        border-radius: 12px; 
                        font-size: 12px; 
                        cursor: pointer;
                        user-select: none;
                        transition: all 0.2s;
                    `;
                    meatFilters.appendChild(tag);
                }
            });

            // åˆå§‹é¡¯ç¤ºæ‰€æœ‰é£Ÿç‰©
            displayFilteredFoods(foodDatabase);
        }

        // åˆ‡æ›è‚‰é¡ç¯©é¸
        function toggleMeatFilter(meat, element) {
            const index = currentActiveFilters.meat.indexOf(meat);
            if (index > -1) {
                currentActiveFilters.meat.splice(index, 1);
                element.style.background = '#e9ecef';
                element.style.color = '#495057';
            } else {
                currentActiveFilters.meat.push(meat);
                element.style.background = '#007bff';
                element.style.color = 'white';
            }
            filterFoods();
        }

        // ç¯©é¸é£Ÿç‰©
        function filterFoods() {
            const brandFilter = document.getElementById('brandFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();

            currentActiveFilters.brand = brandFilter;
            currentActiveFilters.category = categoryFilter;
            currentActiveFilters.search = searchInput;

            let filteredFoods = foodDatabase.filter(food => {
                // å“ç‰Œç¯©é¸
                if (brandFilter && food.brand !== brandFilter) return false;
                
                // åˆ†é¡ç¯©é¸
                if (categoryFilter && food.category !== categoryFilter) return false;
                
                // è‚‰é¡ç¯©é¸
                if (currentActiveFilters.meat.length > 0) {
                    const hasSelectedMeat = currentActiveFilters.meat.some(selectedMeat => 
                        food.meat.includes(selectedMeat)
                    );
                    if (!hasSelectedMeat) return false;
                }
                
                // é—œéµå­—æœç´¢
                if (searchInput) {
                    const searchText = `${food.name} ${food.brand} ${food.meat.join(' ')}`.toLowerCase();
                    if (!searchText.includes(searchInput)) return false;
                }
                
                return true;
            });

            // æŒ‰ç†±é‡æ’åº
            filteredFoods.sort((a, b) => a.calories - b.calories);

            displayFilteredFoods(filteredFoods);
        }

        // é¡¯ç¤ºç¯©é¸çµæœ
        function displayFilteredFoods(foods) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (foods.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é£Ÿç‰©</div>';
                return;
            }

            let html = '';
            foods.slice(0, 20).forEach((food, index) => { // é™åˆ¶é¡¯ç¤ºå‰20é …
                const meatText = food.meat.join(', ');
                const calorieColor = getCalorieColor(food.calories);
                
                html += `
                    <div class="search-result-item" onclick="selectFoodFromSearch(${foodDatabase.indexOf(food)})" 
                         style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; hover:background-color: #f8f9fa;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">${food.name}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-size: 12px; color: #666;">
                                <span style="background: #e7f3ff; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${food.brand}</span>
                                <span style="background: #f0f8f0; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">${food.category}</span>
                                <span style="background: #fff3e0; padding: 2px 6px; border-radius: 3px;">${food.texture}</span>
                            </div>
                            <div style="font-weight: bold; color: ${calorieColor};">${food.calories} kcal/100g</div>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 4px;">ğŸ¥© ${meatText}</div>
                    </div>
                `;
            });

            if (foods.length > 20) {
                html += `<div style="padding: 10px; text-align: center; color: #666; font-size: 12px;">é‚„æœ‰ ${foods.length - 20} é …é£Ÿç‰©ï¼Œè«‹ç¸®å°æœç´¢ç¯„åœ</div>`;
            }

            resultsContainer.innerHTML = html;
        }

        // å¾æœç´¢çµæœé¸æ“‡é£Ÿç‰©
        function selectFoodFromSearch(foodIndex) {
            // æ‰¾åˆ°ç•¶å‰æ´»èºçš„é£Ÿç‰©é¸æ“‡å™¨
            const selectors = document.querySelectorAll('#foodSelectors select');
            let targetSelector = null;
            
            // æ‰¾åˆ°ç¬¬ä¸€å€‹ç©ºçš„é¸æ“‡å™¨
            for (let selector of selectors) {
                if (selector.value === '') {
                    targetSelector = selector;
                    break;
                }
            }
            
            // å¦‚æœæ²’æœ‰ç©ºçš„é¸æ“‡å™¨ï¼Œå‰µå»ºä¸€å€‹æ–°çš„
            if (!targetSelector) {
                addFoodSelector();
                const newSelectors = document.querySelectorAll('#foodSelectors select');
                targetSelector = newSelectors[newSelectors.length - 1];
            }
            
            // è¨­ç½®é¸ä¸­çš„é£Ÿç‰©
            targetSelector.value = foodIndex;
            
            // è§¸ç™¼è®Šæ›´äº‹ä»¶
            const event = new Event('change');
            targetSelector.dispatchEvent(event);
            
            // èšç„¦åˆ°å°æ‡‰çš„é‡é‡è¼¸å…¥æ¡†
            const selectorIndex = Array.from(selectors).indexOf(targetSelector);
            const gramsInput = document.getElementById(`grams${selectorIndex}`);
            if (gramsInput) {
                gramsInput.focus();
            }
            
            showSyncStatus(`å·²é¸æ“‡ï¼š${foodDatabase[foodIndex].name}`, 'success');
        }

        // ç²å–ç†±é‡é¡è‰²
        function getCalorieColor(calories) {
            if (calories < 80) return '#28a745';      // ç¶ è‰² - ä½ç†±é‡
            if (calories < 120) return '#ffc107';    // é»ƒè‰² - ä¸­ç­‰ç†±é‡
            if (calories < 200) return '#fd7e14';    // æ©™è‰² - è¼ƒé«˜ç†±é‡
            return '#dc3545';                        // ç´…è‰² - é«˜ç†±é‡
        }

        // é¡¯ç¤ºé›²ç«¯é¸é …
        function showCloudOptions() {
            // ç›´æ¥é¡¯ç¤ºé›²ç«¯åŒæ­¥é¸é …
            document.getElementById('cloudOptions').style.display = 'block';
        }

        // GitHub Gist åŒæ­¥è¨­ç½®
        function setupGitHubSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>ğŸ—‚ï¸ GitHub Gist åŒæ­¥è¨­ç½®</h4>
                    <p>GitHub Gist æ˜¯å…è²»ã€ç©©å®šçš„ä»£ç¢¼ç‰‡æ®µå­˜å„²æœå‹™ï¼Œéå¸¸é©åˆå­˜å„²æ‚¨çš„è²“å’ªé£²é£Ÿæ•¸æ“šã€‚</p>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>æ­¥é©Ÿ 1ï¼šå»ºç«‹ GitHub å¸³æˆ¶</h6>
                        <p>å¦‚æœæ‚¨é‚„æ²’æœ‰ GitHub å¸³æˆ¶ï¼š</p>
                        <a href="https://github.com/join" target="_blank" style="background: #333; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">è¨»å†Š GitHub</a>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>æ­¥é©Ÿ 2ï¼šå‰µå»ºå€‹äººè¨ªå•ä»¤ç‰Œ</h6>
                        <p>1. ç™»å…¥ GitHub â†’ è¨­å®š â†’ Developer settings â†’ Personal access tokens</p>
                        <p>2. é»æ“Š "Generate new token" â†’ é¸æ“‡ "gist" æ¬Šé™</p>
                        <p>3. è¤‡è£½ç”Ÿæˆçš„ä»¤ç‰Œ</p>
                        <a href="https://github.com/settings/tokens" target="_blank" style="background: #333; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px;">å»ºç«‹ä»¤ç‰Œ</a>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>æ­¥é©Ÿ 3ï¼šè¨­ç½®åŒæ­¥</h6>
                        <p>å°‡æ‚¨çš„ GitHub ä»¤ç‰Œè²¼åœ¨ä¸‹é¢ï¼š</p>
                        <input type="password" id="githubToken" placeholder="è²¼ä¸Šæ‚¨çš„ GitHub å€‹äººè¨ªå•ä»¤ç‰Œ" style="width: 100%; padding: 8px; margin: 5px 0;">
                        <button onclick="initGitHubSync()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">é–‹å§‹ä½¿ç”¨ GitHub åŒæ­¥</button>
                        <div id="githubSetupResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <button onclick="showCloudOptions()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¿”å›é¸é …</button>
                </div>
            `;
            document.getElementById('cloudOptions').innerHTML = content;
        }

        // æ‰‹å‹•åŒæ­¥
        function showManualSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>ğŸ“‹ æ‰‹å‹•æ•¸æ“šåŒæ­¥</h4>
                    <p>ä½¿ç”¨åˆ†äº«é€£çµæˆ–äºŒç¶­ç¢¼åœ¨è¨­å‚™é–“å¿«é€ŸåŒæ­¥æ•¸æ“šã€‚</p>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¤ å¾æ­¤è¨­å‚™åˆ†äº«æ•¸æ“š</h6>
                        <button onclick="generateShareLink()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ç”Ÿæˆåˆ†äº«é€£çµ</button>
                        <button onclick="generateQRCode()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ç”ŸæˆäºŒç¶­ç¢¼</button>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¥ è¼‰å…¥å…¶ä»–è¨­å‚™çš„æ•¸æ“š</h6>
                        <input type="text" id="shareLink" placeholder="è²¼ä¸Šåˆ†äº«é€£çµ" style="width: 100%; padding: 8px; margin: 5px 0;">
                        <button onclick="loadFromShareLink()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¼‰å…¥æ•¸æ“š</button>
                    </div>
                    
                    <div id="shareResult" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¿”å›é¸é …</button>
                </div>
            `;
            document.getElementById('cloudOptions').innerHTML = content;
        }

        // æ–‡ä»¶åŒæ­¥
        function showFileSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>ğŸ’¾ æ–‡ä»¶å­˜å„²åŒæ­¥</h4>
                    <p>å°‡æ•¸æ“šåŒ¯å‡ºç‚º JSON æ–‡ä»¶ï¼Œä¿å­˜åˆ°æ‚¨çš„é›²ç«¯ç¡¬ç¢Ÿï¼ˆå¦‚ Dropboxã€OneDriveã€iCloudï¼‰ã€‚</p>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¤ åŒ¯å‡ºæ•¸æ“š</h6>
                        <p>å°‡ç•¶å‰æ•¸æ“šä¸‹è¼‰ç‚º JSON æ–‡ä»¶ï¼š</p>
                        <button onclick="exportLocalData()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ä¸‹è¼‰æ•¸æ“šæ–‡ä»¶</button>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¥ åŒ¯å…¥æ•¸æ“š</h6>
                        <p>å¾ JSON æ–‡ä»¶è¼‰å…¥æ•¸æ“šï¼š</p>
                        <input type="file" id="importFile" accept=".json" style="margin: 5px 0;">
                        <button onclick="importFromFile()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¼‰å…¥æ–‡ä»¶</button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ’¡ ä½¿ç”¨å»ºè­°</h6>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>å®šæœŸåŒ¯å‡ºæ•¸æ“šå‚™ä»½</li>
                            <li>å°‡æ–‡ä»¶ä¿å­˜åˆ°é›²ç«¯ç¡¬ç¢Ÿ</li>
                            <li>åœ¨å…¶ä»–è¨­å‚™ä¸ŠåŒ¯å…¥æ–‡ä»¶</li>
                            <li>å¯ä»¥è¨­å®šæ–‡ä»¶ååŒ…å«æ—¥æœŸæ–¹ä¾¿ç®¡ç†</li>
                        </ul>
                    </div>
                    
                    <button onclick="showCloudOptions()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¿”å›é¸é …</button>
                </div>
            `;
            document.getElementById('cloudOptions').innerHTML = content;
        }

        // åœ¨ç·šå‰ªè²¼æ¿åŒæ­¥
        function showPastebinSync() {
            const content = `
                <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px;">
                    <h4>ğŸ”— åœ¨ç·šå‰ªè²¼æ¿åŒæ­¥</h4>
                    <p>ä½¿ç”¨åœ¨ç·šå‰ªè²¼æ¿æœå‹™ï¼ˆå¦‚ Pastebinï¼‰åˆ†äº«æ•¸æ“šã€‚</p>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¤ ä¸Šå‚³æ•¸æ“šåˆ°å‰ªè²¼æ¿</h6>
                        <button onclick="uploadToPastebin()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ä¸Šå‚³åˆ° Pastebin</button>
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“¥ å¾å‰ªè²¼æ¿è¼‰å…¥æ•¸æ“š</h6>
                        <input type="text" id="pastebinUrl" placeholder="è²¼ä¸Š Pastebin é€£çµ" style="width: 100%; padding: 8px; margin: 5px 0;">
                        <button onclick="loadFromPastebin()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¼‰å…¥æ•¸æ“š</button>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>âš ï¸ éš±ç§æé†’</h6>
                        <p>ä½¿ç”¨å…¬é–‹å‰ªè²¼æ¿æœå‹™æ™‚ï¼Œæ‚¨çš„æ•¸æ“šæœƒæš«æ™‚å…¬é–‹ã€‚å»ºè­°åªåœ¨å¿…è¦æ™‚ä½¿ç”¨ï¼Œæˆ–ä½¿ç”¨ç§äººæ¨¡å¼ã€‚</p>
                    </div>
                    
                    <div id="pastebinResult" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¿”å›é¸é …</button>
                </div>
            `;
            document.getElementById('cloudOptions').innerHTML = content;
        }

        // åŒ¯å‡ºæœ¬åœ°æ•¸æ“š
        function exportLocalData() {
            try {
                const dataToExport = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    source: 'local_storage',
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null,
                        exportedFrom: window.location.href
                    }
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `è²“å’ªé£Ÿç‰©è¿½è¹¤æ•¸æ“š-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSyncStatus(`å·²åŒ¯å‡º ${mealHistory.length} ç­†è¨˜éŒ„åˆ°æª”æ¡ˆ`, 'success');
                
            } catch (error) {
                console.error('åŒ¯å‡ºæ•¸æ“šå¤±æ•—:', error);
                showSyncStatus('åŒ¯å‡ºå¤±æ•—: ' + error.message, 'error');
            }
        }

        // åŒ¯å…¥æ–‡ä»¶æ•¸æ“š
        function importFromFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                showSyncStatus('è«‹é¸æ“‡ä¸€å€‹ JSON æ–‡ä»¶', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // é©—è­‰æ•¸æ“šæ ¼å¼
                    if (!importedData.data || !Array.isArray(importedData.data)) {
                        throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¢ºï¼šç¼ºå°‘æœ‰æ•ˆçš„æ•¸æ“šé™£åˆ—');
                    }
                    
                    // è©¢å•ç”¨æˆ¶å¦‚ä½•è™•ç†ç¾æœ‰æ•¸æ“š
                    let mergeChoice = 'replace';
                    if (mealHistory.length > 0) {
                        mergeChoice = confirm(
                            `æ‚¨ç•¶å‰æœ‰ ${mealHistory.length} ç­†è¨˜éŒ„ã€‚\n\n` +
                            `é»æ“Šã€Œç¢ºå®šã€ï¼šåˆä½µæ•¸æ“šï¼ˆä¿ç•™å…©é‚Šçš„è¨˜éŒ„ï¼‰\n` +
                            `é»æ“Šã€Œå–æ¶ˆã€ï¼šæ›¿æ›æ•¸æ“šï¼ˆæ¸…é™¤ç¾æœ‰è¨˜éŒ„ï¼‰`
                        ) ? 'merge' : 'replace';
                    }
                    
                    if (mergeChoice === 'merge') {
                        // åˆä½µæ•¸æ“š
                        const mergedData = mergeDataArrays(mealHistory, importedData.data);
                        mealHistory = mergedData;
                        showSyncStatus(`å·²æˆåŠŸåˆä½µ ${importedData.data.length} ç­†æ–°è¨˜éŒ„`, 'success');
                    } else {
                        // æ›¿æ›æ•¸æ“š
                        mealHistory = importedData.data;
                        showSyncStatus(`å·²è¼‰å…¥ ${importedData.data.length} ç­†è¨˜éŒ„`, 'success');
                    }
                    
                    // æ›´æ–°é¡¯ç¤º
                    saveHistoryToStorage();
                    displayHistory();
                    updateChart();
                    
                } catch (error) {
                    console.error('åŒ¯å…¥æ–‡ä»¶å¤±æ•—:', error);
                    showSyncStatus('æ–‡ä»¶åŒ¯å…¥å¤±æ•—: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        // ç”Ÿæˆåˆ†äº«é€£çµ (ä½¿ç”¨ Base64 ç·¨ç¢¼)
        function generateShareLink() {
            try {
                const dataToShare = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: mealHistory
                };
                
                const encodedData = btoa(encodeURIComponent(JSON.stringify(dataToShare)));
                const shareUrl = `${window.location.origin}${window.location.pathname}#data=${encodedData}`;
                
                // è¤‡è£½åˆ°å‰ªè²¼æ¿
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        document.getElementById('shareResult').innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                <h6>âœ… åˆ†äº«é€£çµå·²ç”Ÿæˆä¸¦è¤‡è£½åˆ°å‰ªè²¼æ¿</h6>
                                <p style="word-break: break-all; font-size: 12px;">${shareUrl}</p>
                                <p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>åœ¨å…¶ä»–è¨­å‚™ä¸Šé–‹å•Ÿæ­¤é€£çµï¼Œæ•¸æ“šæœƒè‡ªå‹•è¼‰å…¥ã€‚</p>
                            </div>
                        `;
                    });
                } else {
                    // æ‰‹å‹•è¤‡è£½
                    document.getElementById('shareResult').innerHTML = `
                        <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                            <h6>âœ… åˆ†äº«é€£çµå·²ç”Ÿæˆ</h6>
                            <textarea readonly style="width: 100%; height: 60px; font-size: 12px;">${shareUrl}</textarea>
                            <p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>è¤‡è£½ä¸Šæ–¹é€£çµï¼Œåœ¨å…¶ä»–è¨­å‚™ä¸Šé–‹å•Ÿï¼Œæ•¸æ“šæœƒè‡ªå‹•è¼‰å…¥ã€‚</p>
                        </div>
                    `;
                }
                
                showSyncStatus(`å·²ç”ŸæˆåŒ…å« ${mealHistory.length} ç­†è¨˜éŒ„çš„åˆ†äº«é€£çµ`, 'success');
                
            } catch (error) {
                console.error('ç”Ÿæˆåˆ†äº«é€£çµå¤±æ•—:', error);
                showSyncStatus('åˆ†äº«é€£çµç”Ÿæˆå¤±æ•—: ' + error.message, 'error');
            }
        }

        // æª¢æŸ¥ URL ä¸­çš„åˆ†äº«æ•¸æ“š
        function checkForSharedData() {
            const hash = window.location.hash;
            if (hash.startsWith('#data=')) {
                try {
                    const encodedData = hash.substring(6);
                    const decodedData = JSON.parse(decodeURIComponent(atob(encodedData)));
                    
                    if (decodedData.data && Array.isArray(decodedData.data)) {
                        // è©¢å•ç”¨æˆ¶æ˜¯å¦è¼‰å…¥åˆ†äº«çš„æ•¸æ“š
                        if (confirm(`æª¢æ¸¬åˆ°åˆ†äº«çš„æ•¸æ“šï¼ˆ${decodedData.data.length} ç­†è¨˜éŒ„ï¼‰ã€‚\n\næ˜¯å¦è¼‰å…¥é€™äº›æ•¸æ“šï¼Ÿ\n\né»æ“Šã€Œç¢ºå®šã€è¼‰å…¥ï¼Œã€Œå–æ¶ˆã€å¿½ç•¥ã€‚`)) {
                            mealHistory = decodedData.data;
                            saveHistoryToStorage();
                            displayHistory();
                            updateChart();
                            showSyncStatus(`å·²è¼‰å…¥åˆ†äº«çš„ ${decodedData.data.length} ç­†è¨˜éŒ„`, 'success');
                            
                            // æ¸…é™¤ URL ä¸­çš„æ•¸æ“š
                            window.location.hash = '';
                        }
                    }
                } catch (error) {
                    console.error('è¼‰å…¥åˆ†äº«æ•¸æ“šå¤±æ•—:', error);
                    showSyncStatus('è¼‰å…¥åˆ†äº«æ•¸æ“šå¤±æ•—: ' + error.message, 'error');
                }
            }
        }

        // GitHub åŒæ­¥ç›¸é—œè®Šæ•¸
        let githubToken = '';
        let githubGistId = '';
        let isGitHubSyncEnabled = false;

        // åˆå§‹åŒ– GitHub åŒæ­¥
        function initGitHubSync() {
            console.log('initGitHubSync è¢«èª¿ç”¨');
            
            const tokenInput = document.getElementById('githubToken');
            const resultDiv = document.getElementById('githubSetupResult');
            
            console.log('tokenInput:', tokenInput);
            console.log('resultDiv:', resultDiv);
            
            if (!tokenInput) {
                console.error('æ‰¾ä¸åˆ° githubToken è¼¸å…¥æ¡†');
                alert('æ‰¾ä¸åˆ°ä»¤ç‰Œè¼¸å…¥æ¡†ï¼Œè«‹é‡æ–°æ‰“é–‹è¨­ç½®é é¢');
                return;
            }
            
            if (!resultDiv) {
                console.error('æ‰¾ä¸åˆ° githubSetupResult çµæœå€åŸŸ');
                alert('æ‰¾ä¸åˆ°çµæœé¡¯ç¤ºå€åŸŸï¼Œè«‹é‡æ–°æ‰“é–‹è¨­ç½®é é¢');
                return;
            }
            
            const token = tokenInput.value.trim();
            console.log('è¼¸å…¥çš„ä»¤ç‰Œé•·åº¦:', token.length);
            
            if (!token) {
                resultDiv.innerHTML = '<div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">âŒ è«‹è¼¸å…¥ GitHub å€‹äººè¨ªå•ä»¤ç‰Œ</div>';
                showSyncStatus('è«‹è¼¸å…¥ GitHub å€‹äººè¨ªå•ä»¤ç‰Œ', 'error');
                return;
            }

            // é¡¯ç¤ºæ­£åœ¨é©—è­‰ç‹€æ…‹
            resultDiv.innerHTML = '<div style="background: #d1ecf1; padding: 10px; border-radius: 5px; color: #0c5460;">ğŸ”„ æ­£åœ¨é©—è­‰ GitHub ä»¤ç‰Œ...</div>';

            githubToken = token;
            localStorage.setItem('github_token', token);
            
            // æ¸¬è©¦ä»¤ç‰Œæœ‰æ•ˆæ€§
            testGitHubToken();
        }

        // æ¸¬è©¦ GitHub ä»¤ç‰Œ
        async function testGitHubToken() {
            const resultDiv = document.getElementById('githubSetupResult');
            
            try {
                showSyncStatus('æ­£åœ¨é©—è­‰ GitHub ä»¤ç‰Œ...', 'success');
                
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    
                    // æ›´æ–°è¨­ç½®é é¢çš„çµæœé¡¯ç¤º
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                âœ… GitHub é€£æ¥æˆåŠŸï¼<br>
                                æ­¡è¿ç”¨æˆ¶: <strong>${user.login}</strong><br>
                                <small>æ­£åœ¨è¨­ç½®åŒæ­¥ç•Œé¢...</small>
                            </div>
                        `;
                    }
                    
                    showSyncStatus(`GitHub é€£æ¥æˆåŠŸï¼æ­¡è¿ ${user.login}`, 'success');
                    
                    // çŸ­æš«å»¶é²å¾Œè¨­ç½®ç•Œé¢
                    setTimeout(() => {
                        setupGitHubInterface(user);
                    }, 1000);
                } else {
                    throw new Error(`HTTP ${response.status}: ä»¤ç‰Œç„¡æ•ˆæˆ–æ¬Šé™ä¸è¶³`);
                }
            } catch (error) {
                console.error('GitHub ä»¤ç‰Œé©—è­‰å¤±æ•—:', error);
                
                // æ›´æ–°è¨­ç½®é é¢çš„éŒ¯èª¤é¡¯ç¤º
                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                            âŒ é©—è­‰å¤±æ•—: ${error.message}<br>
                            <small>è«‹æª¢æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¢ºï¼Œä¸”å…·æœ‰ 'gist' æ¬Šé™</small>
                        </div>
                    `;
                }
                
                showSyncStatus('GitHub ä»¤ç‰Œé©—è­‰å¤±æ•—: ' + error.message, 'error');
            }
        }

        // è¨­ç½® GitHub åŒæ­¥ç•Œé¢
        function setupGitHubInterface(user) {
            isGitHubSyncEnabled = true;
            const savedGistId = localStorage.getItem('github_gist_id');
            
            const content = `
                <div style="background: #e8f5e8; border: 1px solid #d4edda; border-radius: 8px; padding: 15px;">
                    <h4>âœ… GitHub åŒæ­¥å·²å•Ÿç”¨</h4>
                    <p>å·²é€£æ¥åˆ° GitHub ç”¨æˆ¶: <strong>${user.login}</strong></p>
                    
                    <div style="background: #d1ecf1; padding: 10px; border-radius: 5px; margin: 10px 0;">
                        <h6>ğŸ“Š åŒæ­¥ç‹€æ…‹</h6>
                        <p>Gist ID: ${savedGistId || 'å°šæœªå‰µå»º'}</p>
                        <p>ç•¶å‰æ•¸æ“š: ${mealHistory.length} ç­†è¨˜éŒ„</p>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <button onclick="saveToGitHub()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">ä¿å­˜åˆ° GitHub</button>
                        <button onclick="loadFromGitHub()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">å¾ GitHub è¼‰å…¥</button>
                        <button onclick="enableGitHubAutoSync()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">å•Ÿç”¨è‡ªå‹•åŒæ­¥</button>
                        <button onclick="disconnectGitHub()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin: 5px;">æ–·é–‹é€£æ¥</button>
                    </div>
                    
                    <div id="githubSyncStatus" style="margin: 10px 0;"></div>
                    
                    <button onclick="showCloudOptions()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">è¿”å›é¸é …</button>
                </div>
            `;
            document.getElementById('cloudOptions').innerHTML = content;
            
            // æª¢æŸ¥æ˜¯å¦å·²æœ‰ Gist
            if (savedGistId) {
                githubGistId = savedGistId;
            }
        }

        // ä¿å­˜æ•¸æ“šåˆ° GitHub Gist
        async function saveToGitHub() {
            if (!githubToken) {
                showSyncStatus('GitHub å°šæœªé€£æ¥', 'error');
                return;
            }

            try {
                // åªåœ¨æœ‰ç•Œé¢å…ƒç´ æ™‚æ›´æ–°ç‹€æ…‹
                const statusElement = document.getElementById('githubSyncStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<p>ğŸ”„ æ­£åœ¨ä¿å­˜åˆ° GitHub...</p>';
                }
                
                const dataToSave = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    data: mealHistory,
                    metadata: {
                        totalMeals: mealHistory.length,
                        dateRange: mealHistory.length > 0 ? {
                            start: mealHistory[mealHistory.length - 1].date,
                            end: mealHistory[0].date
                        } : null
                    }
                };

                const gistData = {
                    description: `è²“å’ªé£²é£Ÿè¿½è¹¤æ•¸æ“š - ${new Date().toLocaleDateString()}`,
                    public: false,
                    files: {
                        'cat-food-data.json': {
                            content: JSON.stringify(dataToSave, null, 2)
                        }
                    }
                };

                let response;
                if (githubGistId) {
                    // æ›´æ–°ç¾æœ‰ Gist
                    response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                } else {
                    // å‰µå»ºæ–° Gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(gistData)
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    githubGistId = result.id;
                    localStorage.setItem('github_gist_id', githubGistId);
                    
                    // åªåœ¨æœ‰ç•Œé¢å…ƒç´ æ™‚æ›´æ–°ç‹€æ…‹
                    const statusElement = document.getElementById('githubSyncStatus');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                âœ… å·²æˆåŠŸä¿å­˜ ${mealHistory.length} ç­†è¨˜éŒ„åˆ° GitHub<br>
                                <small>Gist ID: ${githubGistId}</small>
                            </div>
                        `;
                    }
                    showSyncStatus('æ•¸æ“šå·²æˆåŠŸä¿å­˜åˆ° GitHub Gist', 'success');
                } else {
                    throw new Error(`ä¿å­˜å¤±æ•—: ${response.status}`);
                }

            } catch (error) {
                console.error('ä¿å­˜åˆ° GitHub å¤±æ•—:', error);
                
                // åªåœ¨æœ‰ç•Œé¢å…ƒç´ æ™‚æ›´æ–°ç‹€æ…‹
                const statusElement = document.getElementById('githubSyncStatus');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                            âŒ ä¿å­˜å¤±æ•—: ${error.message}
                        </div>
                    `;
                }
                showSyncStatus('GitHub ä¿å­˜å¤±æ•—: ' + error.message, 'error');
                throw error; // é‡æ–°æ‹‹å‡ºéŒ¯èª¤ä¾›è‡ªå‹•åŒæ­¥æ•ç²
            }
        }

        // å¾ GitHub Gist è¼‰å…¥æ•¸æ“šï¼ˆéœé»˜ç‰ˆæœ¬ï¼Œç”¨æ–¼è‡ªå‹•åˆå§‹åŒ–ï¼‰
        async function loadFromGitHubSilently() {
            if (!githubToken || !githubGistId) {
                throw new Error('GitHub ä»¤ç‰Œæˆ– Gist ID ä¸å­˜åœ¨');
            }

            const response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                headers: {
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const gist = await response.json();
            const fileContent = gist.files['cat-food-data.json'].content;
            const importedData = JSON.parse(fileContent);
            
            if (!importedData.data || !Array.isArray(importedData.data)) {
                throw new Error('GitHub æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
            }

            // ç›´æ¥ä½¿ç”¨ GitHub æ•¸æ“šï¼Œä¸è©¢å•ç”¨æˆ¶
            mealHistory = importedData.data;
            saveHistoryToStorage(); // åŒæ­¥åˆ°æœ¬åœ°å­˜å„²
            
            return mealHistory;
        }

        // å¾ GitHub Gist è¼‰å…¥æ•¸æ“šï¼ˆç”¨æˆ¶æ‰‹å‹•æ“ä½œç‰ˆæœ¬ï¼‰
        async function loadFromGitHub() {
            if (!githubToken || !githubGistId) {
                showSyncStatus('è«‹å…ˆä¿å­˜æ•¸æ“šåˆ° GitHub æˆ–ç¢ºèª Gist ID', 'error');
                return;
            }

            try {
                document.getElementById('githubSyncStatus').innerHTML = '<p>ğŸ”„ æ­£åœ¨å¾ GitHub è¼‰å…¥...</p>';
                
                const response = await fetch(`https://api.github.com/gists/${githubGistId}`, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const gist = await response.json();
                    const fileContent = gist.files['cat-food-data.json'].content;
                    const importedData = JSON.parse(fileContent);
                    
                    if (importedData.data && Array.isArray(importedData.data)) {
                        // ç›´æ¥ä½¿ç”¨ GitHub æ•¸æ“šæ›¿æ›æœ¬åœ°æ•¸æ“š
                        mealHistory = importedData.data;
                        
                        // æ›´æ–°é¡¯ç¤º
                        saveHistoryToStorage();
                        displayHistory();
                        updateChart();
                        
                        document.getElementById('githubSyncStatus').innerHTML = `
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724;">
                                âœ… å·²æˆåŠŸè¼‰å…¥ ${importedData.data.length} ç­†è¨˜éŒ„
                            </div>
                        `;
                        showSyncStatus('æ•¸æ“šå·²æˆåŠŸå¾ GitHub è¼‰å…¥', 'success');
                    } else {
                        throw new Error('GitHub æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                    }
                } else {
                    throw new Error(`è¼‰å…¥å¤±æ•—: ${response.status}`);
                }

            } catch (error) {
                console.error('å¾ GitHub è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('githubSyncStatus').innerHTML = `
                    <div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24;">
                        âŒ è¼‰å…¥å¤±æ•—: ${error.message}
                    </div>
                `;
                showSyncStatus('GitHub è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // æ–·é–‹ GitHub é€£æ¥
        function disconnectGitHub() {
            if (confirm('ç¢ºå®šè¦æ–·é–‹ GitHub é€£æ¥å—ï¼Ÿ')) {
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_gist_id');
                githubToken = '';
                githubGistId = '';
                isGitHubSyncEnabled = false;
                showCloudOptions();
                showSyncStatus('å·²æ–·é–‹ GitHub é€£æ¥', 'success');
            }
        }

        // åˆå§‹åŒ– GitHub ä¸¦è‡ªå‹•è¼‰å…¥æ•¸æ“š
        async function initializeWithGitHub() {
            const savedToken = localStorage.getItem('github_token');
            const savedGistId = localStorage.getItem('github_gist_id');
            
            if (savedToken && savedGistId) {
                githubToken = savedToken;
                githubGistId = savedGistId;
                
                try {
                    console.log('å˜—è©¦å¾ GitHub è‡ªå‹•è¼‰å…¥æ•¸æ“š...');
                    showSyncStatus('æ­£åœ¨å¾ GitHub è¼‰å…¥æœ€æ–°æ•¸æ“š...', 'success');
                    
                    await loadFromGitHubSilently();
                    
                    if (mealHistory.length > 0) {
                        console.log(`æˆåŠŸå¾ GitHub è¼‰å…¥ ${mealHistory.length} ç­†è¨˜éŒ„`);
                        dataSource = 'github';
                        showSyncStatus(`å·²å¾ GitHub è¼‰å…¥ ${mealHistory.length} ç­†è¨˜éŒ„`, 'success');
                        displayHistory();
                        updateDataSourceDisplay();
                        return;
                    }
                } catch (error) {
                    console.warn('å¾ GitHub è¼‰å…¥å¤±æ•—:', error);
                    showSyncStatus('GitHub è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°æ•¸æ“š', 'error');
                }
            } else if (savedToken) {
                githubToken = savedToken;
                console.log('æœ‰ GitHub ä»¤ç‰Œä½†æ²’æœ‰ Gist IDï¼Œç­‰å¾…ç”¨æˆ¶æ‰‹å‹•è¨­ç½®');
            }
        }
        
        // æª¢æŸ¥å·²ä¿å­˜çš„ GitHub è¨­å®šï¼ˆä¿ç•™èˆŠå‡½æ•¸ä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰
        function checkSavedGitHubSettings() {
            const savedToken = localStorage.getItem('github_token');
            if (savedToken) {
                githubToken = savedToken;
                githubGistId = localStorage.getItem('github_gist_id') || '';
            }
        }

        // åœ¨ window å°è±¡ä¸Šæš´éœ²èª¿è©¦å‡½æ•¸ä¾›æ‰‹å‹•èª¿ç”¨
        window.debugGoogleAPI = debugGoogleAPI;
        window.testGoogleAPI = testGoogleAPI;
        window.tryIncognitoMode = tryIncognitoMode;
        window.showFixGuide = showFixGuide;
        window.exportLocalData = exportLocalData;
        window.importFromFile = importFromFile;
        window.generateShareLink = generateShareLink;
        window.showCloudOptions = showCloudOptions;
        window.setupGitHubSync = setupGitHubSync;
        window.showManualSync = showManualSync;
        window.showFileSync = showFileSync;
        window.showPastebinSync = showPastebinSync;
        window.initGitHubSync = initGitHubSync;
        window.saveToGitHub = saveToGitHub;
        window.loadFromGitHub = loadFromGitHub;
        window.disconnectGitHub = disconnectGitHub;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>